<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬Šé™ CSV ç”Ÿæˆå·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
        }
        .step-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .step-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .preview-table {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .preview-table table {
            font-size: 0.85em;
        }
        .output-textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            min-height: 300px;
        }
        .btn-action {
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .permission-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px;
        }
        .badge-read { background: #d4edda; color: #155724; }
        .badge-write { background: #fff3cd; color: #856404; }
        .mapping-table {
            font-size: 0.9em;
        }
        .mapping-table td {
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="main-card">
        <!-- æ¨™é¡Œ -->
        <div class="header text-center">
            <h1><i class="bi bi-shield-lock-fill"></i> æ¬Šé™ CSV ç”Ÿæˆå·¥å…·</h1>
            <p class="mb-0">å¿«é€Ÿå°‡ Excel æ¬Šé™è¡¨è½‰æ›ç‚ºç³»çµ±å¯åŒ¯å…¥çš„ CSV æ ¼å¼</p>
        </div>

        <div class="p-4">
            <!-- æ­¥é©Ÿ 1: è²¼ä¸Šè³‡æ–™ -->
            <div class="step-card">
                <div class="d-flex align-items-center mb-3">
                    <span class="step-number me-3">1</span>
                    <h4 class="mb-0">å¾ Excel è²¼ä¸Šæ¬Šé™è³‡æ–™</h4>
                </div>
                
                <div class="info-box">
                    <i class="bi bi-info-circle-fill text-primary"></i>
                    <strong>æ“ä½œèªªæ˜ï¼š</strong>
                    <ol class="mb-0 mt-2">
                        <li>åœ¨ Excel ä¸­é¸å–æ•´å€‹æ¬Šé™è¡¨ï¼ˆåŒ…å«æ¨™é¡Œåˆ—ï¼‰</li>
                        <li>æŒ‰ <kbd>Ctrl+C</kbd> è¤‡è£½</li>
                        <li>åœ¨ä¸‹æ–¹æ–‡å­—æ¡†æŒ‰ <kbd>Ctrl+V</kbd> è²¼ä¸Š</li>
                        <li><span class="badge bg-success">NEW</span> æ”¯æ´éšå±¤çµæ§‹ï¼ä½¿ç”¨ç¸®æ’è¡¨ç¤ºå±¤ç´šé—œä¿‚</li>
                    </ol>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-lightbulb-fill"></i>
                    <strong>æ”¯æ´å…©ç¨®æ ¼å¼ï¼š</strong>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>æ ¼å¼ 1ï¼šç¸±å‘ï¼ˆè³‡æ–™å¤¾åœ¨å·¦ï¼‰</strong>
                            <pre class="mb-0 mt-1 bg-light p-2 rounded" style="font-size: 0.8em;">è³‡æ–™å¤¾    äººå“¡1  äººå“¡2
OOLAR01   RW     RO
  å­è³‡æ–™å¤¾  RW     RW</pre>
                        </div>
                        <div class="col-md-6">
                            <strong>æ ¼å¼ 2ï¼šæ©«å‘ï¼ˆè³‡æ–™å¤¾åœ¨ä¸Šï¼‰â­</strong>
                            <pre class="mb-0 mt-1 bg-light p-2 rounded" style="font-size: 0.8em;">å±¤ç´š1   share    share    share
å±¤ç´š2   è²¡å‹™éƒ¨    ITéƒ¨     HR
å±¤ç´š3   æœƒè¨ˆ      ç³»çµ±      
äººå“¡1   RW       RO       RW
äººå“¡2   RO       RW       RO</pre>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="showFormatHelp()">
                            <i class="bi bi-question-circle"></i> æ ¼å¼è©³ç´°èªªæ˜
                        </button>
                    </div>
                </div>

                <textarea id="excel-input" class="form-control" rows="8" 
                          placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå¾ Excel è¤‡è£½çš„æ¬Šé™è¡¨è³‡æ–™...

ç¯„ä¾‹æ ¼å¼ï¼š
ç¬¬ä¸€æ¬„	è™•ç†é•·	æ‡‰ç”¨	çµ„åˆ¥	éƒ¨é–€	å…¬å¸ä¸»ç®¡	å‰¯ç¸½ç´š	...
OOLAR01	RW	RW	RW	RW	RW	RW	...
OOLAR02	RW	RW	RW	RW	RW	RW	..."></textarea>

                <div class="mt-3">
                    <div class="btn-group me-2" role="group">
                        <input type="radio" class="btn-check" name="format-type" id="format-vertical" value="vertical" checked>
                        <label class="btn btn-outline-primary" for="format-vertical">
                            <i class="bi bi-list-ul"></i> ç¸±å‘æ ¼å¼
                        </label>
                        
                        <input type="radio" class="btn-check" name="format-type" id="format-horizontal" value="horizontal">
                        <label class="btn btn-outline-primary" for="format-horizontal">
                            <i class="bi bi-table"></i> æ©«å‘æ ¼å¼ï¼ˆçŸ©é™£ï¼‰
                        </label>
                    </div>
                    
                    <button class="btn btn-primary btn-action" onclick="parseExcelData()">
                        <i class="bi bi-arrow-right-circle"></i> è§£æè³‡æ–™
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="clearAll()">
                        <i class="bi bi-x-circle"></i> æ¸…ç©º
                    </button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ 2: è¨­å®šå°æ‡‰ -->
            <div class="step-card" id="mapping-section" style="display:none;">
                <div class="d-flex align-items-center mb-3">
                    <span class="step-number me-3">2</span>
                    <h4 class="mb-0">è¨­å®šæ¬„ä½å°æ‡‰</h4>
                </div>

                <!-- éšå±¤çµæ§‹é è¦½ -->
                <div id="hierarchy-preview-box" style="display:none;" class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <i class="bi bi-diagram-3-fill"></i>
                            <strong>éšå±¤çµæ§‹é è¦½</strong>
                            <span class="badge bg-success ms-2" id="level-count">0</span> å€‹å±¤ç´š
                        </div>
                        <button class="btn btn-sm btn-outline-success" onclick="toggleHierarchyPreview()">
                            <i class="bi bi-eye"></i> <span id="preview-toggle-text">å±•é–‹</span>
                        </button>
                    </div>
                    <div id="hierarchy-preview-content" style="display:none;">
                        <pre id="hierarchy-tree" class="mb-0 mt-2 bg-white p-3 rounded" style="font-size: 0.9em; max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>é‡è¦ï¼š</strong>è«‹ç¢ºèªå“ªäº›æ¬„ä½ä»£è¡¨<strong>è³‡æ–™å¤¾</strong>ï¼Œå“ªäº›æ¬„ä½ä»£è¡¨<strong>äººå“¡æˆ–ç¾¤çµ„</strong>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-folder-fill"></i> è³‡æ–™å¤¾æ¬„ä½
                            </div>
                            <div class="card-body">
                                <label class="form-label">é¸æ“‡è³‡æ–™å¤¾åç¨±æ‰€åœ¨æ¬„ä½ï¼š</label>
                                <select id="folder-column" class="form-select">
                                    <option value="">è«‹é¸æ“‡...</option>
                                </select>
                                <small class="text-muted">é€šå¸¸æ˜¯ç¬¬ä¸€æ¬„ï¼ˆå¦‚ï¼šOOLAR01, OOLAR02...ï¼‰</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-people-fill"></i> æ¬Šé™æ¬„ä½ç¯„åœ
                            </div>
                            <div class="card-body">
                                <label class="form-label">æ¬Šé™è³‡æ–™é–‹å§‹æ¬„ä½ï¼š</label>
                                <select id="permission-start-column" class="form-select mb-2">
                                    <option value="">è«‹é¸æ“‡...</option>
                                </select>
                                <label class="form-label">æ¬Šé™è³‡æ–™çµæŸæ¬„ä½ï¼š</label>
                                <select id="permission-end-column" class="form-select">
                                    <option value="">è«‹é¸æ“‡...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success btn-action" onclick="generateMapping()">
                        <i class="bi bi-gear-fill"></i> ç”Ÿæˆå°æ‡‰è¡¨
                    </button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ 3: äººå“¡/ç¾¤çµ„å°æ‡‰ -->
            <div class="step-card" id="user-group-mapping" style="display:none;">
                <div class="d-flex align-items-center mb-3">
                    <span class="step-number me-3">3</span>
                    <h4 class="mb-0">è¨­å®šäººå“¡ ID å°æ‡‰</h4>
                    <button class="btn btn-sm btn-outline-primary ms-auto" onclick="loadSystemData()">
                        <i class="bi bi-arrow-clockwise"></i> é‡æ–°è¼‰å…¥ç³»çµ±è³‡æ–™
                    </button>
                </div>

                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>åŠŸèƒ½èªªæ˜ï¼š</strong>
                    <ul class="mb-0 mt-2">
                        <li>ç”¢ç”Ÿçš„ CSV ç”¨æ–¼<strong>ã€Œå°‡äººå“¡åŠ å…¥ç¾¤çµ„ã€</strong></li>
                        <li>Excel ç¬¬ä¸€æ¬„ = äººå“¡å¸³è™Ÿï¼Œæœƒè‡ªå‹•å°æ‡‰åˆ°ç³»çµ±äººå“¡</li>
                        <li>æ¯å€‹è³‡æ–™å¤¾çš„ RO/RW â†’ è‡ªå‹•å°æ‡‰è©²è³‡æ–™å¤¾çš„ç¾¤çµ„ï¼ˆä¾‹å¦‚ï¼šè²¡å‹™éƒ¨_ROï¼‰</li>
                        <li>ç”¢ç”Ÿçš„ CSV åŒ…å« <code>user_id</code> å’Œ <code>group_id</code></li>
                    </ul>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-magic text-primary"></i>
                    <strong>æ­é…ç¾¤çµ„è‡ªå‹•æ¬Šé™ï¼š</strong>
                    <ul class="mb-0 mt-2">
                        <li>ç¾¤çµ„åŒ¯å…¥æ™‚æœƒè‡ªå‹•æŒ‡æ´¾æ¬Šé™ï¼ˆä¾‹å¦‚ï¼šè²¡å‹™éƒ¨_RO â†’ è²¡å‹™éƒ¨è³‡æ–™å¤¾ read æ¬Šé™ï¼‰</li>
                        <li>åŒ¯å…¥æ­¤æ¬Šé™ CSV å¾Œï¼Œäººå“¡æœƒè‡ªå‹•åŠ å…¥å°æ‡‰çš„ç¾¤çµ„</li>
                        <li>äººå“¡é€éç¾¤çµ„ç²å¾—è³‡æ–™å¤¾æ¬Šé™ï¼Œç„¡éœ€æ‰‹å‹•è¨­å®š</li>
                    </ul>
                </div>

                <div id="system-data-status" class="alert alert-success" style="display:none;">
                    <i class="bi bi-check-circle-fill"></i>
                    å·²è¼‰å…¥ç³»çµ±è³‡æ–™ï¼š
                    <span class="badge bg-success" id="user-count">0</span> ä½äººå“¡ï¼Œ
                    <span class="badge bg-success" id="group-count">0</span> å€‹ç¾¤çµ„
                </div>

                <div class="table-responsive preview-table">
                    <table class="table table-bordered table-sm mapping-table" id="mapping-table">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Excel æ¬„ä½åç¨±</th>
                                <th width="20%">é¡å‹</th>
                                <th width="50%">å°æ‡‰ ID</th>
                            </tr>
                        </thead>
                        <tbody id="mapping-body">
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success btn-action" onclick="generatePermissions()">
                        <i class="bi bi-magic"></i> ç”Ÿæˆæ¬Šé™ CSV
                    </button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ 4: é è¦½å’Œä¸‹è¼‰ -->
            <div class="step-card" id="output-section" style="display:none;">
                <div class="d-flex align-items-center mb-3">
                    <span class="step-number me-3">4</span>
                    <h4 class="mb-0">é è¦½å’Œä¸‹è¼‰</h4>
                </div>

                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>ç”ŸæˆæˆåŠŸï¼</strong>å…±ç”¢ç”Ÿ <span id="permission-count" class="badge bg-success">0</span> ç­†æ¬Šé™è¨˜éŒ„
                </div>

                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="stat-folders">0</h3>
                                <small class="text-muted">è³‡æ–™å¤¾æ•¸</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="stat-read">0</h3>
                                <small class="text-muted">è®€å–æ¬Šé™</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="stat-write">0</h3>
                                <small class="text-muted">å¯«å…¥æ¬Šé™</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="stat-write">0</h3>
                                <small class="text-muted">å¯«å…¥æ¬Šé™</small>
                            </div>
                        </div>
                    </div>
                </div>

                <label class="form-label"><strong>CSV è¼¸å‡ºå…§å®¹ï¼š</strong></label>
                <textarea id="csv-output" class="form-control output-textarea" readonly></textarea>

                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary btn-action" onclick="downloadCSV()">
                        <i class="bi bi-download"></i> ä¸‹è¼‰ CSV æª”æ¡ˆ
                    </button>
                    <button class="btn btn-danger btn-action" onclick="directImport()">
                        <i class="bi bi-cloud-upload-fill"></i> ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
                    </button>
                    <button class="btn btn-success btn-action" onclick="copyToClipboard()">
                        <i class="bi bi-clipboard"></i> è¤‡è£½åˆ°å‰ªè²¼ç°¿
                    </button>
                    <button class="btn btn-info btn-action" onclick="showPreviewTable()">
                        <i class="bi bi-table"></i> è¡¨æ ¼é è¦½
                    </button>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle-fill"></i> 
                    <strong>ç›´æ¥åŒ¯å…¥èªªæ˜ï¼š</strong>
                    ã€Œç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±ã€æŒ‰éˆ•æœƒå°‡ç”Ÿæˆçš„ CSV å…§å®¹ç›´æ¥å‚³é€åˆ°ä¸»ç³»çµ±é€²è¡ŒåŒ¯å…¥ï¼Œç„¡éœ€ä¸‹è¼‰å’Œæ‰‹å‹•ä¸Šå‚³ã€‚
                </div>
            </div>

            <!-- é è¦½è¡¨æ ¼æ¨¡æ…‹æ¡† -->
            <div class="modal fade" id="preview-modal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-table"></i> æ¬Šé™è³‡æ–™é è¦½</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive" style="max-height: 600px; overflow: auto;">
                                <table class="table table-bordered table-hover table-sm" id="preview-table-content">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ ¼å¼èªªæ˜æ¨¡æ…‹æ¡† -->
            <div class="modal fade" id="format-help-modal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="bi bi-question-circle"></i> æ ¼å¼è©³ç´°èªªæ˜</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="text-primary"><i class="bi bi-list-ul"></i> æ ¼å¼ 1ï¼šç¸±å‘ï¼ˆè³‡æ–™å¤¾åœ¨å·¦ï¼‰</h5>
                                    <p>é©ç”¨æ–¼è³‡æ–™å¤¾è¼ƒå¤šã€äººå“¡è¼ƒå°‘çš„æƒ…æ³</p>
                                    <div class="card mb-3">
                                        <div class="card-header">ç¯„ä¾‹ï¼š</div>
                                        <div class="card-body">
                                            <pre class="mb-0 bg-light p-3 rounded" style="font-size: 0.85em;">è³‡æ–™å¤¾åç¨±    äººå“¡1    äººå“¡2    ç¾¤çµ„1    ç¾¤çµ„2
OOLAR01       RW       RO       RW       RO
OOLAR02       RW                RO       RW
  å­è³‡æ–™å¤¾     RW       RW       RW       RO</pre>
                                        </div>
                                    </div>
                                    <ul class="list-group">
                                        <li class="list-group-item">âœ“ ç¬¬ 1 æ¬„ï¼šè³‡æ–™å¤¾åç¨±</li>
                                        <li class="list-group-item">âœ“ ç¬¬ 2 æ¬„èµ·ï¼šå„äººå“¡/ç¾¤çµ„</li>
                                        <li class="list-group-item">âœ“ æ”¯æ´ç¸®æ’è¡¨ç¤ºéšå±¤</li>
                                        <li class="list-group-item">âœ“ é©åˆï¼šè³‡æ–™å¤¾å¤šã€æ¬Šé™å°è±¡å°‘</li>
                                    </ul>
                                </div>
                                
                                <div class="col-md-6">
                                    <h5 class="text-success"><i class="bi bi-table"></i> æ ¼å¼ 2ï¼šæ©«å‘ï¼ˆè³‡æ–™å¤¾åœ¨ä¸Šï¼‰â­</h5>
                                    <p>é©ç”¨æ–¼è³‡æ–™å¤¾è¼ƒå°‘ã€äººå“¡è¼ƒå¤šçš„æƒ…æ³</p>
                                    <div class="card mb-3">
                                        <div class="card-header">ç¯„ä¾‹ï¼š</div>
                                        <div class="card-body">
                                            <pre class="mb-0 bg-light p-3 rounded" style="font-size: 0.85em;">ç¬¬ä¸€å±¤       share    share    share    share
ç¬¬äºŒå±¤       è²¡å‹™éƒ¨    ITéƒ¨     HR       Admin
ç¬¬ä¸‰å±¤       æœƒè¨ˆ      ç³»çµ±              
å¼µä¸‰         RW       RO       RW       RW
æå››         RO       RW                RW
ç‹äº”         RW       RW       RO       </pre>
                                        </div>
                                    </div>
                                    <ul class="list-group">
                                        <li class="list-group-item">âœ“ å‰ 3 è¡Œï¼šè³‡æ–™å¤¾éšå±¤</li>
                                        <li class="list-group-item">âœ“ ç¬¬ 4 è¡Œèµ·ï¼šä½¿ç”¨è€…å¸³è™Ÿ</li>
                                        <li class="list-group-item">âœ“ è‡ªå‹•å»ºç«‹éšå±¤é—œä¿‚</li>
                                        <li class="list-group-item">âœ“ é©åˆï¼šäººå“¡å¤šã€è³‡æ–™å¤¾å°‘</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="text-info"><i class="bi bi-lightbulb"></i> å¦‚ä½•é¸æ“‡æ ¼å¼ï¼Ÿ</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="20%">æƒ…æ³</th>
                                            <th width="40%">ç¸±å‘æ ¼å¼</th>
                                            <th width="40%">æ©«å‘æ ¼å¼ï¼ˆçŸ©é™£ï¼‰</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>è³‡æ–™å¤¾æ•¸é‡</strong></td>
                                            <td class="table-success">âœ“ å¾ˆå¤šï¼ˆ100+ï¼‰</td>
                                            <td class="table-warning">é©åˆè¼ƒå°‘ï¼ˆ20-50ï¼‰</td>
                                        </tr>
                                        <tr>
                                            <td><strong>äººå“¡æ•¸é‡</strong></td>
                                            <td class="table-warning">é©åˆè¼ƒå°‘ï¼ˆ5-20ï¼‰</td>
                                            <td class="table-success">âœ“ å¾ˆå¤šï¼ˆ50+ï¼‰</td>
                                        </tr>
                                        <tr>
                                            <td><strong>éšå±¤é—œä¿‚</strong></td>
                                            <td>ç¸®æ’è¡¨ç¤º</td>
                                            <td>3 è¡Œåˆ†å±¤è¡¨ç¤º</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Excel æ ¼å¼</strong></td>
                                            <td>ä¸€èˆ¬åˆ—è¡¨</td>
                                            <td>çŸ©é™£è¡¨æ ¼</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let parsedData = [];
        let headers = [];
        let mappingData = [];
        let generatedPermissions = [];
        let folderHierarchy = []; // å„²å­˜è³‡æ–™å¤¾éšå±¤é—œä¿‚
        let systemUsers = []; // ç³»çµ±ä¸­çš„äººå“¡æ¸…å–®
        let systemGroups = []; // ç³»çµ±ä¸­çš„ç¾¤çµ„æ¸…å–®
        let apiBaseUrl = window.location.origin; // API åŸºç¤ URL

        // é é¢è¼‰å…¥æ™‚å¾ç³»çµ±è¼‰å…¥äººå“¡å’Œç¾¤çµ„æ¸…å–®
        async function loadSystemData() {
            try {
                // è¼‰å…¥äººå“¡
                const usersResponse = await fetch(`${apiBaseUrl}/api/users`);
                if (usersResponse.ok) {
                    systemUsers = await usersResponse.json();
                    console.log('å·²è¼‰å…¥ç³»çµ±äººå“¡:', systemUsers);
                }
                
                // è¼‰å…¥ç¾¤çµ„
                const groupsResponse = await fetch(`${apiBaseUrl}/api/groups`);
                if (groupsResponse.ok) {
                    systemGroups = await groupsResponse.json();
                    console.log('å·²è¼‰å…¥ç³»çµ±ç¾¤çµ„:', systemGroups);
                }
                
                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                const statusDiv = document.getElementById('system-data-status');
                const userCountSpan = document.getElementById('user-count');
                const groupCountSpan = document.getElementById('group-count');
                
                if (userCountSpan) userCountSpan.textContent = systemUsers.length;
                if (groupCountSpan) groupCountSpan.textContent = systemGroups.length;
                
                if (systemUsers.length > 0 || systemGroups.length > 0) {
                    if (statusDiv) statusDiv.style.display = 'block';
                } else {
                    console.warn('ç³»çµ±ä¸­æ²’æœ‰äººå“¡æˆ–ç¾¤çµ„è³‡æ–™');
                }
                
                // å¦‚æœå·²ç¶“æœ‰ mappingDataï¼Œé‡æ–°ç”Ÿæˆé¸æ“‡å™¨
                if (mappingData.length > 0) {
                    regenerateMappingSelectors();
                }
            } catch (error) {
                console.error('è¼‰å…¥ç³»çµ±è³‡æ–™å¤±æ•—:', error);
                // å³ä½¿è¼‰å…¥å¤±æ•—ï¼Œä»å…è¨±æ‰‹å‹•è¼¸å…¥ ID
            }
        }

        // é‡æ–°ç”Ÿæˆæ‰€æœ‰ ID é¸æ“‡å™¨
        function regenerateMappingSelectors() {
            mappingData.forEach((item, idx) => {
                const selectorDiv = document.getElementById(`id-selector-${idx}`);
                if (selectorDiv) {
                    const permissionSuffix = item.permissionSuffix || '';
                    if (permissionSuffix) {
                        selectorDiv.innerHTML = generateIdSelectorWithSuffix(idx, item.type, permissionSuffix);
                    } else {
                        selectorDiv.innerHTML = generateIdSelector(idx, item.type);
                    }
                }
            });
        }

        // è§£æ Excel è³‡æ–™
        function parseExcelData() {
            const input = document.getElementById('excel-input').value.trim();
            if (!input) {
                alert('è«‹å…ˆè²¼ä¸Š Excel è³‡æ–™ï¼');
                return;
            }

            // æª¢æŸ¥é¸æ“‡çš„æ ¼å¼
            const formatType = document.querySelector('input[name="format-type"]:checked').value;
            
            if (formatType === 'horizontal') {
                parseHorizontalFormat(input);
            } else {
                parseVerticalFormat(input);
            }
        }

        // è§£ææ©«å‘æ ¼å¼ï¼ˆè³‡æ–™å¤¾åœ¨ä¸Šï¼Œä½¿ç”¨è€…åœ¨å·¦ï¼‰
        function parseHorizontalFormat(input) {
            const lines = input.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('æ©«å‘æ ¼å¼è‡³å°‘éœ€è¦ 1 è¡Œè³‡æ–™å¤¾éšå±¤ + 1 è¡Œä½¿ç”¨è€…è³‡æ–™ï¼');
                return;
            }

            // åˆ¤æ–·åˆ†éš”ç¬¦
            const delimiter = lines[0].includes('\t') ? '\t' : /\s{2,}/;
            
            // è‡ªå‹•åµæ¸¬éšå±¤æ•¸é‡
            // æª¢æŸ¥å‰å¹¾è¡Œçš„ç¬¬ä¸€æ¬„æ˜¯å¦åŒ…å«ã€Œå±¤ç´šã€ã€ã€Œéšå±¤ã€ã€ã€Œlevelã€ç­‰é—œéµå­—
            let hierarchyLineCount = 0;
            const hierarchyKeywords = ['å±¤ç´š', 'éšå±¤', 'level', 'tier', 'ç¬¬', 'L'];
            
            for (let i = 0; i < lines.length; i++) {
                const firstCol = lines[i].split(delimiter)[0].trim();
                const isHierarchyLine = hierarchyKeywords.some(keyword => 
                    firstCol.toLowerCase().includes(keyword.toLowerCase())
                );
                
                if (isHierarchyLine) {
                    hierarchyLineCount++;
                } else {
                    // é‡åˆ°ç¬¬ä¸€å€‹ééšå±¤è¡Œå°±åœæ­¢
                    break;
                }
            }
            
            // å¦‚æœæ²’æœ‰åµæ¸¬åˆ°éšå±¤é—œéµå­—ï¼Œé è¨­å‰3è¡Œç‚ºéšå±¤ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            if (hierarchyLineCount === 0) {
                hierarchyLineCount = Math.min(3, lines.length - 1);
                console.log('æœªåµæ¸¬åˆ°éšå±¤é—œéµå­—ï¼Œé è¨­ä½¿ç”¨å‰', hierarchyLineCount, 'è¡Œä½œç‚ºéšå±¤');
            }
            
            console.log('åµæ¸¬åˆ°', hierarchyLineCount, 'å€‹éšå±¤');
            
            if (lines.length <= hierarchyLineCount) {
                alert(`è³‡æ–™ä¸è¶³ï¼éœ€è¦è‡³å°‘ ${hierarchyLineCount} è¡Œéšå±¤ + 1 è¡Œä½¿ç”¨è€…è³‡æ–™`);
                return;
            }
            
            // å‹•æ…‹è§£ææ‰€æœ‰éšå±¤
            const levels = [];
            for (let i = 0; i < hierarchyLineCount; i++) {
                const levelData = lines[i].split(delimiter).map(v => v.trim());
                levels.push(levelData);
                console.log(`å±¤ç´š ${i + 1}:`, levelData);
            }
            
            // å»ºç«‹è³‡æ–™å¤¾çµæ§‹ï¼ˆå¾ç¬¬ 2 æ¬„é–‹å§‹ï¼Œç¬¬ 1 æ¬„é€šå¸¸æ˜¯æ¨™ç±¤ï¼‰
            const folderColumns = [];
            folderHierarchy = [];
            
            // æ‰¾å‡ºæœ€å¤§æ¬„ä½æ•¸
            const maxCols = Math.max(...levels.map(level => level.length));
            
            for (let colIdx = 1; colIdx < maxCols; colIdx++) {
                // æ”¶é›†é€™ä¸€æ¬„æ‰€æœ‰éšå±¤çš„å€¼
                const parts = [];
                const levelValues = {};
                
                for (let levelIdx = 0; levelIdx < levels.length; levelIdx++) {
                    const value = levels[levelIdx][colIdx] || '';
                    levelValues[`level${levelIdx + 1}`] = value;
                    if (value) {
                        parts.push(value);
                    }
                }
                
                if (parts.length === 0) continue;
                
                const folderPath = parts.join('/');
                const folderInfo = {
                    index: colIdx,
                    path: folderPath,
                    name: parts[parts.length - 1], // æœ€å¾Œä¸€å€‹éç©ºå€¼
                    ...levelValues // å‹•æ…‹æ·»åŠ  level1, level2, level3, level4...
                };
                
                folderColumns.push(folderInfo);
            }
            
            console.log('è³‡æ–™å¤¾æ¬„ä½:', folderColumns);
            
            // è§£æä½¿ç”¨è€…å’Œæ¬Šé™ï¼ˆå¾éšå±¤è¡Œä¹‹å¾Œé–‹å§‹ï¼‰
            const userPermissions = [];
            for (let lineIdx = hierarchyLineCount; lineIdx < lines.length; lineIdx++) {
                const values = lines[lineIdx].split(delimiter).map(v => v.trim());
                const userName = values[0];
                
                if (!userName) continue;
                
                // è§£æè©²ä½¿ç”¨è€…å°æ¯å€‹è³‡æ–™å¤¾çš„æ¬Šé™
                const permissions = [];
                for (let colIdx = 1; colIdx < values.length && colIdx < folderColumns.length + 1; colIdx++) {
                    const permValue = values[colIdx];
                    if (permValue && permValue.match(/^(RW|RO|R|W)$/i)) {
                        permissions.push({
                            folder: folderColumns[colIdx - 1],
                            permission: permValue
                        });
                    }
                }
                
                userPermissions.push({
                    user: userName,
                    permissions: permissions
                });
            }
            
            console.log('ä½¿ç”¨è€…æ¬Šé™:', userPermissions);
            
            // è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
            convertHorizontalToStandard(folderColumns, userPermissions);
            
            alert(`âœ… è§£ææˆåŠŸï¼ˆæ©«å‘æ ¼å¼ï¼‰ï¼\nåµæ¸¬åˆ° ${hierarchyLineCount} å€‹éšå±¤\nè³‡æ–™å¤¾ï¼š${folderColumns.length} å€‹\nä½¿ç”¨è€…ï¼š${userPermissions.length} ä½`);
        }

        // è½‰æ›æ©«å‘æ ¼å¼ç‚ºæ¨™æº–æ ¼å¼
        function convertHorizontalToStandard(folderColumns, userPermissions) {
            // å»ºç«‹è³‡æ–™å¤¾éšå±¤
            folderHierarchy = [];
            const folderMap = new Map();
            let folderId = 0;
            
            // å…ˆå»ºç«‹æ‰€æœ‰å”¯ä¸€çš„è³‡æ–™å¤¾
            const allFolders = new Set();
            folderColumns.forEach(col => {
                if (col.level1) allFolders.add(col.level1);
                if (col.level2) allFolders.add(`${col.level1}/${col.level2}`);
                if (col.level3) allFolders.add(`${col.level1}/${col.level2}/${col.level3}`);
            });
            
            // æŒ‰è·¯å¾‘æ’åºä¸¦å»ºç«‹éšå±¤
            const sortedFolders = Array.from(allFolders).sort();
            sortedFolders.forEach(path => {
                const parts = path.split('/');
                const name = parts[parts.length - 1];
                const level = parts.length - 1;
                const parent = parts.length > 1 ? parts.slice(0, -1).join('/') : null;
                
                folderHierarchy.push({
                    name: name,
                    level: level,
                    parent: parent ? folderMap.get(parent) : null,
                    path: path,
                    index: folderId++
                });
                
                folderMap.set(path, name);
            });
            
            console.log('å»ºç«‹çš„è³‡æ–™å¤¾éšå±¤:', folderHierarchy);
            
            // é¡¯ç¤ºéšå±¤çµæ§‹
            showHierarchyPreview();
            
            // æ©«å‘æ ¼å¼ç›´æ¥è·³åˆ°ä½¿ç”¨è€… ID å°æ‡‰
            showHorizontalUserMapping(userPermissions, folderColumns);
        }

        // é¡¯ç¤ºæ©«å‘æ ¼å¼çš„ä½¿ç”¨è€… ID å°æ‡‰
        function showHorizontalUserMapping(userPermissions, folderColumns) {
            // éš±è—æ¬„ä½é¸æ“‡å€æ®µï¼ˆæ©«å‘æ ¼å¼ä¸éœ€è¦ï¼‰
            document.getElementById('mapping-section').style.display = 'none';
            
            // å»ºç«‹ä½¿ç”¨è€…å°æ‡‰è³‡æ–™ï¼ˆç¬¬ä¸€æ¬„æ˜¯äººå“¡å¸³è™Ÿï¼‰
            mappingData = userPermissions.map((up, idx) => {
                return {
                    index: idx,
                    name: up.user,
                    type: 'user', // ç¬¬ä¸€æ¬„éƒ½æ˜¯äººå“¡
                    id: '',
                    permissions: up.permissions
                };
            });
            
            // é¡¯ç¤ºä½¿ç”¨è€…å°æ‡‰è¡¨
            const tbody = document.getElementById('mapping-body');
            tbody.innerHTML = '';
            
            mappingData.forEach((item, idx) => {
                const permCount = item.permissions.length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${idx + 1}</td>
                    <td><strong>${item.name}</strong> <span class="badge bg-info">${permCount} ç­†æ¬Šé™</span></td>
                    <td>
                        <span class="badge bg-primary">äººå“¡ (User)</span>
                    </td>
                    <td>
                        <div id="id-selector-${idx}">
                            ${generateIdSelector(idx, 'user')}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('user-group-mapping').style.display = 'block';
            document.getElementById('user-group-mapping').scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ†ææ˜¯å¦ç‚ºç¾¤çµ„ä»¥åŠæ¬Šé™é¡å‹
        function analyzeIfGroup(userName, permissions) {
            // æª¢æŸ¥åç¨±æ˜¯å¦åŒ…å«ç¾¤çµ„é—œéµå­—
            const groupKeywords = ['éƒ¨', 'group', 'team', 'çµ„', 'ç§‘', 'è™•', 'ä¸­å¿ƒ', 'å–®ä½'];
            const hasGroupKeyword = groupKeywords.some(kw => userName.includes(kw));
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å« @ ç¬¦è™Ÿï¼ˆemail æ ¼å¼é€šå¸¸æ˜¯äººå“¡ï¼‰
            const hasEmail = userName.includes('@');
            
            // åˆ†ææ‰€æœ‰æ¬Šé™ï¼Œçµ±è¨ˆ RO å’Œ RW çš„æ•¸é‡
            let roCount = 0;
            let rwCount = 0;
            let mixedCount = 0;
            
            permissions.forEach(perm => {
                const type = perm.permission_type;
                if (type === 'read') {
                    roCount++;
                } else if (type === 'write') {
                    rwCount++;
                }
            });
            
            // åˆ¤æ–·ä¸»è¦æ¬Šé™é¡å‹
            let suffix = '';
            if (roCount > 0 && rwCount === 0) {
                suffix = 'RO'; // å…¨éƒ¨éƒ½æ˜¯å”¯è®€
            } else if (rwCount > 0 && roCount === 0) {
                suffix = 'RW'; // å…¨éƒ¨éƒ½æ˜¯è®€å¯«
            } else if (roCount > 0 && rwCount > 0) {
                // æ··åˆæ¬Šé™ï¼Œé¸æ“‡æ•¸é‡è¼ƒå¤šçš„
                suffix = rwCount >= roCount ? 'RW' : 'RO';
            }
            
            // ç¶œåˆåˆ¤æ–·æ˜¯å¦ç‚ºç¾¤çµ„
            const isGroup = (hasGroupKeyword || suffix !== '') && !hasEmail;
            
            return {
                isGroup: isGroup,
                suffix: suffix
            };
        }

        // è§£æç¸±å‘æ ¼å¼ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        function parseVerticalFormat(input) {
            // åˆ†è¡Œè™•ç†
            const lines = input.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œè‡³å°‘éœ€è¦æ¨™é¡Œåˆ—å’Œä¸€è¡Œè³‡æ–™ï¼');
                return;
            }

            // è§£ææ¨™é¡Œ
            const firstLine = lines[0];
            // åˆ¤æ–·åˆ†éš”ç¬¦ï¼ˆTab æˆ–å¤šå€‹ç©ºç™½ï¼‰
            const delimiter = firstLine.includes('\t') ? '\t' : /\s{2,}/;
            headers = firstLine.split(delimiter).map(h => h.trim()).filter(h => h);

            // è§£æè³‡æ–™è¡Œä¸¦è­˜åˆ¥éšå±¤
            parsedData = [];
            folderHierarchy = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                // æª¢æ¸¬ç¸®æ’ç´šåˆ¥
                const leadingSpaces = line.match(/^[\s\t]*/)[0];
                const indentLevel = detectIndentLevel(leadingSpaces);
                
                // è§£ææ¬„ä½å€¼
                const values = line.split(delimiter).map(v => v.trim());
                
                if (values.length > 0 && values[0]) {
                    // å„²å­˜åŸå§‹è³‡æ–™å¤¾åç¨±ï¼ˆä¸å«ç¸®æ’ï¼‰
                    const folderName = values[0].trim();
                    
                    // è¨ˆç®—çˆ¶è³‡æ–™å¤¾
                    const parentFolder = findParentFolder(indentLevel);
                    
                    // å„²å­˜éšå±¤è³‡è¨Š
                    folderHierarchy.push({
                        name: folderName,
                        level: indentLevel,
                        parent: parentFolder,
                        index: parsedData.length
                    });
                    
                    // å°‡è™•ç†å¾Œçš„è³‡æ–™åŠ å…¥ï¼ˆè³‡æ–™å¤¾åç¨±å·²å»é™¤ç¸®æ’ï¼‰
                    values[0] = folderName;
                    parsedData.push(values);
                }
            }

            console.log('è§£æçš„æ¨™é¡Œ:', headers);
            console.log('è§£æçš„è³‡æ–™:', parsedData);
            console.log('éšå±¤é—œä¿‚:', folderHierarchy);

            if (headers.length === 0 || parsedData.length === 0) {
                alert('è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼');
                return;
            }

            // é¡¯ç¤ºéšå±¤çµæ§‹é è¦½
            showHierarchyPreview();

            // é¡¯ç¤ºå°æ‡‰è¨­å®šå€æ®µ
            populateColumnSelects();
            document.getElementById('mapping-section').style.display = 'block';
            
            const hierarchyInfo = folderHierarchy.length > 0 ? 
                `\néšå±¤çµæ§‹ï¼šå·²è­˜åˆ¥ ${countLevels()} å€‹å±¤ç´š` : '';
            
            alert(`âœ… è§£ææˆåŠŸï¼\næ¨™é¡Œæ¬„ä½ï¼š${headers.length} å€‹\nè³‡æ–™åˆ—ï¼š${parsedData.length} ç­†${hierarchyInfo}`);
        }

        // æª¢æ¸¬ç¸®æ’ç´šåˆ¥
        function detectIndentLevel(leadingSpaces) {
            if (!leadingSpaces) return 0;
            
            // è¨ˆç®— Tab æ•¸é‡ï¼ˆ1 Tab = 1 ç´šï¼‰
            const tabCount = (leadingSpaces.match(/\t/g) || []).length;
            if (tabCount > 0) return tabCount;
            
            // è¨ˆç®—ç©ºç™½æ•¸é‡ï¼ˆé€šå¸¸ 2 æˆ– 4 å€‹ç©ºç™½ = 1 ç´šï¼‰
            const spaceCount = leadingSpaces.length;
            
            // æ™ºæ…§åˆ¤æ–·ç¸®æ’å–®ä½ï¼ˆ2 æˆ– 4 å€‹ç©ºç™½ï¼‰
            if (spaceCount >= 4) {
                return Math.floor(spaceCount / 4);
            } else if (spaceCount >= 2) {
                return Math.floor(spaceCount / 2);
            }
            
            return spaceCount > 0 ? 1 : 0;
        }

        // æ‰¾åˆ°çˆ¶è³‡æ–™å¤¾
        function findParentFolder(currentLevel) {
            if (currentLevel === 0) return null;
            
            // å¾å¾Œå¾€å‰æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€å€‹æ¯”ç•¶å‰å±¤ç´šå°çš„è³‡æ–™å¤¾
            for (let i = folderHierarchy.length - 1; i >= 0; i--) {
                if (folderHierarchy[i].level === currentLevel - 1) {
                    return folderHierarchy[i].name;
                }
            }
            
            return null;
        }

        // è¨ˆç®—ç¸½å…±æœ‰å¹¾å€‹å±¤ç´š
        function countLevels() {
            if (folderHierarchy.length === 0) return 0;
            return Math.max(...folderHierarchy.map(f => f.level)) + 1;
        }

        // é¡¯ç¤ºéšå±¤çµæ§‹é è¦½
        function showHierarchyPreview() {
            if (folderHierarchy.length === 0) return;
            
            const previewHtml = folderHierarchy.map(folder => {
                const indent = 'ã€€'.repeat(folder.level * 2); // å…¨å½¢ç©ºç™½
                const icon = folder.level === 0 ? 'ğŸ“' : (folder.level === 1 ? 'ğŸ“‚' : 'ğŸ“„');
                const parentInfo = folder.parent ? ` <span class="text-muted">(çˆ¶: ${folder.parent})</span>` : ' <span class="text-success">(æ ¹)</span>';
                return `${indent}${icon} <strong>${folder.name}</strong>${parentInfo}`;
            }).join('\n');
            
            console.log('éšå±¤çµæ§‹é è¦½:\n' + previewHtml);
            
            // æ›´æ–° UI
            const levels = countLevels();
            if (levels > 0) {
                document.getElementById('hierarchy-preview-box').style.display = 'block';
                document.getElementById('level-count').textContent = levels;
                document.getElementById('hierarchy-tree').innerHTML = previewHtml;
            }
        }

        // åˆ‡æ›éšå±¤é è¦½é¡¯ç¤º
        function toggleHierarchyPreview() {
            const content = document.getElementById('hierarchy-preview-content');
            const toggleText = document.getElementById('preview-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'æ”¶åˆ';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'å±•é–‹';
            }
        }

        // å¡«å……æ¬„ä½é¸æ“‡ä¸‹æ‹‰é¸å–®
        function populateColumnSelects() {
            const folderSelect = document.getElementById('folder-column');
            const startSelect = document.getElementById('permission-start-column');
            const endSelect = document.getElementById('permission-end-column');

            folderSelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            startSelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            endSelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';

            headers.forEach((header, index) => {
                folderSelect.innerHTML += `<option value="${index}">${index + 1}. ${header}</option>`;
                startSelect.innerHTML += `<option value="${index}">${index + 1}. ${header}</option>`;
                endSelect.innerHTML += `<option value="${index}">${index + 1}. ${header}</option>`;
            });

            // é è¨­å€¼
            folderSelect.value = '0'; // ç¬¬ä¸€æ¬„é€šå¸¸æ˜¯è³‡æ–™å¤¾åç¨±
            if (headers.length > 1) {
                startSelect.value = '1'; // æ¬Šé™å¾ç¬¬äºŒæ¬„é–‹å§‹
                endSelect.value = String(headers.length - 1); // åˆ°æœ€å¾Œä¸€æ¬„
            }
        }

        // ç”Ÿæˆå°æ‡‰è¡¨
        function generateMapping() {
            const folderCol = parseInt(document.getElementById('folder-column').value);
            const startCol = parseInt(document.getElementById('permission-start-column').value);
            const endCol = parseInt(document.getElementById('permission-end-column').value);

            if (isNaN(folderCol) || isNaN(startCol) || isNaN(endCol)) {
                alert('è«‹å®Œæˆæ‰€æœ‰æ¬„ä½é¸æ“‡ï¼');
                return;
            }

            if (startCol > endCol) {
                alert('é–‹å§‹æ¬„ä½ä¸èƒ½å¤§æ–¼çµæŸæ¬„ä½ï¼');
                return;
            }

            // å»ºç«‹å°æ‡‰è¡¨
            mappingData = [];
            for (let i = startCol; i <= endCol; i++) {
                mappingData.push({
                    index: i,
                    name: headers[i],
                    type: 'user', // é è¨­ç‚ºäººå“¡
                    id: ''
                });
            }

            // é¡¯ç¤ºå°æ‡‰è¡¨
            const tbody = document.getElementById('mapping-body');
            tbody.innerHTML = '';
            
            mappingData.forEach((item, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${idx + 1}</td>
                    <td><strong>${item.name}</strong></td>
                    <td>
                        <select class="form-select form-select-sm" id="type-select-${idx}" onchange="updateMappingType(${idx}, this.value)">
                            <option value="user">äººå“¡ (User)</option>
                            <option value="group">ç¾¤çµ„ (Group)</option>
                        </select>
                    </td>
                    <td>
                        <div id="id-selector-${idx}">
                            ${generateIdSelector(idx, 'user')}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('user-group-mapping').style.display = 'block';
        }

        // ç”Ÿæˆ ID é¸æ“‡å™¨ï¼ˆå¸¶æ¬Šé™å¾Œç¶´çš„æ™ºæ…§åŒ¹é…ï¼‰
        function generateIdSelectorWithSuffix(index, type, permissionSuffix) {
            const dataList = type === 'user' ? systemUsers : systemGroups;
            const excelName = mappingData[index].name;
            
            if (dataList.length === 0) {
                // å¦‚æœæ²’æœ‰ç³»çµ±è³‡æ–™ï¼Œä½¿ç”¨æ‰‹å‹•è¼¸å…¥
                return `
                    <input type="text" class="form-control form-control-sm" 
                           id="id-input-${index}"
                           placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: 1, 2, 3...)" 
                           onchange="updateMappingId(${index}, this.value)">
                    <small class="text-muted">ç³»çµ±ä¸­ç„¡${type === 'user' ? 'äººå“¡' : 'ç¾¤çµ„'}è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ ID</small>
                `;
            }
            
            // æ™ºæ…§åŒ¹é…ï¼ˆå„ªå…ˆä½¿ç”¨æ¬Šé™å¾Œç¶´ï¼‰
            let matchedItem = null;
            
            if (type === 'group' && permissionSuffix) {
                // 1. å˜—è©¦åŒ¹é…ï¼šåç¨± + _RO æˆ– _RW
                const targetName = `${excelName}_${permissionSuffix}`;
                matchedItem = dataList.find(item => item.name === targetName);
                
                // 2. å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç§»é™¤ Excel åç¨±ä¸­å¯èƒ½å·²å­˜åœ¨çš„å¾Œç¶´å†åŠ ä¸Šæ–°å¾Œç¶´
                if (!matchedItem) {
                    const baseName = excelName.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                    const targetName2 = `${baseName}_${permissionSuffix}`;
                    matchedItem = dataList.find(item => item.name === targetName2);
                }
                
                // 3. å˜—è©¦éƒ¨åˆ†åŒ¹é… + å¾Œç¶´
                if (!matchedItem) {
                    matchedItem = dataList.find(item => {
                        const itemBaseName = item.name.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                        return item.name.endsWith(`_${permissionSuffix}`) && 
                               (itemBaseName === excelName || 
                                itemBaseName.includes(excelName) || 
                                excelName.includes(itemBaseName));
                    });
                }
            } else if (type === 'user') {
                // äººå“¡åŒ¹é…é‚è¼¯ï¼ˆå®Œå…¨åŒ¹é… > Email åŒ¹é… > åŒ…å«åŒ¹é…ï¼‰
                matchedItem = dataList.find(item => item.name === excelName);
                if (!matchedItem) {
                    matchedItem = dataList.find(item => item.email === excelName);
                }
                if (!matchedItem) {
                    matchedItem = dataList.find(item => 
                        (item.name && excelName.includes(item.name)) ||
                        (excelName && item.name.includes(excelName))
                    );
                }
            } else {
                // ç¾¤çµ„ä½†æ²’æœ‰æ¬Šé™å¾Œç¶´ï¼Œä½¿ç”¨ä¸€èˆ¬åŒ¹é…
                matchedItem = dataList.find(item => item.name === excelName);
                if (!matchedItem) {
                    const baseName = excelName.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                    matchedItem = dataList.find(item => {
                        const itemBaseName = item.name.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                        return itemBaseName === baseName;
                    });
                }
                if (!matchedItem) {
                    matchedItem = dataList.find(item => 
                        (item.name && excelName.includes(item.name)) ||
                        (excelName && item.name.includes(excelName))
                    );
                }
            }
            
            let optionsHtml = '<option value="">è«‹é¸æ“‡...</option>';
            dataList.forEach(item => {
                const selected = matchedItem && item.id === matchedItem.id ? 'selected' : '';
                const displayName = type === 'user' 
                    ? `${item.name} (${item.email})` 
                    : item.name;
                optionsHtml += `<option value="${item.id}" ${selected}>${item.id}. ${displayName}</option>`;
            });
            
            // å¦‚æœæ‰¾åˆ°åŒ¹é…ï¼Œè‡ªå‹•è¨­å®š ID
            if (matchedItem) {
                mappingData[index].id = matchedItem.id;
                mappingData[index].matchedName = matchedItem.name;
            }
            
            const matchInfo = matchedItem 
                ? `<small class="text-success"><i class="bi bi-check-circle"></i> è‡ªå‹•åŒ¹é…ï¼š${matchedItem.name}</small>` 
                : (permissionSuffix 
                    ? `<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> æœªæ‰¾åˆ° "${excelName}_${permissionSuffix}"ï¼Œè«‹æ‰‹å‹•é¸æ“‡</small>`
                    : '<small class="text-muted">è«‹æ‰‹å‹•é¸æ“‡</small>');
            
            return `
                <select class="form-select form-select-sm" id="id-select-${index}" onchange="updateMappingIdFromSelect(${index}, this.value)">
                    ${optionsHtml}
                </select>
                ${matchInfo}
            `;
        }

        // ç”Ÿæˆ ID é¸æ“‡å™¨ï¼ˆä¸‹æ‹‰é¸å–®æˆ–æ‰‹å‹•è¼¸å…¥ï¼‰- èˆŠç‰ˆæœ¬ï¼Œä¿ç•™å‘å¾Œç›¸å®¹
        function generateIdSelector(index, type) {
            const dataList = type === 'user' ? systemUsers : systemGroups;
            const excelName = mappingData[index].name;
            
            if (dataList.length === 0) {
                // å¦‚æœæ²’æœ‰ç³»çµ±è³‡æ–™ï¼Œä½¿ç”¨æ‰‹å‹•è¼¸å…¥
                return `
                    <input type="text" class="form-control form-control-sm" 
                           id="id-input-${index}"
                           placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: 1, 2, 3...)" 
                           onchange="updateMappingId(${index}, this.value)">
                    <small class="text-muted">ç³»çµ±ä¸­ç„¡${type === 'user' ? 'äººå“¡' : 'ç¾¤çµ„'}è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ ID</small>
                `;
            }
            
            // å˜—è©¦æ™ºæ…§åŒ¹é…ï¼ˆå¢å¼·ç‰ˆ - æ”¯æ´ _RO/_RW å¾Œç¶´ï¼‰
            let matchedItem = null;
            
            // å®Œå…¨åŒ¹é…
            matchedItem = dataList.find(item => item.name === excelName);
            
            // Email åŒ¹é…ï¼ˆåƒ…äººå“¡ï¼‰
            if (!matchedItem && type === 'user') {
                matchedItem = dataList.find(item => item.email === excelName);
            }
            
            // ç¾¤çµ„åç¨± + æ¬Šé™å¾Œç¶´åŒ¹é… (ä¾‹å¦‚: "è²¡å‹™éƒ¨" åŒ¹é… "è²¡å‹™éƒ¨_RO" æˆ– "è²¡å‹™éƒ¨_RW")
            if (!matchedItem && type === 'group') {
                // ç§»é™¤å¯èƒ½çš„ _RO æˆ– _RW å¾Œç¶´
                const baseNameFromExcel = excelName.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                matchedItem = dataList.find(item => {
                    const baseNameFromSystem = item.name.replace(/_(RO|RW|READ|WRITE|ADMIN)$/i, '');
                    return baseNameFromSystem === baseNameFromExcel;
                });
            }
            
            // åŒ…å«åŒ¹é…
            if (!matchedItem) {
                matchedItem = dataList.find(item => 
                    (item.name && excelName.includes(item.name)) ||
                    (excelName && item.name.includes(excelName))
                );
            }
            
            let optionsHtml = '<option value="">è«‹é¸æ“‡...</option>';
            dataList.forEach(item => {
                const selected = matchedItem && item.id === matchedItem.id ? 'selected' : '';
                const displayName = type === 'user' 
                    ? `${item.name} (${item.email})` 
                    : item.name;
                optionsHtml += `<option value="${item.id}" ${selected}>${item.id}. ${displayName}</option>`;
            });
            
            // å¦‚æœæ‰¾åˆ°åŒ¹é…ï¼Œè‡ªå‹•è¨­å®š ID
            if (matchedItem) {
                mappingData[index].id = matchedItem.id;
                mappingData[index].matchedName = matchedItem.name;
            }
            
            return `
                <select class="form-select form-select-sm" id="id-select-${index}" onchange="updateMappingIdFromSelect(${index}, this.value)">
                    ${optionsHtml}
                </select>
                ${matchedItem ? `<small class="text-success"><i class="bi bi-check-circle"></i> è‡ªå‹•åŒ¹é…ï¼š${matchedItem.name}</small>` : '<small class="text-muted">æˆ–æ‰‹å‹•é¸æ“‡</small>'}
            `;
        }

        // æ›´æ–°å°æ‡‰é¡å‹
        function updateMappingType(index, type) {
            mappingData[index].type = type;
            
            // é‡æ–°ç”Ÿæˆ ID é¸æ“‡å™¨ï¼ˆä½¿ç”¨æ¬Šé™å¾Œç¶´ç‰ˆæœ¬ï¼‰
            const selectorDiv = document.getElementById(`id-selector-${index}`);
            if (selectorDiv) {
                const permissionSuffix = mappingData[index].permissionSuffix || '';
                if (permissionSuffix) {
                    selectorDiv.innerHTML = generateIdSelectorWithSuffix(index, type, permissionSuffix);
                } else {
                    selectorDiv.innerHTML = generateIdSelector(index, type);
                }
            }
        }

        // å¾ä¸‹æ‹‰é¸å–®æ›´æ–°å°æ‡‰ ID
        function updateMappingIdFromSelect(index, id) {
            mappingData[index].id = id;
            
            // æ›´æ–°åŒ¹é…çš„åç¨±
            const type = mappingData[index].type;
            const dataList = type === 'user' ? systemUsers : systemGroups;
            const matchedItem = dataList.find(item => item.id == id);
            if (matchedItem) {
                mappingData[index].matchedName = matchedItem.name;
            }
        }

        // æ›´æ–°å°æ‡‰ IDï¼ˆæ‰‹å‹•è¼¸å…¥æ™‚ä½¿ç”¨ï¼‰
        function updateMappingId(index, id) {
            mappingData[index].id = id;
        }

        // ç”Ÿæˆæ¬Šé™è³‡æ–™
        function generatePermissions() {
            // é©—è­‰æ‰€æœ‰å°æ‡‰éƒ½æœ‰å¡«å¯« ID
            const missingIds = mappingData.filter(item => !item.id);
            if (missingIds.length > 0) {
                if (!confirm(`æœ‰ ${missingIds.length} å€‹æ¬„ä½å°šæœªè¨­å®š IDï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿï¼ˆé€™äº›æ¬„ä½å°‡è¢«å¿½ç•¥ï¼‰`)) {
                    return;
                }
            }

            generatedPermissions = [];
            let stats = { folders: new Set(), read: 0, write: 0 };

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ©«å‘æ ¼å¼ï¼ˆmappingData åŒ…å« permissions å±¬æ€§ï¼‰
            const isHorizontalFormat = mappingData.length > 0 && mappingData[0].permissions;

            if (isHorizontalFormat) {
                // æ©«å‘æ ¼å¼æ–°é‚è¼¯ï¼š
                // - ç”¢ç”Ÿã€Œäººå“¡åŠ å…¥ç¾¤çµ„ã€çš„è¨˜éŒ„
                // - æ ¹æ“š Excel ä¸­çš„ RO/RW æ‰¾åˆ°å°æ‡‰çš„ç¾¤çµ„ï¼ˆè³‡æ–™å¤¾å_RO æˆ– _RWï¼‰
                // - æ¯å€‹äººå“¡å°æ¯å€‹ç¾¤çµ„ç”¢ç”Ÿä¸€ç­†è¨˜éŒ„
                
                mappingData.forEach(userMapping => {
                    if (!userMapping.id) return; // äººå“¡ ID æœªè¨­å®š
                    
                    const userId = userMapping.id;
                    const userName = userMapping.matchedName || userMapping.name;

                    userMapping.permissions.forEach(perm => {
                        const folderName = perm.folder.name;
                        const permValue = (perm.permission || '').toUpperCase();
                        
                        stats.folders.add(folderName);

                        // æ ¹æ“š RO/RW æ±ºå®šç¾¤çµ„å¾Œç¶´
                        let groupSuffix = '';
                        let permType = '';
                        
                        if (permValue === 'RO' || permValue === 'R' || permValue === 'READ') {
                            groupSuffix = '_RO';
                            permType = 'read';
                            stats.read++;
                        } else if (permValue === 'RW' || permValue === 'W' || permValue === 'WRITE') {
                            groupSuffix = '_RW';
                            permType = 'write';
                            stats.write++;
                        } else {
                            console.warn(`æœªçŸ¥æ¬Šé™å€¼: ${permValue} (è³‡æ–™å¤¾: ${folderName}, äººå“¡: ${userName})`);
                            return;
                        }
                        
                        // æœå°‹å°æ‡‰çš„ç¾¤çµ„ï¼šè³‡æ–™å¤¾åç¨±_RO æˆ– _RW
                        const targetGroupName = `${folderName}${groupSuffix}`;
                        const matchedGroup = systemGroups.find(g => g.name === targetGroupName);
                        
                        if (!matchedGroup) {
                            console.warn(`âš ï¸ æ‰¾ä¸åˆ°ç¾¤çµ„: ${targetGroupName}ï¼ˆè³‡æ–™å¤¾: ${folderName}, äººå“¡: ${userName}ï¼‰`);
                            return;
                        }
                        
                        // ç”Ÿæˆè¨˜éŒ„ï¼šäººå“¡ + ç¾¤çµ„ï¼ˆç”¨æ–¼åŠ å…¥ç¾¤çµ„ï¼‰
                        generatedPermissions.push({
                            type: 'permission',
                            folder_name: folderName,
                            user_id: userId,
                            group_id: matchedGroup.id,
                            permission_type: permType,
                            reference: `${userName} (äººå“¡ ${userId}) â†’ ${matchedGroup.name} (ç¾¤çµ„ ${matchedGroup.id})`
                        });
                    });
                });
            } else {
                // ç¸±å‘æ ¼å¼ï¼šåŸæœ‰é‚è¼¯
                const folderCol = parseInt(document.getElementById('folder-column').value);

                parsedData.forEach(row => {
                    const folderName = row[folderCol];
                    if (!folderName) return;

                    stats.folders.add(folderName);

                    // éæ­·æ¯å€‹æ¬Šé™æ¬„ä½
                    mappingData.forEach(mapping => {
                        const permValue = row[mapping.index];
                        if (!permValue || !mapping.id) return;

                        // è§£ææ¬Šé™é¡å‹
                        const permType = parsePermissionType(permValue);
                        if (!permType) return;

                        // çµ±è¨ˆ
                        if (permType === 'read') stats.read++;
                        else if (permType === 'write') stats.write++;

                        // ç”Ÿæˆæ¬Šé™è¨˜éŒ„
                        const permission = {
                            type: 'permission',
                            folder_name: folderName,
                            user_id: mapping.type === 'user' ? mapping.id : '',
                            group_id: mapping.type === 'group' ? mapping.id : '',
                            permission_type: permType,
                            reference: `${mapping.name} (${mapping.type === 'user' ? 'äººå“¡' : 'ç¾¤çµ„'} ${mapping.id})`
                        };
                        generatedPermissions.push(permission);
                    });
                });
            }

            if (generatedPermissions.length === 0) {
                alert('æ²’æœ‰ç”¢ç”Ÿä»»ä½•æ¬Šé™è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥è³‡æ–™ï¼');
                return;
            }

            // ç”Ÿæˆ CSV
            const csvContent = generateCSVContent();
            document.getElementById('csv-output').value = csvContent;
            document.getElementById('permission-count').textContent = generatedPermissions.length;
            document.getElementById('stat-folders').textContent = stats.folders.size;
            document.getElementById('stat-read').textContent = stats.read;
            document.getElementById('stat-write').textContent = stats.write;

            document.getElementById('output-section').style.display = 'block';
            document.getElementById('output-section').scrollIntoView({ behavior: 'smooth' });
        }

        // è§£ææ¬Šé™é¡å‹
        function parsePermissionType(value) {
            const v = value.toUpperCase().trim();
            if (v === 'RW' || v === 'R/W' || v === 'W' || v === 'WRITE') return 'write';
            if (v === 'RO' || v === 'R' || v === 'READ') return 'read';
            return null;
        }

        // ç”Ÿæˆ CSV å…§å®¹ï¼ˆåªç”¢ç”Ÿã€Œäººå“¡åŠ å…¥ç¾¤çµ„ã€è¨˜éŒ„ï¼‰
        function generateCSVContent() {
            const BOM = '\uFEFF';
            
            // åªè¼¸å‡º type, user_id, group_idï¼ˆç”¨æ–¼å°‡äººå“¡åŠ å…¥ç¾¤çµ„ï¼‰
            let csv = BOM + 'type,user_id,group_id,reference\n';
            
            generatedPermissions.forEach(perm => {
                // åªè¼¸å‡ºæœ‰ user_id å’Œ group_id çš„è¨˜éŒ„
                if (perm.user_id && perm.group_id) {
                    csv += `${perm.type},${perm.user_id},${perm.group_id},"${perm.reference}"\n`;
                }
            });
            
            return csv;
        }

        // é‡æ–°ç”Ÿæˆ CSV
        function regenerateCSV() {
            const csvContent = generateCSVContent();
            document.getElementById('csv-output').value = csvContent;
            
            const includeFolders = document.getElementById('include-folders').checked;
            if (includeFolders) {
                alert('âœ… å·²é‡æ–°ç”Ÿæˆ CSVï¼ˆåŒ…å«è³‡æ–™å¤¾çµæ§‹ï¼‰ï¼');
            } else {
                alert('âœ… å·²é‡æ–°ç”Ÿæˆ CSVï¼ˆåƒ…æ¬Šé™ï¼‰ï¼');
            }
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            const content = document.getElementById('csv-output').value;
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            link.setAttribute('href', url);
            link.setAttribute('download', `permissions_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('âœ… CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
        }

        // ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
        function directImport() {
            const content = document.getElementById('csv-output').value;
            
            if (!content || content.trim() === '') {
                alert('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„ CSV å…§å®¹ï¼');
                return;
            }
            
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmMsg = `ç¢ºå®šè¦å°‡ç”Ÿæˆçš„ CSV å…§å®¹ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±å—ï¼Ÿ\n\n` +
                `é€™å°‡æœƒæ–°å¢ ${generatedPermissions.length} ç­†ç¾¤çµ„æˆå“¡é—œä¿‚ã€‚\n\n` +
                `æ“ä½œèªªæ˜ï¼š\n` +
                `1. æ­¤æ“ä½œæœƒå°‡äººå“¡åŠ å…¥å°æ‡‰çš„ç¾¤çµ„\n` +
                `2. ä¸æœƒé‡è¤‡æ–°å¢å·²å­˜åœ¨çš„æˆå“¡é—œä¿‚\n` +
                `3. å»ºè­°å…ˆç¢ºèªè³‡æ–™æ­£ç¢ºæ€§\n\n` +
                `æ˜¯å¦ç¹¼çºŒï¼Ÿ`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // æº–å‚™ FormData
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const formData = new FormData();
            formData.append('file', blob, 'permissions.csv');
            
            // é¡¯ç¤ºè™•ç†ä¸­è¨Šæ¯
            const processingMsg = 'â³ æ­£åœ¨åŒ¯å…¥ä¸­ï¼Œè«‹ç¨å€™...';
            alert(processingMsg);
            
            // ç™¼é€åˆ°å¾Œç«¯
            fetch('/import_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('åŒ¯å…¥æˆåŠŸ:', data);
                
                const successMsg = `âœ… åŒ¯å…¥æˆåŠŸï¼\n\n` +
                    `å·²åŒ¯å…¥ï¼š${data.count || 0} ç­†è³‡æ–™\n\n` +
                    `ğŸ’¡ æç¤ºï¼š\n` +
                    `â€¢ å‰å¾€ã€Œç¾¤çµ„ç®¡ç†ã€â†’ã€Œç·¨è¼¯äººå“¡ã€æŸ¥çœ‹ç¾¤çµ„æˆå“¡\n` +
                    `â€¢ æˆ–å‰å¾€ã€ŒæŸ¥è©¢ã€é é¢æŸ¥çœ‹äººå“¡æ‰€å±¬ç¾¤çµ„`;
                
                alert(successMsg);
                
                // è©¢å•æ˜¯å¦è¦åˆ‡æ›åˆ°ä¸»ç³»çµ±
                if (confirm('æ˜¯å¦è¦é–‹å•Ÿä¸»ç³»çµ±æŸ¥çœ‹çµæœï¼Ÿ')) {
                    window.open('/index.html', '_blank');
                }
            })
            .catch(error => {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                
                const errorMsg = `âŒ åŒ¯å…¥å¤±æ•—ï¼\n\n` +
                    `éŒ¯èª¤è¨Šæ¯ï¼š${error.message}\n\n` +
                    `å¯èƒ½åŸå› ï¼š\n` +
                    `1. ä¸»ç³»çµ±æœªå•Ÿå‹•\n` +
                    `2. ç¶²è·¯é€£ç·šå•é¡Œ\n` +
                    `3. CSV æ ¼å¼éŒ¯èª¤\n\n` +
                    `å»ºè­°ï¼š\n` +
                    `â€¢ æª¢æŸ¥ä¸»ç³»çµ±æ˜¯å¦æ­£å¸¸é‹ä½œ\n` +
                    `â€¢ æˆ–ä½¿ç”¨ã€Œä¸‹è¼‰ CSV æª”æ¡ˆã€å¾Œæ‰‹å‹•åŒ¯å…¥`;
                
                alert(errorMsg);
            });
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard() {
            const textarea = document.getElementById('csv-output');
            textarea.select();
            document.execCommand('copy');
            alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }

        // é¡¯ç¤ºè¡¨æ ¼é è¦½
        function showPreviewTable() {
            const table = document.getElementById('preview-table-content');
            table.innerHTML = `
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>#</th>
                        <th>è³‡æ–™å¤¾åç¨±</th>
                        <th>äººå“¡ ID</th>
                        <th>ç¾¤çµ„ ID</th>
                        <th>æ¬Šé™é¡å‹</th>
                        <th>åƒè€ƒè³‡è¨Š</th>
                    </tr>
                </thead>
                <tbody>
                    ${generatedPermissions.map((perm, idx) => `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><strong>${perm.folder_name}</strong></td>
                            <td>${perm.user_id || '-'}</td>
                            <td>${perm.group_id || '-'}</td>
                            <td><span class="permission-badge badge-${perm.permission_type}">${perm.permission_type}</span></td>
                            <td><small>${perm.reference}</small></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('preview-modal'));
            modal.show();
        }

        // é¡¯ç¤ºæ ¼å¼èªªæ˜
        function showFormatHelp() {
            const modal = new bootstrap.Modal(document.getElementById('format-help-modal'));
            modal.show();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                document.getElementById('excel-input').value = '';
                document.getElementById('csv-output').value = '';
                document.getElementById('mapping-section').style.display = 'none';
                document.getElementById('user-group-mapping').style.display = 'none';
                document.getElementById('output-section').style.display = 'none';
                document.getElementById('hierarchy-preview-box').style.display = 'none';
                parsedData = [];
                headers = [];
                mappingData = [];
                generatedPermissions = [];
                folderHierarchy = [];
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ç³»çµ±è³‡æ–™
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¼‰å…¥ç³»çµ±è³‡æ–™...');
            loadSystemData();
        });
    </script>
</body>
</html>


