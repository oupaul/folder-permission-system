<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料夾權限管理系統</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons - 使用穩定版本和 unpkg 作為備用 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" onerror="this.onerror=null;this.href='https://unpkg.com/bootstrap-icons@1.10.0/font/bootstrap-icons.css'">
    <!-- Preload Bootstrap Icons Font -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/fonts/bootstrap-icons.woff2" as="font" type="font/woff2" crossorigin>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* 防止未認證內容閃爍 - 頁面載入時先隱藏內容 */
        body {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        body.authenticated {
            visibility: visible;
            opacity: 1;
        }
        
        .tree ul { 
            list-style: none; 
            padding-left: 20px; 
        }
        .tree li { 
            margin: 5px 0; 
        }
        .folder-item {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .folder-item:hover {
            background-color: #f0f0f0;
        }

        /* 進度條步驟樣式 */
        .step-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .step-item i {
            margin-right: 8px;
            font-size: 0.8em;
        }

        .step-item.processing {
            color: #0d6efd !important;
            font-weight: 500;
        }

        .step-item.completed {
            color: #198754 !important;
        }

        .step-item.completed i:before {
            content: "\f26c"; /* bi-check-circle */
        }

        .step-item.error {
            color: #dc3545 !important;
        }

        .step-item.error i:before {
            content: "\f33a"; /* bi-exclamation-triangle */
        }
        .folder-icon {
            display: inline-block;
            color: #0d6efd;
            font-size: 1.1em;
        }
        .member-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">📁 資料夾權限管理系統</a>
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="#" data-section="databases"><i class="bi bi-database-fill"></i> 資料庫管理</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="folders"><i class="bi bi-folder-fill"></i> 資料夾</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="users"><i class="bi bi-person-fill"></i> 人員</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="groups"><i class="bi bi-people-fill"></i> 群組</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="permissions"><i class="bi bi-key-fill"></i> 權限</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-section="query"><i class="bi bi-search"></i> 查詢</a></li>
                <li class="nav-item" id="admin-menu-item" style="display: none;">
                    <a class="nav-link text-danger" href="#" data-section="account-management">
                        <i class="bi bi-shield-fill-check"></i> 帳號管理
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="csvDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-file-earmark-spreadsheet"></i> 匯出/匯入工具
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="csvDropdown">
                        <li><h6 class="dropdown-header">📥 匯出功能</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="exportExcel(); return false;">
                            <i class="bi bi-file-earmark-excel text-success"></i> 匯出完整報表 (Excel)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportCSV(); return false;">
                            <i class="bi bi-filetype-csv"></i> 匯出權限 CSV
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">📤 匯入功能</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="showImport(); return false;">
                            <i class="bi bi-upload"></i> 批次匯入 (全功能)
                        </a></li>
                    </ul>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link text-danger" href="#" onclick="showClearAllModal(); return false;"><i class="bi bi-trash-fill"></i> 清空所有資料</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="user-display-name">使用者</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><h6 class="dropdown-header" id="user-info">載入中...</h6></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="showChangePasswordModal(); return false;">
                            <i class="bi bi-key-fill"></i> 修改密碼
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                            <i class="bi bi-box-arrow-right"></i> 登出
                        </a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 資料庫管理區段 -->
        <div id="databases-section" style="display:none;">
            <h3><i class="bi bi-database-fill"></i> 資料庫管理</h3>
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill"></i> 
                <strong>您的專屬資料庫:</strong> <span id="current-db-name" class="badge bg-primary fs-6">載入中...</span>
            </div>
            <div class="alert alert-success">
                <i class="bi bi-shield-check-fill"></i> 
                <strong>多租戶架構說明：</strong>
                <ul class="mb-0 mt-2">
                    <li>✅ 每個使用者擁有獨立的資料庫，資料完全隔離</li>
                    <li>✅ 您可以創建多個資料庫，並在它們之間自由切換</li>
                    <li>✅ 切換基於您的 session，不會影響其他使用者</li>
                    <li>✅ 適合用於：多個專案、備份資料庫、測試環境等</li>
                    <li id="admin-db-notice" style="display: none;">🔑 <strong>管理員特權：</strong>可查看、切換並管理所有資料庫</li>
                </ul>
            </div>
            
            <div class="mb-3">
                <button id="btn-create-database" class="btn btn-success me-2" onclick="showCreateDatabaseModal()" style="display: none;">
                    <i class="bi bi-plus-circle"></i> 新增資料庫
                </button>
                <button class="btn btn-primary me-2" onclick="refreshDatabaseList()">
                    <i class="bi bi-arrow-clockwise"></i> 重新整理
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list-ul"></i> 資料庫列表</h5>
                </div>
                <div class="card-body">
                    <div id="database-list-loading" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                    <table id="database-table" class="table table-hover" style="display:none;">
                        <thead>
                            <tr>
                                <th width="5%"></th>
                                <th width="30%">資料庫名稱</th>
                                <th width="15%">檔案大小</th>
                                <th width="20%">最後修改時間</th>
                                <th width="30%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="database-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="folders-section">
            <h3><i class="bi bi-folder-fill"></i> 資料夾管理 (階層樹)</h3>
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill"></i> 
                <strong>目前使用的資料庫：</strong> <span id="folders-current-db-name" class="badge bg-primary fs-6">載入中...</span>
            </div>
            <div class="mb-3">
                <button class="btn btn-primary add-btn me-2" data-type="folder">新增資料夾</button>
                <button class="btn btn-success me-2" onclick="exportFoldersCSV(); return false;">匯出資料夾</button>
                <button class="btn btn-info me-2" onclick="showFolderImport(); return false;">批次匯入資料夾</button>
                <a href="csv_generator.html" class="btn btn-warning me-2" target="_blank">
                    <i class="bi bi-magic"></i> 資料夾 CSV 生成器
                </a>
                <button class="btn btn-secondary me-2" onclick="showFolderImportHelp(); return false;">使用說明</button>
            </div>
            <div class="mb-3">
                <button class="btn btn-danger" onclick="autoGenerateGroups(); return false;">
                    <i class="bi bi-stars"></i> 自動生成群組並指派權限
                </button>
                <small class="text-muted ms-2">💡 為所有資料夾自動建立 _RO 和 _RW 群組,並自動指派權限</small>
            </div>
            <div id="folder-import-section" style="display:none;" class="mb-3 p-3 border rounded bg-light">
                <h5>批次匯入資料夾</h5>
                <form id="folder-import-form" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".csv" class="form-control mb-2">
                    <button type="button" class="btn btn-primary me-2" onclick="doFolderImport(); return false;">上傳匯入</button>
                    <button type="button" class="btn btn-secondary" onclick="hideFolderImport(); return false;">取消</button>
                </form>
            </div>
            <ul id="folder-tree" class="tree"></ul>
        </div>

        <div id="users-section" style="display:none;">
            <h3><i class="bi bi-person-fill"></i> 人員管理</h3>
            <div class="mb-3">
                <button class="btn btn-primary add-btn me-2" data-type="user">新增人員</button>
                <button class="btn btn-success me-2" onclick="exportUsersCSV(); return false;">匯出人員</button>
                <button class="btn btn-info me-2" onclick="showUserImport(); return false;">批次匯入人員</button>
                <a href="user_csv_generator.html" class="btn btn-warning me-2" target="_blank">
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV 生成器
                </a>
                <button class="btn btn-secondary" onclick="showUserImportHelp(); return false;">使用說明</button>
            </div>
            <div id="user-import-section" style="display:none;" class="mb-3 p-3 border rounded bg-light">
                <h5>批次匯入人員</h5>
                <form id="user-import-form" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".csv" class="form-control mb-2">
                    <button type="button" class="btn btn-primary me-2" onclick="doUserImport(); return false;">上傳匯入</button>
                    <button type="button" class="btn btn-secondary" onclick="hideUserImport(); return false;">取消</button>
                </form>
            </div>
            <table class="table" id="users-table">
                <thead><tr><th>ID</th><th>姓名</th><th>Email</th><th>操作</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="groups-section" style="display:none;">
            <h3><i class="bi bi-people-fill"></i> 群組管理</h3>
            <div class="mb-3">
                <button class="btn btn-primary add-btn me-2" data-type="group">新增群組</button>
                <button class="btn btn-success me-2" onclick="exportGroupsCSV(); return false;">匯出群組</button>
                <button class="btn btn-info me-2" onclick="showGroupImport(); return false;">批次匯入群組</button>
                <button class="btn btn-secondary" onclick="showGroupImportHelp(); return false;">使用說明</button>
            </div>
            <div id="group-import-section" style="display:none;" class="mb-3 p-3 border rounded bg-light">
                <h5>批次匯入群組</h5>
                <form id="group-import-form" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".csv" class="form-control mb-2">
                    <button type="button" class="btn btn-primary me-2" onclick="doGroupImport(); return false;">上傳匯入</button>
                    <button type="button" class="btn btn-secondary" onclick="hideGroupImport(); return false;">取消</button>
                </form>
            </div>
            <table class="table" id="groups-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th style="cursor:pointer;" onclick="sortGroups('name')" title="點擊排序">
                            名稱 <i id="sort-name-icon" class="bi bi-arrow-down-up text-muted"></i>
                        </th>
                        <th style="cursor:pointer;" onclick="sortGroups('members')" title="點擊排序">
                            人員清單 <i id="sort-members-icon" class="bi bi-arrow-down-up text-muted"></i>
                        </th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="permissions-section" style="display:none;">
            <h3><i class="bi bi-key-fill"></i> 權限管理</h3>
            
            <div class="mb-3">
                <button class="btn btn-danger me-2" onclick="exportFullCSV(); return false;">
                    <i class="bi bi-download"></i> 匯出完整資料 CSV
                </button>
                <button class="btn btn-success me-2" onclick="exportCSV(); return false;">
                    <i class="bi bi-download"></i> 匯出權限 CSV
                </button>
                <a href="permission_generator.html" class="btn btn-warning me-2" target="_blank">
                    <i class="bi bi-magic"></i> 權限 CSV 生成器
                </a>
                <small class="text-muted d-block mt-2">
                    💡 <strong>匯出完整資料 CSV</strong>:一次性匯出所有資料(資料夾、人員、群組、群組成員、權限),可直接匯入重建完整系統<br>
                    💡 <strong>匯出權限 CSV</strong>:僅匯出權限記錄 / <strong>權限 CSV 生成器</strong>:從 Excel 快速轉換權限表
                </small>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-key-fill"></i> 指派權限</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">選擇資料夾</label>
                            <select id="folder-select" class="form-select">
                                <option value="">請選擇資料夾</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">選擇人員(可複選)</label>
                            <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllUsers(true)">全選</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllUsers(false)">取消全選</button>
                                </div>
                                <div id="users-checkbox-list">
                                    <p class="text-muted">載入中...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">選擇群組(可複選)</label>
                            <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllGroups(true)">全選</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllGroups(false)">取消全選</button>
                                </div>
                                <div id="groups-checkbox-list">
                                    <p class="text-muted">載入中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">權限類型</label>
                            <select id="perm-type" class="form-select">
                                <option value="read">讀取</option>
                                <option value="write">寫入</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="addPermissions(); return false;">
                                <i class="bi bi-check-circle"></i> 批次指派權限
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            <strong>提示:</strong>您可以同時選擇多個人員和多個群組,系統會為所有選中的對象指派相同的權限。
                        </small>
                    </div>
                </div>
            </div>
            
            <h5 class="mt-4">已指派的權限</h5>
            <table class="table mt-3" id="perms-table">
                <thead class="table-light">
                    <tr>
                        <th>資料夾</th>
                        <th>人員/群組</th>
                        <th>權限</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 查詢頁面 -->
        <div id="query-section" style="display:none;">
            <h3><i class="bi bi-search"></i> 成員查詢</h3>
            
            <div class="row">
                <!-- 左側:查詢群組成員 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-people-fill"></i> 查詢群組成員</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">關鍵字搜尋群組</label>
                                <input type="text" id="group-search-input" class="form-control" placeholder="輸入群組名稱關鍵字..." oninput="filterGroupSelect()">
                                <small class="text-muted">可快速篩選下方群組列表</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">選擇群組</label>
                                <select id="query-group-select" class="form-select" onchange="queryGroupMembers()">
                                    <option value="">請選擇群組</option>
                                </select>
                            </div>
                            
                            <div id="group-members-result" style="display:none;">
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-info-circle-fill"></i> 群組資訊</strong>
                                    <div class="mt-2">
                                        <strong>群組名稱:</strong><span id="result-group-name"></span><br>
                                        <strong>成員數量:</strong><span id="result-group-count"></span> 人
                                    </div>
                                </div>
                                
                                <h6 class="fw-bold mb-3">成員列表</h6>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th width="15%">ID</th>
                                                <th width="30%">姓名</th>
                                                <th width="55%">Email</th>
                                            </tr>
                                        </thead>
                                        <tbody id="group-members-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="group-members-empty" style="display:none;">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 此群組目前沒有成員
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側:查詢人員所屬群組 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-person-fill"></i> 查詢人員所屬群組</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">關鍵字搜尋人員</label>
                                <input type="text" id="user-search-input" class="form-control" placeholder="輸入姓名或Email關鍵字..." oninput="filterUserSelect()">
                                <small class="text-muted">可快速篩選下方人員列表</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">選擇人員</label>
                                <select id="query-user-select" class="form-select" onchange="queryUserGroups()">
                                    <option value="">請選擇人員</option>
                                </select>
                            </div>
                            
                            <div id="user-groups-result" style="display:none;">
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-info-circle-fill"></i> 人員資訊</strong>
                                    <div class="mt-2">
                                        <strong>姓名:</strong><span id="result-user-name"></span><br>
                                        <strong>Email:</strong><span id="result-user-email"></span><br>
                                        <strong>所屬群組數:</strong><span id="result-user-group-count"></span> 個
                                    </div>
                                </div>
                                
                                <h6 class="fw-bold mb-3">所屬群組列表</h6>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th width="15%">ID</th>
                                                <th width="85%">群組名稱</th>
                                            </tr>
                                        </thead>
                                        <tbody id="user-groups-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="user-groups-empty" style="display:none;">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 此人員目前未加入任何群組
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 帳號管理區塊（僅管理員可見） -->
        <div id="account-management-section" style="display:none;">
            <h3><i class="bi bi-shield-fill-check"></i> 帳號管理</h3>
            
            <!-- 待審核帳號 -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> 待審核帳號
                        <span id="pending-count-badge" class="badge bg-danger ms-2">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="pending-accounts-empty" class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> 目前沒有待審核的帳號
                    </div>
                    <div id="pending-accounts-list" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="10%">編號</th>
                                        <th width="20%">使用者名稱</th>
                                        <th width="20%">姓名</th>
                                        <th width="15%">註冊時間</th>
                                        <th width="35%">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-accounts-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 所有帳號列表 -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill"></i> 所有帳號
                        <span id="total-accounts-badge" class="badge bg-light text-dark ms-2">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="8%">編號</th>
                                    <th width="15%">使用者名稱</th>
                                    <th width="15%">姓名</th>
                                    <th width="12%">角色</th>
                                    <th width="12%">狀態</th>
                                    <th width="18%">資料庫</th>
                                    <th width="12%">註冊時間</th>
                                    <th width="8%">操作</th>
                                </tr>
                            </thead>
                            <tbody id="all-accounts-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="import-section" style="display:none;">
            <h3><i class="bi bi-upload"></i> 批次匯入 CSV (全功能)</h3>
            
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle-fill"></i> 功能說明</h5>
                <p>此功能支援一次性匯入<strong>人員、群組、資料夾、權限</strong>等所有資料,適合用於:</p>
                <ul class="mb-0">
                    <li>🔄 <strong>系統遷移</strong>:從其他系統匯入完整資料</li>
                    <li>💾 <strong>資料還原</strong>:還原之前匯出的備份資料</li>
                    <li>🚀 <strong>快速部署</strong>:一次建立所有資料結構和權限設定</li>
                </ul>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> 上傳 CSV 檔案</h5>
                </div>
                <div class="card-body">
                    <form id="import-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label fw-bold">選擇 CSV 檔案</label>
                            <input type="file" name="file" accept=".csv" class="form-control">
                            <small class="form-text text-muted">請確保檔案使用 UTF-8 編碼</small>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg" onclick="doImport(); return false;">
                            <i class="bi bi-upload"></i> 開始匯入
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-question-circle"></i> CSV 格式說明</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">📋 支援的資料類型</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">type 值</th>
                                    <th width="35%">說明</th>
                                    <th width="50%">必填欄位</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>user</code></td>
                                    <td>人員資料</td>
                                    <td><code>name</code>, <code>email</code></td>
                                </tr>
                                <tr>
                                    <td><code>group</code></td>
                                    <td>群組資料</td>
                                    <td><code>name</code></td>
                                </tr>
                                <tr>
                                    <td><code>group_member</code></td>
                                    <td>群組成員</td>
                                    <td><code>group_id</code>, <code>user_id</code></td>
                                </tr>
                                <tr>
                                    <td><code>folder</code></td>
                                    <td>資料夾結構</td>
                                    <td><code>name</code>, <code>parent_id</code> (選填)</td>
                                </tr>
                                <tr>
                                    <td><code>permission</code></td>
                                    <td>權限指派</td>
                                    <td><code>folder_id</code>, <code>user_id</code> 或 <code>group_id</code>, <code>permission_type</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="text-primary mt-3">📝 CSV 格式範例</h6>
                    <pre class="bg-light p-3 border rounded"><code>type,name,email,parent_id,folder_id,user_id,group_id,permission_type
user,張三,zhangsan@example.com,,,,,
user,李四,lisi@example.com,,,,,
user,王五,wangwu@example.com,,,,,
group,管理部,,,,,,
group,業務部,,,,,,
group_member,,,,,1,1,
group_member,,,,,2,1,
group_member,,,,,3,2,
folder,share,,,,,,
folder,財務部,,1,,,, 
folder,人事部,,1,,,,
permission,,,,1,1,,read
permission,,,,2,,1,write
permission,,,,3,,2,write</code></pre>
                    
                    <div class="alert alert-success mt-2">
                        <strong>範例說明:</strong>
                        <ul class="mb-0 mt-2">
                            <li>前 3 行建立人員:張三、李四、王五(自動分配 ID 1, 2, 3)</li>
                            <li>接著 2 行建立群組:管理部、業務部(ID 1, 2)</li>
                            <li>然後 3 行設定群組成員:張三和李四加入管理部,王五加入業務部</li>
                            <li>再來 3 行建立資料夾:share (ID 1)、財務部 (ID 2)、人事部 (ID 3)</li>
                            <li>最後 3 行指派權限:張三對資料夾1讀取、管理部對資料夾2寫入、業務部對資料夾3管理</li>
                        </ul>
                    </div>
                    
                    <h6 class="text-primary mt-3">⚠️ 重要注意事項</h6>
                    <ol>
                        <li><strong>匯入順序</strong>:系統會按照 CSV 順序處理,建議依序放入:人員 → 群組 → <span class="text-danger">群組成員</span> → 資料夾 → 權限</li>
                        <li><strong>ID 參照</strong>:<code>parent_id</code>, <code>folder_id</code>, <code>user_id</code>, <code>group_id</code> 必須參照已存在的項目 ID</li>
                        <li><strong>群組成員</strong>:必須在建立群組和人員<strong>之後</strong>才能設定群組成員關係</li>
                        <li><strong>UTF-8 編碼</strong>:請確保 CSV 檔案使用 UTF-8 編碼,避免中文亂碼</li>
                        <li><strong>權限類型</strong>:<code>permission_type</code> 可用值:<code>read</code> (讀取)、<code>write</code> (寫入)</li>
                    </ol>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-lightbulb-fill"></i> 
                        <strong>小提示:</strong>如果只需要匯入特定類型的資料,請使用各個管理頁面中的專用匯入功能:
                        <ul class="mb-0 mt-2">
                            <li>只匯入資料夾 → 前往「資料夾管理」使用「批次匯入資料夾」</li>
                            <li>只匯入人員 → 前往「人員管理」使用「批次匯入人員」</li>
                            <li>只匯入群組 → 前往「群組管理」使用「批次匯入群組」</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匯入進度條模態 -->
    <div class="modal fade" tabindex="-1" id="import-progress-modal" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-upload"></i> 資料匯入進度
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status" id="import-spinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h6 class="mt-2" id="import-status">準備開始匯入...</h6>
                    </div>

                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar"
                             style="width: 0%"
                             id="import-progress-bar"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <span id="progress-text">0%</span>
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-info-circle"></i> 處理狀態
                            </h6>
                            <div id="processing-steps" class="small text-muted">
                                <div class="step-item" data-step="folders">
                                    <i class="bi bi-circle"></i> 準備處理資料夾...
                                </div>
                                <div class="step-item" data-step="users">
                                    <i class="bi bi-circle"></i> 等待處理人員...
                                </div>
                                <div class="step-item" data-step="groups">
                                    <i class="bi bi-circle"></i> 等待處理群組...
                                </div>
                                <div class="step-item" data-step="group_members">
                                    <i class="bi bi-circle"></i> 等待處理群組成員...
                                </div>
                                <div class="step-item" data-step="permissions">
                                    <i class="bi bi-circle"></i> 等待處理權限...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="bi bi-clock"></i>
                            <strong>請耐心等待:</strong>系統正在按正確順序處理所有資料類型。
                            這個過程可能需要一些時間,特別是當資料量較大時。
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增資料庫模態 -->
    <div class="modal fade" tabindex="-1" id="create-database-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5><i class="bi bi-plus-circle"></i> 新增資料庫</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="user-db-naming-notice" class="alert alert-info" style="display: none;">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>命名規則：</strong>您的資料庫名稱必須以 <code id="user-db-prefix"></code> 開頭<br>
                        <small>例如：<span id="user-db-example"></span></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">資料庫名稱</label>
                        <input type="text" id="new-db-name" class="form-control" placeholder="例如:專案A.db">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            請使用英文、數字、底線或中文,並以 .db 結尾
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="createDatabase()">
                        <i class="bi bi-check-circle"></i> 建立
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 複製資料庫模態 -->
    <div class="modal fade" tabindex="-1" id="copy-database-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5><i class="bi bi-files"></i> 複製資料庫</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="copy-source-name">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        來源:<strong id="copy-source-display"></strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新資料庫名稱</label>
                        <input type="text" id="copy-target-name" class="form-control" placeholder="例如:專案A_備份.db">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info" onclick="copyDatabase()">
                        <i class="bi bi-check-circle"></i> 複製
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 重新命名資料庫模態 -->
    <div class="modal fade" tabindex="-1" id="rename-database-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5><i class="bi bi-pencil-square"></i> 重新命名資料庫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="rename-old-name">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        目前名稱:<strong id="rename-old-display"></strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新名稱</label>
                        <input type="text" id="rename-new-name" class="form-control" placeholder="例如:專案B.db">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="renameDatabase()">
                        <i class="bi bi-check-circle"></i> 重新命名
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用新增/編輯模態 -->
    <div class="modal fade" tabindex="-1" id="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="modal-title">新增</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3">
                        <label class="form-label">名稱</label>
                        <input type="text" id="name-input" class="form-control" required>
                    </div>
                    <div class="mb-3" id="email-div" style="display:none;">
                        <label class="form-label">Email</label>
                        <input type="email" id="email-input" class="form-control" required>
                    </div>
                    <div class="mb-3" id="parent-div" style="display:none;">
                        <label class="form-label">父資料夾</label>
                        <select class="form-control" id="parent-select">
                            <option value="">根目錄</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveItem();">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 群組人員編輯模態 -->
    <div class="modal fade" tabindex="-1" id="group-members-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="group-members-title">編輯群組人員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="group-edit-id">
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllGroupMembers()">
                            <i class="bi bi-check-square"></i> 全選
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllGroupMembers()">
                            <i class="bi bi-square"></i> 取消全選
                        </button>
                    </div>
                    <div id="member-list" class="member-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveGroupMembers();">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 權限衝突警告模態框 -->
    <div class="modal fade" tabindex="-1" id="permissions-conflict-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> 無法刪除</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger mb-3">
                        <strong id="conflict-message">此項目已被指派權限,無法刪除</strong>
                    </div>
                    
                    <h6 class="text-primary">📋 已指派的權限清單:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="10%">權限ID</th>
                                    <th width="60%">資料夾</th>
                                    <th width="30%">權限類型</th>
                                </tr>
                            </thead>
                            <tbody id="conflict-permissions-list">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>解決方法:</strong>
                        <ol class="mb-0 mt-2">
                            <li>前往「權限管理」頁面</li>
                            <li>刪除上述所有相關的權限指派</li>
                            <li>再回來刪除此項目</li>
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" onclick="goToPermissionsPage();">前往權限管理</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 資料夾匯入說明模態 -->
    <div class="modal fade" tabindex="-1" id="folder-import-help-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>資料夾批次匯入使用說明</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-primary">📋 CSV 檔案格式說明</h6>
                    <p>CSV 檔案必須包含以下三個欄位(第一行為標題):</p>
                    <ul>
                        <li><code>type</code>:資料類型,固定填寫 <strong>folder</strong></li>
                        <li><code>name</code>:資料夾名稱</li>
                        <li><code>parent_id</code>:父資料夾的 ID(如果是根資料夾則留空)</li>
                    </ul>

                    <h6 class="text-primary mt-3">📝 CSV 範例內容</h6>
                    <pre class="bg-light p-3 border rounded"><code>type,name,parent_id
folder,總公司,
folder,業務部,1
folder,行銷部,1
folder,研發部,1
folder,業務一組,2
folder,業務二組,2
folder,前端組,4
folder,後端組,4</code></pre>

                    <h6 class="text-primary mt-3">🔍 範例說明</h6>
                    <ul>
                        <li>第 1 行:標題列(必須)</li>
                        <li>第 2 行:建立「總公司」根資料夾(parent_id 為空)</li>
                        <li>第 3-5 行:建立三個部門,parent_id=1 表示父資料夾是「總公司」(ID 為 1)</li>
                        <li>第 6-7 行:在「業務部」下建立兩個組別</li>
                        <li>第 8-9 行:在「研發部」下建立兩個組別</li>
                    </ul>

                    <h6 class="text-primary mt-3">⚠️ 重要注意事項</h6>
                    <ol>
                        <li><strong>檔案編碼</strong>:請確保 CSV 檔案使用 <span class="text-danger">UTF-8</span> 編碼</li>
                        <li><strong>匯入順序</strong>:必須先建立父資料夾,再建立子資料夾(從上到下依序處理)</li>
                        <li><strong>parent_id 查詢</strong>:可先點擊「匯出資料夾」查看現有資料夾的 ID</li>
                        <li><strong>根資料夾</strong>:如要建立根資料夾,parent_id 欄位留空即可</li>
                        <li><strong>特殊字元</strong>:資料夾名稱如包含逗號,請用雙引號包圍,例如:"財務部(總部)"</li>
                    </ol>

                    <h6 class="text-primary mt-3">💡 使用步驟</h6>
                    <ol>
                        <li>點擊「匯出資料夾」下載現有資料夾結構(可作為範本參考)</li>
                        <li>使用 Excel 或文字編輯器編輯 CSV 檔案</li>
                        <li>確保檔案格式正確且使用 UTF-8 編碼儲存</li>
                        <li>點擊「批次匯入資料夾」按鈕</li>
                        <li>選擇您的 CSV 檔案並上傳</li>
                        <li>匯入完成後會自動重新載入資料夾樹狀結構</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 人員匯入說明模態 -->
    <div class="modal fade" tabindex="-1" id="user-import-help-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>人員批次匯入使用說明</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-primary">📋 CSV 檔案格式說明</h6>
                    <p>CSV 檔案必須包含以下三個欄位(第一行為標題):</p>
                    <ul>
                        <li><code>type</code>:資料類型,固定填寫 <strong>user</strong></li>
                        <li><code>name</code>:人員姓名</li>
                        <li><code>email</code>:電子郵件(必須唯一)</li>
                    </ul>

                    <h6 class="text-primary mt-3">📝 CSV 範例內容</h6>
                    <pre class="bg-light p-3 border rounded"><code>type,name,email
user,張三,zhang.san@example.com
user,李四,li.si@example.com
user,王五,wang.wu@example.com
user,趙六,zhao.liu@example.com</code></pre>

                    <h6 class="text-primary mt-3">⚠️ 重要注意事項</h6>
                    <ol>
                        <li><strong>檔案編碼</strong>:請確保 CSV 檔案使用 <span class="text-danger">UTF-8</span> 編碼</li>
                        <li><strong>Email 唯一性</strong>:每個 Email 必須是唯一的,重複的 Email 會被忽略</li>
                        <li><strong>Email 格式</strong>:請確保 Email 格式正確</li>
                        <li><strong>特殊字元</strong>:姓名或 Email 如包含逗號,請用雙引號包圍</li>
                    </ol>

                    <h6 class="text-primary mt-3">💡 使用步驟</h6>
                    <ol>
                        <li>點擊「匯出人員」下載現有人員清單(可作為範本參考)</li>
                        <li>使用 Excel 或文字編輯器編輯 CSV 檔案</li>
                        <li>確保檔案格式正確且使用 UTF-8 編碼儲存</li>
                        <li>點擊「批次匯入人員」按鈕</li>
                        <li>選擇您的 CSV 檔案並上傳</li>
                        <li>匯入完成後會自動重新載入人員清單</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 群組匯入說明模態 -->
    <div class="modal fade" tabindex="-1" id="group-import-help-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>群組批次匯入使用說明</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-primary">📋 CSV 檔案格式說明</h6>
                    <p>CSV 檔案支援兩種資料類型:</p>
                    <ul>
                        <li><code>group</code>:建立群組(必填欄位:<code>name</code>)</li>
                        <li><code>group_member</code>:設定群組成員(必填欄位:<code>group_id</code>, <code>user_id</code>)</li>
                    </ul>

                    <h6 class="text-primary mt-3">📝 CSV 範例內容</h6>
                    
                    <p><strong>方式 1:只匯入群組(不含成員)</strong></p>
                    <pre class="bg-light p-3 border rounded"><code>type,name
group,開發部
group,設計部
group,營運部
group,行銷部</code></pre>
                    <small class="text-muted">匯入後需手動使用「編輯人員」功能添加成員</small>

                    <p class="mt-3"><strong>方式 2:匯入群組含成員(推薦)</strong></p>
                    <pre class="bg-light p-3 border rounded"><code>type,name,group_id,user_id
group,開發部,,
group,設計部,,
group_member,,1,1
group_member,,1,2
group_member,,2,3
group_member,,2,4</code></pre>
                    <div class="alert alert-success mt-2">
                        <strong>範例說明:</strong>
                        <ul class="mb-0">
                            <li>前 2 行建立群組:開發部(ID 1)、設計部(ID 2)</li>
                            <li>接下來 4 行設定成員:
                                <ul>
                                    <li>人員1和人員2 加入開發部</li>
                                    <li>人員3和人員4 加入設計部</li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <h6 class="text-primary mt-3">📌 注意事項</h6>
                    <ul>
                        <li><strong>匯出功能</strong>:點擊「匯出群組」會同時匯出群組和成員關係</li>
                        <li><strong>ID 參照</strong>:<code>group_id</code> 和 <code>user_id</code> 必須是系統中已存在的 ID</li>
                        <li><strong>匯入順序</strong>:必須先建立群組,再設定群組成員</li>
                    </ul>

                    <h6 class="text-primary mt-3">⚠️ 重要注意事項</h6>
                    <ol>
                        <li><strong>檔案編碼</strong>:請確保 CSV 檔案使用 <span class="text-danger">UTF-8</span> 編碼</li>
                        <li><strong>群組名稱</strong>:建議使用有意義且容易識別的名稱</li>
                        <li><strong>特殊字元</strong>:群組名稱如包含逗號,請用雙引號包圍</li>
                    </ol>

                    <h6 class="text-primary mt-3">💡 使用步驟</h6>
                    <ol>
                        <li>點擊「匯出群組」下載現有群組清單(可作為範本參考)</li>
                        <li>使用 Excel 或文字編輯器編輯 CSV 檔案</li>
                        <li>確保檔案格式正確且使用 UTF-8 編碼儲存</li>
                        <li>點擊「批次匯入群組」按鈕</li>
                        <li>選擇您的 CSV 檔案並上傳</li>
                        <li>匯入完成後會自動重新載入群組清單</li>
                        <li>使用「編輯人員」功能為各群組添加成員</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 清空所有資料確認模態 -->
    <div class="modal fade" tabindex="-1" id="clear-all-modal">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">⚠️ 危險操作:清空所有資料</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>警告!</strong> 此操作將永久刪除所有資料,包括:
                        <ul class="mt-2 mb-0">
                            <li>所有資料夾及其階層結構</li>
                            <li>所有人員資料</li>
                            <li>所有群組及成員關係</li>
                            <li>所有權限設定</li>
                        </ul>
                    </div>
                    
                    <p class="text-danger"><strong>此操作無法復原!</strong></p>
                    
                    <p>如果您確定要清空所有資料,請在下方輸入確認碼:</p>
                    <div class="mb-3">
                        <label class="form-label">確認碼:<code class="text-danger">CLEAR_ALL_DATA</code></label>
                        <input type="text" id="clear-confirm-input" class="form-control" placeholder="請輸入確認碼">
                        <small class="text-muted">請完全依照上方確認碼輸入(區分大小寫)</small>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <strong>💡 建議:</strong> 在清空資料前,請先使用「匯出 CSV」和「匯出資料夾」功能備份重要資料。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="confirmClearAll();">
                        <i class="bi bi-trash"></i> 確定清空所有資料
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密碼模態框 -->
    <div class="modal fade" tabindex="-1" id="change-password-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-key-fill"></i> 修改密碼</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>密碼要求：</strong>
                        <ul class="mb-0 mt-2">
                            <li>長度至少 6 個字元</li>
                            <li>新密碼不能與當前密碼相同</li>
                        </ul>
                    </div>
                    
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">當前密碼 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="current-password" required autocomplete="current-password">
                        </div>
                        
                        <div class="mb-3">
                            <label for="new-password" class="form-label">新密碼 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="new-password" required minlength="6" autocomplete="new-password">
                            <small class="text-muted">至少 6 個字元</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">確認新密碼 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="confirm-password" required minlength="6" autocomplete="new-password">
                        </div>
                        
                        <div id="password-match-message" class="text-danger small" style="display: none;">
                            ⚠️ 兩次輸入的新密碼不一致
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword();">
                        <i class="bi bi-check-circle"></i> 確認修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 認證檢查 ====================
        let currentUser = null;

        // 頁面載入時檢查登入狀態
        $(document).ready(function() {
            checkAuthStatus();
        });

        // 檢查登入狀態
        function checkAuthStatus() {
            $.ajax({
                url: '/api/auth/status',
                method: 'GET',
                success: function(response) {
                    if (response.loggedIn) {
                        currentUser = response.user;
                        // 認證成功，顯示頁面內容（加入淡入效果）
                        $('body').addClass('authenticated');
                        updateUserDisplay();
                        // 載入初始資料
                        initializePage();
                    } else {
                        // 未登入,重導向到登入頁面（頁面保持隱藏）
                        window.location.href = '/login.html';
                    }
                },
                error: function() {
                    // 檢查失敗,重導向到登入頁面（頁面保持隱藏）
                    window.location.href = '/login.html';
                }
            });
        }

        // 更新使用者顯示
        function updateUserDisplay() {
            if (currentUser) {
                const displayName = currentUser.fullName || currentUser.username;
                $('#user-display-name').text(displayName);
                
                let roleText = currentUser.role === 'admin' ? '管理員' : '一般使用者';
                let roleClass = currentUser.role === 'admin' ? 'text-danger' : 'text-primary';
                $('#user-info').html(`
                    <i class="bi bi-person-circle"></i> ${displayName}<br>
                    <small class="${roleClass}"><i class="bi bi-shield-fill"></i> ${roleText}</small>
                `);
                
                // 顯示/隱藏管理員選單
                if (currentUser.role === 'admin') {
                    $('#admin-menu-item').show();
                } else {
                    $('#admin-menu-item').hide();
                }
            }
        }

        // 顯示修改密碼模態框
        function showChangePasswordModal() {
            // 重置表單
            $('#change-password-form')[0].reset();
            $('#password-match-message').hide();
            
            // 顯示模態框
            $('#change-password-modal').modal('show');
        }
        
        // 檢查密碼是否一致
        $('#confirm-password').on('input', function() {
            const newPassword = $('#new-password').val();
            const confirmPassword = $('#confirm-password').val();
            
            if (confirmPassword && newPassword !== confirmPassword) {
                $('#password-match-message').show();
            } else {
                $('#password-match-message').hide();
            }
        });
        
        // 修改密碼
        function changePassword() {
            const currentPassword = $('#current-password').val().trim();
            const newPassword = $('#new-password').val().trim();
            const confirmPassword = $('#confirm-password').val().trim();
            
            // 驗證輸入
            if (!currentPassword) {
                alert('❌ 請輸入當前密碼');
                return;
            }
            
            if (!newPassword) {
                alert('❌ 請輸入新密碼');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('❌ 新密碼長度至少需要 6 個字元');
                return;
            }
            
            if (!confirmPassword) {
                alert('❌ 請確認新密碼');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('❌ 兩次輸入的新密碼不一致');
                return;
            }
            
            if (currentPassword === newPassword) {
                alert('❌ 新密碼不能與當前密碼相同');
                return;
            }
            
            // 發送修改密碼請求
            $.ajax({
                url: '/api/auth/change-password',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                }),
                success: function(response) {
                    $('#change-password-modal').modal('hide');
                    alert('✅ ' + response.message + '\n\n請使用新密碼重新登入。');
                    
                    // 修改密碼成功後，自動登出並跳轉到登入頁面
                    $.ajax({
                        url: '/api/auth/logout',
                        method: 'POST',
                        complete: function() {
                            window.location.href = '/login.html';
                        }
                    });
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || '修改密碼失敗，請稍後再試';
                    alert('❌ ' + error);
                    
                    // 如果是當前密碼錯誤，清空當前密碼欄位
                    if (error.includes('當前密碼錯誤')) {
                        $('#current-password').val('').focus();
                    }
                }
            });
        }
        
        // 登出
        function logout() {
            if (confirm('確定要登出嗎?')) {
                $.ajax({
                    url: '/api/auth/logout',
                    method: 'POST',
                    success: function() {
                        window.location.href = '/login.html';
                    },
                    error: function(xhr) {
                        alert('登出失敗: ' + (xhr.responseJSON?.error || '請重試'));
                    }
                });
            }
        }

        // 初始化頁面
        function initializePage() {
            // 初始載入資料夾
            showSection('folders');
            
            // 綁定分頁切換事件
            $('.nav-link[data-section]').on('click', function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                showSection(section);
            });
        }

        // ==================== 原有變數 ====================
        let currentSection = 'folders';
        let currentType = '';
        let allUsers = [];  // 全球人員清單
        let currentGroupId = 0;  // 當前編輯群組 ID
        let currentGroupMembers = [];  // 當前群組成員 ID 陣列
        let currentGroupName = '';  // 當前群組名稱

        function showSection(sec) {
            // 隱藏所有主要區段
            $('#databases-section, #folders-section, #users-section, #groups-section, #permissions-section, #query-section, #import-section, #account-management-section').hide();
            // 顯示指定區段
            $('#' + sec + '-section').show();
            currentSection = sec;
            // 匯入頁面和資料庫頁面不需要載入一般資料
            if (sec === 'databases') {
                loadDatabases();
            } else if (sec === 'query') {
                loadQueryPage();
            } else if (sec === 'account-management') {
                loadAccountManagement();
            } else if (sec !== 'import') {
                loadData(sec);
            }
        }

        function loadData(type) {
            let apiUrl;
            if (type === 'folders') apiUrl = '/api/folders';
            else if (type === 'users') apiUrl = '/api/users';
            else if (type === 'groups') apiUrl = '/api/groups';
            else if (type === 'permissions') apiUrl = '/api/permissions';
            else apiUrl = `/api/${type}s`;
            console.log('Loading data from:', apiUrl);
            $.get(apiUrl).done(function(data) {
                console.log('Loaded data for ' + type + ':', data);
                if (type === 'folders') {
                    updateFoldersDbName();
                    buildTree(data, $('#folder-tree'));
                } else if (type === 'users') {
                    buildTable(data, '#users-table tbody', ['id', 'name', 'email'], type);
                    allUsers = data;  // 更新全球人員清單
                } else if (type === 'groups') {
                    loadGroups(data);
                } else if (type === 'permissions') {
                    loadPermissions(data);
                }
            }).fail(function(xhr, status, error) {
                console.error('API Error for ' + type + ':', error, xhr);
                
                // 如果是 401 未授權，跳轉到登入頁面
                if (xhr.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                
                // 其他錯誤才顯示警告
                let errorMsg = '載入失敗';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.statusText && xhr.statusText !== 'error') {
                    errorMsg = xhr.statusText;
                } else if (error) {
                    errorMsg = error;
                }
                
                alert('❌ ' + type + ' ' + errorMsg + '\n請檢查網路連線或後端服務是否正常運行。');
            });
        }

        // 最終 buildTree 函數
        function buildTree(items, ul, parentId = null, level = 0) {
            ul.empty();
            if (!items || items.length === 0) {
                if (parentId === null) {
                    ul.html('<li class="text-muted">無資料夾</li>');
                }
                return;
            }
            
            // 過濾出當前層級的項目
            const currentLevel = items.filter(f => {
                const pid = f.parent_id;
                if (parentId === null) {
                    // 根層級:parent_id 為 null, '', 或無效數字
                    return pid == null || pid === '' || isNaN(Number(pid));
                } else {
                    // 子層級:parent_id 要匹配當前 parentId
                    return pid != null && String(pid).trim() === String(parentId);
                }
            });
            
            console.log(`Items at level ${level} (parentId: ${parentId}):`, currentLevel.map(r => ({name: r.name, id: r.id, parent_id: r.parent_id})));
            
            if (currentLevel.length === 0 && parentId === null) {
                ul.html('<li class="text-muted">無根資料夾</li>');
                return;
            }
            
            currentLevel.forEach(item => {
                // 檢查是否有子資料夾
                const hasChildren = items.some(f => {
                    return f.parent_id != null && String(f.parent_id).trim() === String(item.id);
                });
                
                // 根據層級計算圖示大小(第一層 1.2em,之後每層減少 0.1em,最小 0.85em)
                const iconSize = Math.max(0.85, 1.2 - (level * 0.08));
                const emojiSize = Math.max(0.9, 1.1 - (level * 0.05));
                
                // 根據是否有子資料夾顯示不同圖示
                let icon = '';
                if (hasChildren) {
                    // 有子資料夾:顯示三角形 + 資料夾圖示
                    icon = `<i class="bi bi-caret-right-fill folder-icon" style="transition: transform 0.3s; font-size: ${iconSize}em;"></i> <span style="font-size: ${emojiSize}em;">📁</span> `;
                } else {
                    // 無子資料夾:只顯示資料夾圖示(稍小)
                    icon = `<span style="font-size: ${emojiSize}em;">📁</span> `;
                }
                
                // 創建資料夾項目和按鈕
                const li = $('<li></li>');
                
                // 資料夾名稱(可點擊展開/收合)
                const folderSpan = $(`<span class="folder-item" style="cursor:pointer;">${icon}${item.name} <span class="text-muted">(ID: ${item.id})</span></span>`);
                
                // 編輯和刪除按鈕
                const editBtn = $(`<button class="btn btn-sm btn-outline-primary btn-edit-folder ms-2" title="編輯"><i class="bi bi-pencil"></i></button>`)
                    .data('id', item.id)
                    .data('name', item.name)
                    .data('parent', item.parent_id || '');
                
                const deleteBtn = $(`<button class="btn btn-sm btn-outline-danger btn-delete-folder ms-1" title="刪除"><i class="bi bi-trash"></i></button>`)
                    .data('id', item.id)
                    .data('name', item.name);
                
                // 子資料夾列表
                const subUl = $('<ul style="display:none;" class="sub-ul"></ul>');
                
                // 組裝:資料夾名稱 + 按鈕 + 子列表
                folderSpan.on('click', function() {
                    toggle(this);
                });
                
                li.append(folderSpan);
                li.append(editBtn);
                li.append(deleteBtn);
                li.append(subUl);
                
                // 遞迴處理子項目,傳入完整的 items 陣列、當前項目的 id 和層級
                buildTree(items, subUl, item.id, level + 1);
                
                ul.append(li);
            });
        }

        function toggle(span) {
            const $span = $(span);
            // 找到父 li 元素,然後找其中的 .sub-ul
            const $li = $span.closest('li');
            const $subUl = $li.find('> .sub-ul');
            const $icon = $span.find('.folder-icon');
            
            // 切換子清單顯示/隱藏
            $subUl.slideToggle(200);
            
            // 旋轉展開圖示
            if ($icon.length > 0) {
                if ($subUl.is(':visible')) {
                    $icon.css('transform', 'rotate(90deg)');
                } else {
                    $icon.css('transform', 'rotate(0deg)');
                }
            }
        }

        function buildTable(data, tbodySelector, fields, type) {
            const tbody = $(tbodySelector);
            tbody.empty();
            if (!data || data.length === 0) {
                tbody.html('<tr><td colspan="' + (fields.length + 1) + '" class="text-muted text-center">無資料</td></tr>');
                return;
            }
            
            // 先按 ID 排序,確保順序穩定
            data.sort((a, b) => a.id - b.id);
            
            data.forEach(item => {
                const tr = $('<tr>');
                fields.forEach(f => tr.append(`<td>${item[f] || 'N/A'}</td>`));
                tr.append(`<td>
                    <button class="btn btn-sm btn-warning edit-btn me-1" data-id="${item.id}" data-type="${type}">編輯</button>
                    <button class="btn btn-sm btn-danger del-btn" data-id="${item.id}" data-type="${type}">刪除</button>
                </td>`);
                tbody.append(tr);
            });
            console.log('Table refreshed for ' + type + ' with ' + data.length + ' items');
        }

        function addItem(type) {
            currentType = type;
            $('#modal-title').text('新增 ' + type);
            $('#edit-id').val('');
            $('#name-input').val('');
            $('#email-div').toggle(type === 'user');
            $('#parent-div').toggle(type === 'folder');
            if (type === 'folder') loadParents();
            $('#modal').modal('show');
        }

        $(document).on('click', '.edit-btn', function() {
            const id = $(this).data('id');
            const type = $(this).data('type');
            let apiUrl;
            if (type === 'folders') apiUrl = `/api/folders/${id}`;
            else if (type === 'users') apiUrl = `/api/users/${id}`;
            else if (type === 'groups') apiUrl = `/api/groups/${id}`;
            else apiUrl = `/api/${type}s/${id}`;
            $.get(apiUrl).done(function(item) {
                console.log('Editing item:', item);
                addItem(type);
                $('#edit-id').val(id);
                $('#name-input').val(item.name || '');
                if (type === 'user') $('#email-input').val(item.email || '');
                if (type === 'folder') $('#parent-select').val(item.parent_id || '');
            }).fail(() => alert('載入編輯資料失敗'));
        });

        function saveItem() {
            if (!$('#name-input').val().trim()) return alert('名稱不可空白');
            const data = { name: $('#name-input').val().trim() };
            if (currentType === 'user' || currentType === 'users') {
                if (!$('#email-input').val().trim()) return alert('Email 不可空白');
                data.email = $('#email-input').val().trim();
            }
            if (currentType === 'folder' || currentType === 'folders') {
                data.parent_id = $('#parent-select').val() || null;
            }
            
            const id = $('#edit-id').val();
            let url;
            if (currentType === 'folder' || currentType === 'folders') {
                url = id ? `/api/folders/${id}` : '/api/folders';
            } else if (currentType === 'user' || currentType === 'users') {
                url = id ? `/api/users/${id}` : '/api/users';
            } else if (currentType === 'group' || currentType === 'groups') {
                url = id ? `/api/groups/${id}` : '/api/groups';
            } else {
                url = id ? `/api/${currentType}s/${id}` : `/api/${currentType}s`;
            }
            
            const method = id ? 'PUT' : 'POST';
            console.log('Saving to:', url, 'Method:', method, 'Data:', data);
            
            $.ajax({ 
                url, 
                method, 
                contentType: 'application/json', 
                data: JSON.stringify(data)
            }).done(function(response) {
                console.log('Save success:', response);
                $('#modal').modal('hide');
                
                // 統一使用複數形式重新載入
                let reloadType = currentType;
                if (currentType === 'folder') reloadType = 'folders';
                else if (currentType === 'user') reloadType = 'users';
                else if (currentType === 'group') reloadType = 'groups';
                
                loadData(reloadType);
                alert('✅ 操作成功!');
            }).fail(function(xhr) {
                console.error('Save failed:', xhr.responseText);
                alert('❌ 操作失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }

        // 資料夾編輯按鈕(按鈕已經是獨立的,不會觸發 toggle)
        $(document).on('click', '.btn-edit-folder', function(e) {
            const id = $(this).data('id');
            const name = $(this).data('name');
            const parent = $(this).data('parent');
            
            currentType = 'folder';
            currentId = id;
            
            $('#modal-title').text('編輯資料夾');
            $('#edit-id').val(id);
            $('#name-input').val(name);
            $('#email-div').hide();
            $('#parent-div').show();
            
            // 載入所有資料夾到父資料夾下拉選單(排除自己和自己的子資料夾)
            $.get('/api/folders').done(function(folders) {
                const $select = $('#parent-select');
                $select.empty();
                $select.append('<option value="">根目錄</option>');
                
                // 建立資料夾路徑映射
                const folderMap = {};
                folders.forEach(f => {
                    folderMap[f.id] = f;
                });
                
                // 找出所有子資料夾(包括孫資料夾)
                function getAllDescendants(folderId, visited = new Set()) {
                    if (visited.has(folderId)) return visited;
                    visited.add(folderId);
                    
                    folders.forEach(f => {
                        if (f.parent_id == folderId && !visited.has(f.id)) {
                            getAllDescendants(f.id, visited);
                        }
                    });
                    
                    return visited;
                }
                
                const excludedIds = getAllDescendants(id);
                
                // 添加所有資料夾(排除自己和子資料夾)
                folders.forEach(f => {
                    if (!excludedIds.has(f.id)) {
                        const path = f.path || f.name;
                        $select.append(`<option value="${f.id}">${path} (ID: ${f.id})</option>`);
                    }
                });
                
                // 設置當前的父資料夾
                $select.val(parent || '');
            });
            
            $('#modal').modal('show');
        });
        
        // 資料夾刪除按鈕(按鈕已經是獨立的,不會觸發 toggle)
        $(document).on('click', '.btn-delete-folder', function(e) {
            const id = $(this).data('id');
            const name = $(this).data('name');
            
            if (confirm(`確認刪除資料夾「${name}」?\n\n注意:如果此資料夾有子資料夾或已被指派權限,將無法刪除。`)) {
                $.ajax({ 
                    url: '/api/folders', 
                    method: 'DELETE', 
                    contentType: 'application/json', 
                    data: JSON.stringify({ id: parseInt(id) })
                }).done(function() {
                    alert('✅ 刪除成功!');
                    loadData('folders');
                }).fail(function(xhr) {
                    console.error('Delete failed:', xhr.responseText);
                    if (xhr.status === 400) {
                        alert('❌ 無法刪除:此資料夾可能有子資料夾或已被指派權限。\n請先刪除子資料夾和相關權限。');
                    } else {
                        alert('❌ 刪除失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
                    }
                });
            }
        });
        
        $(document).on('click', '.del-btn', function() {
            const type = $(this).data('type');
            const id = $(this).data('id');
            
            // 根據類型設定確認訊息
            let confirmMsg = '確認刪除此 ' + type + '?';
            if (type === 'permission') {
                confirmMsg = '確認刪除此權限指派?';
            }
            
            if (confirm(confirmMsg)) {
                // 設定正確的 API URL
                let delUrl = `/api/${type}`;
                if (type === 'folders') delUrl = '/api/folders';
                else if (type === 'users') delUrl = '/api/users';
                else if (type === 'groups') delUrl = '/api/groups';
                else if (type === 'permission') delUrl = '/api/permissions';
                else delUrl = `/api/${type}s`;
                
                console.log(`Deleting ${type} with id ${id} to ${delUrl}`);
                
                $.ajax({ 
                    url: delUrl, 
                    method: 'DELETE', 
                    contentType: 'application/json', 
                    data: JSON.stringify({ id: parseInt(id) })
                }).done(function() {
                    console.log('Delete success for:', type, id);
                    
                    // 根據類型重新載入對應的資料
                    if (type === 'permission') {
                        // 權限刪除後重新載入權限清單
                        loadData('permissions');
                    } else if (type === 'folders' || type === 'folder') {
                        loadData('folders');
                    } else if (type === 'users' || type === 'user') {
                        loadData('users');
                    } else if (type === 'groups' || type === 'group') {
                        loadData('groups');
                    } else {
                        loadData(type);
                    }
                    
                    alert('✅ 刪除成功!');
                }).fail((xhr, status, error) => {
                    console.error('Delete failed:', error, xhr);
                    
                    // 檢查是否是權限衝突錯誤
                    if (xhr.status === 400 && xhr.responseJSON) {
                        const response = xhr.responseJSON;
                        
                        if (response.error === 'cannot_delete_user_with_permissions' || 
                            response.error === 'cannot_delete_group_with_permissions') {
                            // 顯示權限衝突模態框
                            showPermissionsConflict(type, response);
                            return;
                        }
                    }
                    
                    // 其他錯誤
                    alert('❌ 刪除失敗:' + (xhr.responseJSON ? xhr.responseJSON.message || xhr.responseJSON.error : error));
                });
            }
        });

        // 顯示權限衝突模態框
        function showPermissionsConflict(type, response) {
            // 設定訊息
            const itemType = type === 'user' || type === 'users' ? '人員' : '群組';
            $('#conflict-message').text(`此${itemType}已被指派權限,無法刪除`);
            
            // 清空並填充權限清單
            const tbody = $('#conflict-permissions-list');
            tbody.empty();
            
            if (response.permissions && response.permissions.length > 0) {
                response.permissions.forEach(perm => {
                    const permText = perm.permission_type === 'read' ? '讀取' :
                                    perm.permission_type === 'write' ? '寫入' : perm.permission_type;
                    
                    const tr = $(`
                        <tr>
                            <td class="text-center">${perm.id}</td>
                            <td><i class="bi bi-folder-fill text-warning"></i> ${perm.folder}</td>
                            <td><span class="badge bg-primary">${permText}</span></td>
                        </tr>
                    `);
                    tbody.append(tr);
                });
            } else {
                tbody.html('<tr><td colspan="3" class="text-center text-muted">無權限資料</td></tr>');
            }
            
            // 顯示模態框
            $('#permissions-conflict-modal').modal('show');
        }
        
        // 前往權限管理頁面
        function goToPermissionsPage() {
            $('#permissions-conflict-modal').modal('hide');
            showSection('permissions');
        }

        // 群組資料和排序狀態
        let groupsData = [];
        let groupsMemberCounts = {};
        let groupsSortColumn = null;
        let groupsSortDirection = 'asc';
        
        // 群組載入(顯示人員數)
        function loadGroups(data) {
            const tbody = $('#groups-table tbody');
            tbody.empty();
            if (!data || data.length === 0) {
                tbody.html('<tr><td colspan="4" class="text-muted text-center">無群組</td></tr>');
                return;
            }
            
            // 儲存群組資料供排序使用
            groupsData = data;
            groupsMemberCounts = {};
            
            // 先按 ID 排序,確保順序穩定
            data.sort((a, b) => a.id - b.id);
            
            // 先建立所有行(顯示載入中)並按順序插入
            data.forEach(group => {
                const tr = $(`<tr data-group-id="${group.id}" data-group-name="${group.name}">
                    <td>${group.id}</td>
                    <td>${group.name}</td>
                    <td class="member-count" data-member-count="0"><span class="spinner-border spinner-border-sm" role="status"></span> 載入中...</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-group-members-btn" data-id="${group.id}" data-name="${group.name}">編輯人員</button>
                        <button class="btn btn-sm btn-warning edit-btn me-1" data-id="${group.id}" data-type="group">編輯群組</button>
                        <button class="btn btn-sm btn-danger del-btn" data-id="${group.id}" data-type="group">刪除</button>
                    </td>
                </tr>`);
                tbody.append(tr);
                
                // 異步載入成員數並更新對應的行
                $.get(`/api/groups/${group.id}/users`).done(members => {
                    const memberCount = members.length;
                    groupsMemberCounts[group.id] = memberCount;
                    $(`tr[data-group-id="${group.id}"] .member-count`)
                        .attr('data-member-count', memberCount)
                        .html(`${memberCount} 人`);
                }).fail(() => {
                    groupsMemberCounts[group.id] = 0;
                    $(`tr[data-group-id="${group.id}"] .member-count`)
                        .attr('data-member-count', 0)
                        .html('0 人');
                });
            });
            
            console.log('Groups loaded with member counts');
        }
        
        // 群組排序功能
        function sortGroups(column) {
            // 重置所有排序圖標
            $('#sort-name-icon').removeClass('bi-sort-alpha-down bi-sort-alpha-up').addClass('bi-arrow-down-up text-muted');
            $('#sort-members-icon').removeClass('bi-sort-numeric-down bi-sort-numeric-up').addClass('bi-arrow-down-up text-muted');
            
            // 如果點擊同一欄,切換排序方向
            if (groupsSortColumn === column) {
                groupsSortDirection = groupsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                groupsSortColumn = column;
                groupsSortDirection = 'asc';
            }
            
            // 獲取所有行並轉換為陣列
            const tbody = $('#groups-table tbody');
            const rows = tbody.find('tr').toArray();
            
            // 排序
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'name') {
                    aVal = $(a).data('group-name') || '';
                    bVal = $(b).data('group-name') || '';
                    
                    // 字串比較
                    const result = aVal.localeCompare(bVal, 'zh-TW');
                    return groupsSortDirection === 'asc' ? result : -result;
                    
                } else if (column === 'members') {
                    aVal = parseInt($(a).find('.member-count').data('member-count')) || 0;
                    bVal = parseInt($(b).find('.member-count').data('member-count')) || 0;
                    
                    // 數字比較
                    const result = aVal - bVal;
                    return groupsSortDirection === 'asc' ? result : -result;
                }
                
                return 0;
            });
            
            // 更新排序圖標
            if (column === 'name') {
                $('#sort-name-icon')
                    .removeClass('bi-arrow-down-up text-muted')
                    .addClass(groupsSortDirection === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up')
                    .removeClass('text-muted')
                    .addClass('text-primary');
            } else if (column === 'members') {
                $('#sort-members-icon')
                    .removeClass('bi-arrow-down-up text-muted')
                    .addClass(groupsSortDirection === 'asc' ? 'bi-sort-numeric-down' : 'bi-sort-numeric-up')
                    .removeClass('text-muted')
                    .addClass('text-primary');
            }
            
            // 重新插入排序後的行
            tbody.empty();
            rows.forEach(row => tbody.append(row));
            
            console.log(`Groups sorted by ${column} (${groupsSortDirection})`);
        }

        // 編輯群組人員彈出
        $(document).on('click', '.edit-group-members-btn', function() {
            currentGroupId = $(this).data('id');
            currentGroupName = $(this).data('name') || '群組';
            $('#group-members-title').text(`編輯 ${currentGroupName} 群組人員`);
            $('#group-edit-id').val(currentGroupId);
            
            // 顯示載入中訊息
            const memberList = $('#member-list');
            memberList.html('<p class="text-muted"><span class="spinner-border spinner-border-sm" role="status"></span> 載入人員清單中...</p>');
            
            // 先確保載入所有人員,再載入群組成員
            $.get('/api/users').done(users => {
                allUsers = users;  // 更新全域人員清單
                loadGroupMembers();  // 載入群組成員
            }).fail(() => {
                memberList.html('<p class="text-danger">載入人員清單失敗</p>');
            });
            
            $('#group-members-modal').modal('show');
        });

        function loadGroupMembers() {
            // 載入當前群組成員
            $.get(`/api/groups/${currentGroupId}/users`).done(members => {
                currentGroupMembers = members.map(m => m.id);
                // 清空並用 jQuery 生成 checkbox 清單
                const memberList = $('#member-list');
                memberList.empty();
                
                if (allUsers.length === 0) {
                    memberList.html('<p class="text-muted">無人員,請先新增人員。</p>');
                    return;
                }
                
                // 按 ID 排序人員清單
                allUsers.sort((a, b) => a.id - b.id);
                
                allUsers.forEach(user => {
                    const isMember = currentGroupMembers.includes(user.id);
                    const checked = isMember ? 'checked' : '';
                    memberList.append(`
                        <div class="form-check">
                            <input class="form-check-input group-member-checkbox" type="checkbox" value="${user.id}" id="user-${user.id}" ${checked}>
                            <label class="form-check-label" for="user-${user.id}">
                                <i class="bi bi-person-fill text-primary"></i> ${user.name} <span class="text-muted">(${user.email})</span>
                            </label>
                        </div>
                    `);
                });
                console.log('Group members loaded:', currentGroupMembers, 'Total users:', allUsers.length);
            }).fail((xhr) => {
                console.error('Load group members fail:', xhr.responseText);
                const memberList = $('#member-list');
                memberList.html('<p class="text-danger">載入群組成員失敗</p>');
            });
        }

        // 儲存群組人員 (用 Promise.all)
        function saveGroupMembers() {
            const selectedIds = [];
            $('.group-member-checkbox:checked').each(function() {
                selectedIds.push(parseInt($(this).val()));
            });
            if (selectedIds.length === 0 && currentGroupMembers.length === 0) {
                alert('至少選擇一人或取消');
                return;
            }
            console.log('Saving group members for ID ' + currentGroupId + ':', selectedIds);

            const toAdd = selectedIds.filter(id => !currentGroupMembers.includes(id));
            const toRemove = currentGroupMembers.filter(id => !selectedIds.includes(id));

            const promises = [];

            // 新增請求
            toAdd.forEach(userId => {
                const promise = $.ajax({
                    url: `/api/groups/${currentGroupId}/users`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ user_id: userId })
                });
                promises.push(promise);
            });

            // 移除請求
            toRemove.forEach(userId => {
                const promise = $.ajax({
                    url: `/api/groups/${currentGroupId}/users`,
                    method: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify({ user_id: userId })
                });
                promises.push(promise);
            });

            if (promises.length === 0) {
                $('#group-members-modal').modal('hide');
                loadData('groups');
                alert('無變更');
                return;
            }

            // 用 Promise.all 處理
            Promise.all(promises).then((results) => {
                console.log('All requests success:', results);
                currentGroupMembers = selectedIds;
                $('#group-members-modal').modal('hide');
                loadData('groups');
                alert('群組人員更新成功!');
            }).catch((error) => {
                console.error('Save group members fail:', error);
                if (error.xhr) {
                    console.error('XHR status:', error.xhr.status, 'Response:', error.xhr.responseText);
                }
                alert('更新失敗: ' + (error.message || '請檢查 Console'));
            });
        }
        
        // 全選群組人員
        function selectAllGroupMembers() {
            $('.group-member-checkbox').prop('checked', true);
            console.log('All group members selected');
        }
        
        // 取消全選群組人員
        function deselectAllGroupMembers() {
            $('.group-member-checkbox').prop('checked', false);
            console.log('All group members deselected');
        }

        function loadPermissions(data) {
            const tbody = $('#perms-table tbody');
            tbody.empty();
            if (!data || data.length === 0) {
                tbody.html('<tr><td colspan="4" class="text-muted text-center">無權限</td></tr>');
                loadDropdowns();
                return;
            }
            
            // 先按 ID 排序,確保順序穩定
            data.sort((a, b) => a.id - b.id);
            
            data.forEach(p => {
                const folderName = p.path || `資料夾 ${p.folder_id}`;
                let target = 'N/A';
                if (p.user_name) {
                    target = `人員: ${p.user_name}`;
                } else if (p.group_name) {
                    target = `群組: ${p.group_name}`;
                }
                const permissionText = p.permission_type === 'read' ? '讀取' : 
                                      p.permission_type === 'write' ? '寫入' : p.permission_type;
                const tr = $(`<tr><td>${folderName}</td><td>${target}</td><td>${permissionText}</td><td><button class="btn btn-sm btn-danger del-btn" data-id="${p.id}" data-type="permission">刪除</button></td></tr>`);
                tbody.append(tr);
            });
            loadDropdowns();
        }

        function loadDropdowns() {
            // 載入資料夾下拉選單
            $.get('/api/folders').done(fdata => {
                $('#folder-select').html('<option value="">請選擇資料夾</option>');
                fdata.forEach(f => $('#folder-select').append(`<option value="${f.id}">${f.path || f.name}</option>`));
            });
            
            // 載入人員複選框清單
            $.get('/api/users').done(udata => {
                const container = $('#users-checkbox-list');
                container.empty();
                
                if (udata.length === 0) {
                    container.html('<p class="text-muted mb-0">無人員資料</p>');
                    return;
                }
                
                udata.forEach(u => {
                    container.append(`
                        <div class="form-check mb-2">
                            <input class="form-check-input user-checkbox" type="checkbox" value="${u.id}" id="user-${u.id}">
                            <label class="form-check-label" for="user-${u.id}">
                                <i class="bi bi-person-fill text-primary"></i> ${u.name}
                            </label>
                        </div>
                    `);
                });
            });
            
            // 載入群組複選框清單
            $.get('/api/groups').done(gdata => {
                const container = $('#groups-checkbox-list');
                container.empty();
                
                if (gdata.length === 0) {
                    container.html('<p class="text-muted mb-0">無群組資料</p>');
                    return;
                }
                
                gdata.forEach(g => {
                    container.append(`
                        <div class="form-check mb-2">
                            <input class="form-check-input group-checkbox" type="checkbox" value="${g.id}" id="group-${g.id}">
                            <label class="form-check-label" for="group-${g.id}">
                                <i class="bi bi-people-fill text-success"></i> ${g.name}
                            </label>
                        </div>
                    `);
                });
            });
        }
        
        // 全選/取消全選人員
        function toggleAllUsers(checked) {
            $('.user-checkbox').prop('checked', checked);
        }
        
        // 全選/取消全選群組
        function toggleAllGroups(checked) {
            $('.group-checkbox').prop('checked', checked);
        }

        // 批次權限指派(支援人員和群組)
        function addPermissions() {
            // 1. 驗證資料夾
            const folderVal = $('#folder-select').val();
            const folder_id = parseInt(folderVal, 10);
            if (!folderVal || isNaN(folder_id) || folder_id <= 0) {
                alert('❌ 請先選擇資料夾!');
                return;
            }
            
            // 2. 獲取選中的人員
            const selectedUsers = [];
            $('.user-checkbox:checked').each(function() {
                selectedUsers.push(parseInt($(this).val()));
            });
            
            // 3. 獲取選中的群組
            const selectedGroups = [];
            $('.group-checkbox:checked').each(function() {
                selectedGroups.push(parseInt($(this).val()));
            });
            
            // 4. 驗證至少選擇一個對象
            if (selectedUsers.length === 0 && selectedGroups.length === 0) {
                alert('❌ 請至少選擇一個人員或群組!');
                return;
            }
            
            // 5. 獲取權限類型
            const permission_type = $('#perm-type').val();
            if (!permission_type) {
                alert('❌ 請選擇權限類型!');
                return;
            }
            
            // 6. 建立批次請求清單
            const requests = [];
            
            // 為每個選中的人員建立請求
            selectedUsers.forEach(user_id => {
                const data = { 
                    folder_id, 
                    user_id, 
                    group_id: null, 
                    permission_type 
                };
                requests.push(
                    $.ajax({
                        url: '/api/permissions',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data)
                    })
                );
            });
            
            // 為每個選中的群組建立請求
            selectedGroups.forEach(group_id => {
                const data = { 
                    folder_id, 
                    user_id: null, 
                    group_id, 
                    permission_type 
                };
                requests.push(
                    $.ajax({
                        url: '/api/permissions',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data)
                    })
                );
            });
            
            // 7. 執行批次請求
            const totalCount = selectedUsers.length + selectedGroups.length;
            console.log(`開始批次指派權限:${totalCount} 個對象`);
            
            Promise.all(requests)
                .then(() => {
                    alert(`✅ 成功!已為 ${selectedUsers.length} 個人員和 ${selectedGroups.length} 個群組指派權限`);
                    
                    // 清空選擇
                    $('.user-checkbox').prop('checked', false);
                    $('.group-checkbox').prop('checked', false);
                    
                    // 重新載入權限清單
                    loadData('permissions');
                })
                .catch(err => {
                    console.error('批次指派失敗:', err);
                    alert('❌ 部分權限指派失敗,請查看控制台了解詳情');
                    // 即使失敗也重新載入,顯示成功的部分
                    loadData('permissions');
                });
        }

        // 權限指派修復
        function addPermission() {
            const folderVal = $('#folder-select').val();
            const folder_id = parseInt(folderVal, 10);
            if (!folderVal || isNaN(folder_id) || folder_id <= 0) {
                alert('請先選擇資料夾!');
                return;
            }
            const userVal = $('#user-select').val();
            const user_id = userVal ? parseInt(userVal, 10) : null;
            const groupVal = $('#group-select').val();
            const group_id = groupVal ? parseInt(groupVal, 10) : null;
            const permission_type = $('#perm-type').val();
            if (!permission_type) {
                alert('請選擇權限類型!');
                return;
            }
            
            // 確保至少選擇了人員或群組其中之一
            if (!user_id && !group_id) {
                alert('請至少選擇一個人員或群組!');
                return;
            }
            
            const data = { folder_id, user_id, group_id, permission_type };
            console.log('Assigning permission:', data);
            $.ajax({
                url: '/api/permissions',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data)
            }).done(() => {
                loadData('permissions');
                $('#folder-select, #user-select, #group-select, #perm-type').val('');
                alert('權限指派成功!');
            }).fail((xhr) => {
                console.error('Permission assign fail:', xhr.responseText);
                alert('指派失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }

        // 匯出權限 CSV
        function exportCSV() { 
            window.location.href = '/export_csv'; 
        }
        
        // 匯出完整資料 CSV(一次性匯出所有資料)
        function exportFullCSV() {
            // 使用隱藏的 iframe 來下載,避免頁面跳轉
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = '/export_full_csv';
            document.body.appendChild(iframe);
            
            // 2秒後移除 iframe
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 2000);
            
            // 顯示成功提示
            alert('✅ 完整資料 CSV 準備中,請稍候...\n\n' +
                '📦 匯出內容:\n' +
                '• 資料夾結構(使用名稱和父資料夾名稱)\n' +
                '• 所有人員(姓名和 Email)\n' +
                '• 所有群組\n' +
                '• 群組成員關係(使用名稱)\n' +
                '• 所有權限(使用名稱)\n\n' +
                '💡 此 CSV 可直接匯入重建完整系統!');
        }
        
        // 匯出完整 Excel 報表
        function exportExcel() {
            // 使用隱藏的 iframe 來下載,避免頁面跳轉
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = '/export_excel';
            document.body.appendChild(iframe);
            
            // 2秒後移除 iframe
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 2000);
            
            // 顯示成功提示
            alert('✅ Excel 報表準備中,請稍候...\n\n檔案將自動開始下載');
        }

        function showImport() { showSection('import'); }

        // 進度條管理函數
        let importProgressInterval;

        function showImportProgress() {
            $('#import-progress-modal').modal('show');
            resetImportProgress();
        }

        function hideImportProgress() {
            $('#import-progress-modal').modal('hide');
            if (importProgressInterval) {
                clearInterval(importProgressInterval);
                importProgressInterval = null;
            }
        }

        function resetImportProgress() {
            $('#import-progress-bar').css('width', '0%').attr('aria-valuenow', 0);
            $('#progress-text').text('0%');
            $('#import-status').text('準備開始匯入...');

            // 重置所有步驟狀態
            $('.step-item').removeClass('processing completed error');
            $('.step-item i').attr('class', 'bi bi-circle');

            // 顯示spinner
            $('#import-spinner').show();
        }

        function updateImportProgress(percent, status, currentStep) {
            $('#import-progress-bar').css('width', percent + '%').attr('aria-valuenow', percent);
            $('#progress-text').text(percent + '%');
            $('#import-status').text(status);

            // 更新步驟狀態
            if (currentStep) {
                // 重置所有步驟
                $('.step-item').removeClass('processing completed error');
                $('.step-item i').attr('class', 'bi bi-circle');

                // 設置當前處理中的步驟
                const steps = ['folders', 'users', 'groups', 'group_members', 'permissions'];
                const currentIndex = steps.indexOf(currentStep);

                // 設置已完成的步驟
                for (let i = 0; i < currentIndex; i++) {
                    $(`.step-item[data-step="${steps[i]}"]`).addClass('completed');
                }

                // 設置當前處理中的步驟
                if (currentIndex >= 0) {
                    $(`.step-item[data-step="${steps[currentIndex]}"]`).addClass('processing');
                }
            }
        }

        function simulateImportProgress() {
            let progress = 0;
            const steps = [
                { percent: 10, status: '正在解析 CSV 檔案...', step: null },
                { percent: 20, status: '正在排序資料...', step: null },
                { percent: 30, status: '正在處理資料夾...', step: 'folders' },
                { percent: 45, status: '正在處理人員資料...', step: 'users' },
                { percent: 60, status: '正在處理群組...', step: 'groups' },
                { percent: 75, status: '正在處理群組成員...', step: 'group_members' },
                { percent: 85, status: '正在處理權限設定...', step: 'permissions' }
            ];

            let stepIndex = 0;

            importProgressInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    updateImportProgress(step.percent, step.status, step.step);
                    stepIndex++;
                } else {
                    // 停留在最後一個步驟,等待實際完成
                    updateImportProgress(85, '正在等待伺服器處理完成...', 'permissions');
                    // 不清除定時器,保持在這個狀態直到實際完成
                }
            }, 800); // 每800毫秒更新一次
        }

        function doImport() {
            const file = $('#import-form input[name="file"]')[0].files[0];
            if (!file) return alert('請選擇 CSV 檔案');

            // 顯示確認對話框
            const confirmMsg = `⚠️ 重要提醒:批次匯入 (全功能)

您即將匯入完整的系統資料,這將會:

📁 建立或更新資料夾結構
👥 建立或更新人員資料
👪 建立或更新群組
🔗 設定群組成員關係
🔐 設定資料夾權限

⚠️ 注意事項:
• 此操作會處理大量資料,可能需要一些時間
• 重複資料不會重複建立
• 建議先備份當前資料
• 匯入順序:資料夾 → 人員 → 群組 → 群組成員 → 權限

確定要繼續嗎?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // 顯示進度條模態框
            showImportProgress();
            simulateImportProgress();

            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/import_csv', type: 'POST', data: formData,
                processData: false, contentType: false
            }).done((data) => {
                // 停止模擬進度
                if (importProgressInterval) {
                    clearInterval(importProgressInterval);
                    importProgressInterval = null;
                }

                // 設置完成狀態
                updateImportProgress(100, '匯入完成!', null);
                $('#import-spinner').hide();

                // 設置所有步驟為完成
                $('.step-item').addClass('completed');

                // 延遲一下再顯示結果
                setTimeout(() => {
                    hideImportProgress();

                    const successMsg = `✅ 匯入成功!

📊 匯入統計:
• 資料夾:${data.stats?.folders || 0} 個
• 人員:${data.stats?.users || 0} 個
• 群組:${data.stats?.groups || 0} 個
• 群組成員:${data.stats?.group_members || 0} 個
• 權限:${data.stats?.permissions || 0} 個

💡 提示:
• 前往各管理頁面查看匯入結果
• 群組成員關係已建立完成`;

                    alert(successMsg);
                    // 清空檔案選擇
                    $('#import-form input[name="file"]').val('');
                    // 返回資料夾管理頁面
                    showSection('folders');
                }, 1500);

            }).fail((xhr) => {
                // 停止模擬進度
                if (importProgressInterval) {
                    clearInterval(importProgressInterval);
                    importProgressInterval = null;
                }

                // 設置錯誤狀態
                $('#import-status').text('匯入失敗!');
                $('#import-spinner').hide();

                // 設置當前步驟為錯誤
                $('.step-item.processing').addClass('error').removeClass('processing');

                hideImportProgress();

                console.error('Import error:', xhr);
                const errorMsg = xhr.responseJSON?.error || xhr.responseText || xhr.statusText;
                alert('❌ 匯入失敗: ' + errorMsg + '\n\n請檢查 CSV 檔案格式是否正確。');
            });
        }

        // 資料夾批次匯入相關函數
        function exportFoldersCSV() { 
            window.location.href = '/export_folders_csv'; 
        }
        
        // 自動生成群組並指派權限
        function autoGenerateGroups() {
            if (!confirm('此功能將為所有資料夾自動建立 _RO 和 _RW 群組,並指派對應的權限。\n\n確定要繼續嗎?')) {
                return;
            }
            
            console.log('開始自動生成群組...');
            
            // 先獲取所有資料夾
            $.get('/api/folders').done(function(folders) {
                if (!folders || folders.length === 0) {
                    alert('目前沒有資料夾,無法生成群組!');
                    return;
                }
                
                console.log('找到', folders.length, '個資料夾');
                
                // 顯示進度提示
                const progressMsg = `正在處理 ${folders.length} 個資料夾...\n\n⏳ 這可能需要一些時間,請稍候。\n\n即使出現超時錯誤,操作仍會在背景完成。`;
                alert(progressMsg);
                
                // 呼叫後端 API(增加超時時間到 5 分鐘)
                $.ajax({
                    url: '/api/auto-generate-groups',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ folders }),
                    timeout: 300000  // 5 分鐘超時
                }).done(function(response) {
                    console.log('自動生成完成:', response);
                    
                    const summary = `✅ 自動生成完成!\n\n` +
                        `已建立群組:${response.groupsCreated} 個\n` +
                        `已存在群組:${response.groupsExisted} 個\n` +
                        `權限已指派:${response.permissionsCreated} 個\n` +
                        `權限已存在:${response.permissionsExisted} 個\n\n` +
                        `總共處理:${response.foldersProcessed} 個資料夾`;
                    
                    alert(summary);
                    
                    // 重新載入群組和權限資料
                    if (currentSection === 'groups') {
                        loadData('groups');
                    } else if (currentSection === 'permissions') {
                        loadData('permissions');
                    }
                }).fail(function(xhr, textStatus, errorThrown) {
                    console.error('自動生成請求狀態:', textStatus, errorThrown);
                    
                    // 處理超時情況
                    if (textStatus === 'timeout' || xhr.status === 504) {
                        const timeoutMsg = `⚠️ 請求超時(這是正常的)\n\n` +
                            `由於資料夾數量較多,處理時間較長。\n\n` +
                            `✅ 操作仍在背景執行中,請稍候片刻。\n\n` +
                            `💡 建議:\n` +
                            `1. 等待 1-2 分鐘\n` +
                            `2. 前往「群組管理」查看是否已建立群組\n` +
                            `3. 前往「權限管理」查看是否已指派權限\n` +
                            `4. 如果尚未完成,請再等待一下`;
                        
                        alert(timeoutMsg);
                        
                        // 自動切換到群組管理頁面
                        setTimeout(function() {
                            if (confirm('是否要切換到「群組管理」頁面查看結果?')) {
                                showSection('groups');
                            }
                        }, 1000);
                    } else {
                        alert('❌ 自動生成失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
                    }
                });
            }).fail(function(xhr) {
                console.error('載入資料夾失敗:', xhr);
                alert('❌ 載入資料夾失敗,請稍後再試');
            });
        }

        function showFolderImport() { 
            $('#folder-import-section').slideDown(); 
        }

        function hideFolderImport() { 
            $('#folder-import-section').slideUp(); 
            $('#folder-import-form input[name="file"]').val('');
        }

        function showFolderImportHelp() {
            $('#folder-import-help-modal').modal('show');
        }

        function doFolderImport() {
            const file = $('#folder-import-form input[name="file"]')[0].files[0];
            if (!file) return alert('請選擇 CSV 檔案');
            
            const formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: '/import_csv', 
                type: 'POST', 
                data: formData,
                processData: false, 
                contentType: false
            }).done(() => { 
                alert('資料夾匯入成功!');
                // 清空檔案選擇
                $('#folder-import-form input[name="file"]').val('');
                // 隱藏匯入區域
                hideFolderImport();
                // 重新載入資料夾樹
                loadData('folders');
            }).fail((xhr) => {
                console.error('Folder import error:', xhr);
                alert('匯入失敗: ' + (xhr.responseText || xhr.statusText));
            });
        }

        function loadParents() {
            $.get('/api/folders').done(data => {
                $('#parent-select').html('<option value="">根目錄</option>');
                data.forEach(f => $('#parent-select').append(`<option value="${f.id}">${f.path || f.name}</option>`));
            });
        }

        // 人員批次匯入相關函數
        function exportUsersCSV() { 
            window.location.href = '/export_users_csv'; 
        }

        function showUserImport() { 
            $('#user-import-section').slideDown(); 
        }

        function hideUserImport() { 
            $('#user-import-section').slideUp(); 
            $('#user-import-form input[name="file"]').val('');
        }

        function showUserImportHelp() {
            $('#user-import-help-modal').modal('show');
        }

        function doUserImport() {
            const file = $('#user-import-form input[name="file"]')[0].files[0];
            if (!file) return alert('請選擇 CSV 檔案');
            
            const formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: '/import_csv', 
                type: 'POST', 
                data: formData,
                processData: false, 
                contentType: false
            }).done(() => { 
                alert('人員匯入成功!');
                // 清空檔案選擇
                $('#user-import-form input[name="file"]').val('');
                // 隱藏匯入區域
                hideUserImport();
                // 重新載入人員清單
                loadData('users');
            }).fail((xhr) => {
                console.error('User import error:', xhr);
                alert('匯入失敗: ' + (xhr.responseText || xhr.statusText));
            });
        }

        // 群組批次匯入相關函數
        function exportGroupsCSV() { 
            window.location.href = '/export_groups_csv'; 
        }

        function showGroupImport() { 
            $('#group-import-section').slideDown(); 
        }

        function hideGroupImport() { 
            $('#group-import-section').slideUp(); 
            $('#group-import-form input[name="file"]').val('');
        }

        function showGroupImportHelp() {
            $('#group-import-help-modal').modal('show');
        }

        function doGroupImport() {
            const file = $('#group-import-form input[name="file"]')[0].files[0];
            if (!file) return alert('請選擇 CSV 檔案');
            
            const formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: '/import_csv', 
                type: 'POST', 
                data: formData,
                processData: false, 
                contentType: false
            }).done((result) => { 
                const message = result && result.imported 
                    ? `✅ 群組匯入成功!\n\n已匯入 ${result.imported} 筆資料`
                    : '✅ 群組匯入成功!';
                alert(message);
                // 清空檔案選擇
                $('#group-import-form input[name="file"]').val('');
                // 隱藏匯入區域
                hideGroupImport();
                // 重新載入群組清單
                loadData('groups');
            }).fail((xhr) => {
                console.error('Group import error:', xhr);
                alert('❌ 匯入失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }

        // 清空所有資料相關函數
        function showClearAllModal() {
            $('#clear-confirm-input').val('');
            $('#clear-all-modal').modal('show');
        }

        function confirmClearAll() {
            const confirmCode = $('#clear-confirm-input').val().trim();
            
            if (confirmCode !== 'CLEAR_ALL_DATA') {
                alert('確認碼錯誤!請輸入正確的確認碼:CLEAR_ALL_DATA');
                return;
            }
            
            // 二次確認
            if (!confirm('最後確認:確定要清空所有資料嗎?此操作無法復原!')) {
                return;
            }
            
            // 執行清空
            $.ajax({
                url: '/api/clear_all',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ confirm: confirmCode })
            }).done(() => {
                alert('✅ 所有資料已成功清空!');
                $('#clear-all-modal').modal('hide');
                // 切換到資料夾頁面並重新載入（確保顯示空白狀態）
                showSection('folders');
            }).fail((xhr) => {
                console.error('Clear all error:', xhr);
                const errorMsg = xhr.responseJSON?.error ||
                                xhr.responseText ||
                                xhr.statusText ||
                                '未知錯誤';
                alert('❌ 清空失敗: ' + errorMsg);
            });
        }

        $(document).ready(function() {
            $('.nav-link[data-section]').on('click', function(e) {
                e.preventDefault();
                showSection($(this).data('section'));
            });
            $(document).on('click', '.add-btn', function() {
                const type = $(this).data('type') || currentSection;
                addItem(type);
            });
            $('#modal').on('hidden.bs.modal', function() {
                $(this).find('input:not([type="hidden"]), select').val('');
                $('#email-div, #parent-div').hide();
            });
            $('#group-members-modal').on('hidden.bs.modal', function() {
                $('#member-list').empty();
            });
            $('#clear-all-modal').on('hidden.bs.modal', function() {
                $('#clear-confirm-input').val('');
            });
            loadData('folders');
        });

        // ==================== 查詢功能函數 ====================
        
        
        // 過濾群組選擇列表
        function filterGroupSelect() {
            const searchText = $('#group-search-input').val().toLowerCase();
            const select = $('#query-group-select');
            const options = select.find('option');
            
            options.each(function() {
                const optionText = $(this).text().toLowerCase();
                const optionValue = $(this).val();
                
                // 保留空選項（請選擇...）
                if (optionValue === '') {
                    $(this).show();
                    return;
                }
                
                // 根據搜尋文字顯示或隱藏選項
                if (optionText.includes(searchText)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        // 過濾人員選擇列表
        function filterUserSelect() {
            const searchText = $('#user-search-input').val().toLowerCase();
            const select = $('#query-user-select');
            const options = select.find('option');
            
            options.each(function() {
                const optionText = $(this).text().toLowerCase();
                const optionValue = $(this).val();
                
                // 保留空選項（請選擇...）
                if (optionValue === '') {
                    $(this).show();
                    return;
                }
                
                // 根據搜尋文字顯示或隱藏選項
                if (optionText.includes(searchText)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
// 載入查詢頁面(載入群組和人員下拉選單)
        function loadQueryPage() {
            console.log('Loading query page...');
            
            // 載入群組下拉選單
            $.get('/api/groups').done(function(groups) {
                const groupSelect = $('#query-group-select');
                groupSelect.empty();
                groupSelect.append('<option value="">請選擇群組</option>');
                groups.sort((a, b) => a.id - b.id);
                groups.forEach(group => {
                    groupSelect.append(`<option value="${group.id}">${group.name} (ID: ${group.id})</option>`);
                });
                console.log('Groups loaded for query:', groups.length);
            }).fail(function(xhr) {
                console.error('Failed to load groups:', xhr);
                alert('載入群組清單失敗');
            });
            
            // 載入人員下拉選單
            $.get('/api/users').done(function(users) {
                const userSelect = $('#query-user-select');
                userSelect.empty();
                userSelect.append('<option value="">請選擇人員</option>');
                users.sort((a, b) => a.id - b.id);
                users.forEach(user => {
                    userSelect.append(`<option value="${user.id}">${user.name} (ID: ${user.id}, Email: ${user.email})</option>`);
                });
                console.log('Users loaded for query:', users.length);
            }).fail(function(xhr) {
                console.error('Failed to load users:', xhr);
                alert('載入人員清單失敗');
            });
            
            // 隱藏所有結果區域
            $('#group-members-result, #group-members-empty, #user-groups-result, #user-groups-empty').hide();
        }
        
        // 查詢群組成員
        function queryGroupMembers() {
            const groupId = $('#query-group-select').val();
            
            if (!groupId) {
                $('#group-members-result, #group-members-empty').hide();
                return;
            }
            
            console.log('Querying members for group:', groupId);
            
            // 獲取群組資訊
            $.get('/api/groups').done(function(groups) {
                const group = groups.find(g => g.id == groupId);
                if (!group) {
                    alert('找不到該群組');
                    return;
                }
                
                $('#result-group-name').text(group.name);
                
                // 獲取群組成員
                $.get(`/api/groups/${groupId}/users`).done(function(members) {
                    console.log('Group members:', members);
                    
                    if (members.length === 0) {
                        $('#group-members-result').hide();
                        $('#group-members-empty').show();
                        $('#result-group-count').text('0');
                    } else {
                        $('#group-members-empty').hide();
                        $('#result-group-count').text(members.length);
                        
                        // 填充成員表格
                        const tbody = $('#group-members-table-body');
                        tbody.empty();
                        
                        members.sort((a, b) => a.id - b.id);
                        members.forEach(member => {
                            tbody.append(`
                                <tr>
                                    <td>${member.id}</td>
                                    <td>${member.name}</td>
                                    <td>${member.email}</td>
                                </tr>
                            `);
                        });
                        
                        $('#group-members-result').show();
                    }
                }).fail(function(xhr) {
                    console.error('Failed to load group members:', xhr);
                    alert('載入群組成員失敗');
                });
            }).fail(function(xhr) {
                console.error('Failed to load groups:', xhr);
                alert('載入群組資訊失敗');
            });
        }
        
        // 查詢人員所屬群組
        function queryUserGroups() {
            const userId = $('#query-user-select').val();
            
            if (!userId) {
                $('#user-groups-result, #user-groups-empty').hide();
                return;
            }
            
            console.log('Querying groups for user:', userId);
            
            // 獲取人員資訊
            $.get('/api/users').done(function(users) {
                const user = users.find(u => u.id == userId);
                if (!user) {
                    alert('找不到該人員');
                    return;
                }
                
                $('#result-user-name').text(user.name);
                $('#result-user-email').text(user.email);
                
                // 獲取人員所屬群組
                $.get(`/api/users/${userId}/groups`).done(function(groups) {
                    console.log('User groups:', groups);
                    
                    if (groups.length === 0) {
                        $('#user-groups-result').hide();
                        $('#user-groups-empty').show();
                        $('#result-user-group-count').text('0');
                    } else {
                        $('#user-groups-empty').hide();
                        $('#result-user-group-count').text(groups.length);
                        
                        // 填充群組表格
                        const tbody = $('#user-groups-table-body');
                        tbody.empty();
                        
                        groups.sort((a, b) => a.id - b.id);
                        groups.forEach(group => {
                            tbody.append(`
                                <tr>
                                    <td>${group.id}</td>
                                    <td>${group.name}</td>
                                </tr>
                            `);
                        });
                        
                        $('#user-groups-result').show();
                    }
                }).fail(function(xhr) {
                    console.error('Failed to load user groups:', xhr);
                    alert('載入人員所屬群組失敗');
                });
            }).fail(function(xhr) {
                console.error('Failed to load users:', xhr);
                alert('載入人員資訊失敗');
            });
        }

        // ==================== 資料庫管理函數 ====================
        
        
        // 更新資料夾頁面的資料庫名稱
        function updateFoldersDbName() {
            $.get('/api/databases').done(function(response) {
                $('#folders-current-db-name').text(response.current);
            }).fail(function() {
                $('#folders-current-db-name').text('未知');
            });
        }
        
// 載入資料庫列表
        function loadDatabases() {
            $('#database-list-loading').show();
            $('#database-table').hide();
            
            $.get('/api/databases').done(function(response) {
                console.log('Databases loaded:', response);
                $('#current-db-name').text(response.current);
                $('#folders-current-db-name').text(response.current);
                
                // 顯示管理員專屬提示和按鈕
                if (response.isAdmin) {
                    $('#admin-db-notice').show();
                } else {
                    $('#admin-db-notice').hide();
                }
                
                // 所有使用者都可以新增資料庫
                $('#btn-create-database').show();
                
                const list = $('#database-list');
                list.empty();
                
                if (response.databases.length === 0) {
                    list.append('<tr><td colspan="5" class="text-center text-muted">無資料庫</td></tr>');
                } else {
                    response.databases.forEach(db => {
                        const sizeKB = (db.size / 1024).toFixed(2);
                        const modifiedDate = new Date(db.modified).toLocaleString('zh-TW');
                        const isCurrent = db.isCurrent;
                        const badge = isCurrent ? '<span class="badge bg-success">使用中</span>' : '';
                        const icon = isCurrent ? '<i class="bi bi-check-circle-fill text-success"></i>' : '';
                        
                        // 所有使用者都可以切換自己的資料庫
                        const switchBtn = isCurrent ? 
                            '<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> 使用中</span>' :
                            `<button class="btn btn-sm btn-primary" onclick="switchDatabase('${db.name}')"><i class="bi bi-arrow-right-circle"></i> 切換</button>`;
                        
                        const deleteBtn = isCurrent ? 
                            '<button class="btn btn-sm btn-danger" disabled title="無法刪除使用中的資料庫"><i class="bi bi-trash"></i></button>' :
                            `<button class="btn btn-sm btn-danger" onclick="deleteDatabase('${db.name}')"><i class="bi bi-trash"></i></button>`;
                        
                        const renameBtn = isCurrent ? 
                            '<button class="btn btn-sm btn-warning" disabled title="無法重新命名使用中的資料庫"><i class="bi bi-pencil"></i></button>' :
                            `<button class="btn btn-sm btn-warning" onclick="showRenameDatabaseModal('${db.name}')"><i class="bi bi-pencil"></i></button>`;
                        
                        const row = `
                            <tr ${isCurrent ? 'class="table-success"' : ''}>
                                <td class="text-center">${icon}</td>
                                <td><strong>${db.name}</strong> ${badge}</td>
                                <td>${sizeKB} KB</td>
                                <td>${modifiedDate}</td>
                                <td>
                                    ${switchBtn}
                                    <button class="btn btn-sm btn-info ms-1" onclick="showCopyDatabaseModal('${db.name}')"><i class="bi bi-files"></i> 複製</button>
                                    ${renameBtn}
                                    ${deleteBtn}
                                </td>
                            </tr>
                        `;
                        list.append(row);
                    });
                }
                
                $('#database-list-loading').hide();
                $('#database-table').show();
            }).fail(function(xhr) {
                console.error('Failed to load databases:', xhr);
                alert('載入資料庫列表失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
                $('#database-list-loading').hide();
            });
        }
        
        // 重新整理資料庫列表
        function refreshDatabaseList() {
            loadDatabases();
        }
        
        // 顯示新增資料庫模態框
        function showCreateDatabaseModal() {
            $('#new-db-name').val('');
            
            // 根據使用者角色顯示命名規則
            if (currentUser && currentUser.role !== 'admin') {
                const username = currentUser.username;
                const prefix = `user_${username}_`;
                $('#user-db-prefix').text(prefix);
                $('#user-db-example').text(`${prefix}project1.db 或 ${prefix}備份.db`);
                $('#user-db-naming-notice').show();
            } else {
                $('#user-db-naming-notice').hide();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('create-database-modal'));
            modal.show();
        }
        
        // 建立新資料庫
        function createDatabase() {
            const name = $('#new-db-name').val().trim();
            if (!name) {
                alert('請輸入資料庫名稱');
                return;
            }
            
            $.ajax({
                url: '/api/databases',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name })
            }).done(function(response) {
                alert(response.message);
                $('#create-database-modal').modal('hide');
                loadDatabases();
            }).fail(function(xhr) {
                console.error('Failed to create database:', xhr);
                alert('建立失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }
        
        // 切換資料庫（管理員專用，基於 session）
        function switchDatabase(name) {
            if (!confirm(`確定要切換到資料庫「${name}」嗎?\n\n⚠️ 此切換僅影響您的 session，不會影響其他使用者。\n切換後，您將查看該資料庫的內容。`)) {
                return;
            }
            
            $.ajax({
                url: '/api/databases/switch',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name })
            }).done(function(response) {
                alert('✅ ' + response.message + ': ' + response.name + '\n\n' + (response.note || ''));
                loadDatabases();
                // 如果在其他頁面,重新載入該頁面資料
                if (currentSection !== 'databases') {
                    loadData(currentSection);
                }
            }).fail(function(xhr) {
                console.error('Failed to switch database:', xhr);
                const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || xhr.statusText;
                alert('❌ 切換失敗: ' + errorMsg);
            });
        }
        
        // 刪除資料庫
        function deleteDatabase(name) {
            if (!confirm(`⚠️ 警告:確定要刪除資料庫「${name}」嗎?\n\n此操作無法復原!資料庫檔案將被永久刪除。`)) {
                return;
            }
            
            // 二次確認
            if (!confirm('最後確認:真的要刪除嗎?此動作無法復原!')) {
                return;
            }
            
            $.ajax({
                url: '/api/databases',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ name })
            }).done(function(response) {
                alert(response.message);
                loadDatabases();
            }).fail(function(xhr) {
                console.error('Failed to delete database:', xhr);
                alert('刪除失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }
        
        // 顯示複製資料庫模態框
        function showCopyDatabaseModal(sourceName) {
            $('#copy-source-name').val(sourceName);
            $('#copy-source-display').text(sourceName);
            $('#copy-target-name').val('');
            const modal = new bootstrap.Modal(document.getElementById('copy-database-modal'));
            modal.show();
        }
        
        // 複製資料庫
        function copyDatabase() {
            const source = $('#copy-source-name').val();
            const target = $('#copy-target-name').val().trim();
            
            if (!target) {
                alert('請輸入新資料庫名稱');
                return;
            }
            
            $.ajax({
                url: '/api/databases/copy',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ source, target })
            }).done(function(response) {
                alert(response.message);
                $('#copy-database-modal').modal('hide');
                loadDatabases();
            }).fail(function(xhr) {
                console.error('Failed to copy database:', xhr);
                alert('複製失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }
        
        // 顯示重新命名資料庫模態框
        function showRenameDatabaseModal(oldName) {
            $('#rename-old-name').val(oldName);
            $('#rename-old-display').text(oldName);
            $('#rename-new-name').val('');
            const modal = new bootstrap.Modal(document.getElementById('rename-database-modal'));
            modal.show();
        }
        
        // 重新命名資料庫
        function renameDatabase() {
            const oldName = $('#rename-old-name').val();
            const newName = $('#rename-new-name').val().trim();
            
            if (!newName) {
                alert('請輸入新名稱');
                return;
            }
            
            $.ajax({
                url: '/api/databases/rename',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ oldName, newName })
            }).done(function(response) {
                alert(response.message);
                $('#rename-database-modal').modal('hide');
                loadDatabases();
            }).fail(function(xhr) {
                console.error('Failed to rename database:', xhr);
                alert('重新命名失敗: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText));
            });
        }

        // ==================== 帳號管理功能 ====================
        
        // 載入帳號管理頁面
        function loadAccountManagement() {
            loadPendingAccounts();
            loadAllAccounts();
        }
        
        // 載入待審核帳號
        function loadPendingAccounts() {
            $.ajax({
                url: '/api/admin/pending-accounts',
                method: 'GET',
                success: function(accounts) {
                    $('#pending-count-badge').text(accounts.length);
                    
                    if (accounts.length === 0) {
                        $('#pending-accounts-empty').show();
                        $('#pending-accounts-list').hide();
                    } else {
                        $('#pending-accounts-empty').hide();
                        $('#pending-accounts-list').show();
                        
                        let html = '';
                        accounts.forEach(function(account) {
                            const createdAt = new Date(account.created_at).toLocaleString('zh-TW');
                            html += `
                                <tr>
                                    <td>${account.id}</td>
                                    <td><strong>${account.username}</strong></td>
                                    <td>${account.full_name || '<span class="text-muted">未提供</span>'}</td>
                                    <td><small>${createdAt}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-success me-2" onclick="reviewAccount(${account.id}, 'approve', '${account.username}')">
                                            <i class="bi bi-check-circle"></i> 通過
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="reviewAccount(${account.id}, 'reject', '${account.username}')">
                                            <i class="bi bi-x-circle"></i> 拒絕
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        $('#pending-accounts-tbody').html(html);
                    }
                },
                error: function(xhr) {
                    console.error('Failed to load pending accounts:', xhr);
                    alert('載入待審核帳號失敗: ' + (xhr.responseJSON?.error || '請重試'));
                }
            });
        }
        
        // 載入所有帳號
        function loadAllAccounts() {
            $.ajax({
                url: '/api/admin/accounts',
                method: 'GET',
                success: function(accounts) {
                    $('#total-accounts-badge').text(accounts.length);
                    
                    let html = '';
                    accounts.forEach(function(account) {
                        const createdAt = new Date(account.created_at).toLocaleString('zh-TW');
                        let roleText = account.role === 'admin' ? '<span class="badge bg-danger">管理員</span>' : '<span class="badge bg-secondary">使用者</span>';
                        let statusText = '';
                        let statusClass = '';
                        
                        if (account.status === 'active') {
                            statusText = '啟用';
                            statusClass = 'bg-success';
                        } else if (account.status === 'pending') {
                            statusText = '待審核';
                            statusClass = 'bg-warning text-dark';
                        } else if (account.status === 'rejected') {
                            statusText = '已拒絕';
                            statusClass = 'bg-danger';
                        }
                        
                        let deleteButton = account.role !== 'admin' ? 
                            `<button class="btn btn-sm btn-danger" onclick="deleteAccount(${account.id}, '${account.username}')">
                                <i class="bi bi-trash"></i>
                            </button>` : 
                            '<span class="text-muted">-</span>';
                        
                        html += `
                            <tr>
                                <td>${account.id}</td>
                                <td><strong>${account.username}</strong></td>
                                <td>${account.full_name || '<span class="text-muted">未提供</span>'}</td>
                                <td>${roleText}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td><small><code>${account.user_database || '-'}</code></small></td>
                                <td><small>${createdAt}</small></td>
                                <td>${deleteButton}</td>
                            </tr>
                        `;
                    });
                    $('#all-accounts-tbody').html(html);
                },
                error: function(xhr) {
                    console.error('Failed to load all accounts:', xhr);
                    alert('載入帳號列表失敗: ' + (xhr.responseJSON?.error || '請重試'));
                }
            });
        }
        
        // 審核帳號（通過/拒絕）
        function reviewAccount(accountId, action, username) {
            const actionText = action === 'approve' ? '通過' : '拒絕';
            
            if (!confirm(`確定要${actionText}帳號 "${username}" 嗎？`)) {
                return;
            }
            
            $.ajax({
                url: '/api/admin/review-account',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    accountId: accountId,
                    action: action
                }),
                success: function(response) {
                    alert(`✅ ${response.message}`);
                    loadAccountManagement(); // 重新載入
                },
                error: function(xhr) {
                    console.error('Failed to review account:', xhr);
                    alert('審核失敗: ' + (xhr.responseJSON?.error || '請重試'));
                }
            });
        }
        
        // 刪除帳號
        function deleteAccount(accountId, username) {
            if (!confirm(`⚠️ 確定要刪除帳號 "${username}" 嗎？\n\n此操作將會：\n1. 刪除該帳號\n2. 備份並刪除該帳號的資料庫檔案\n\n此操作無法復原！`)) {
                return;
            }
            
            // 二次確認
            const confirmText = prompt(`請輸入使用者名稱 "${username}" 以確認刪除：`);
            if (confirmText !== username) {
                alert('❌ 使用者名稱不符，取消刪除');
                return;
            }
            
            $.ajax({
                url: `/api/admin/accounts/${accountId}`,
                method: 'DELETE',
                success: function(response) {
                    alert(`✅ ${response.message}`);
                    loadAccountManagement(); // 重新載入
                },
                error: function(xhr) {
                    console.error('Failed to delete account:', xhr);
                    alert('刪除失敗: ' + (xhr.responseJSON?.error || '請重試'));
                }
            });
        }
    </script>
</body>
</html>


