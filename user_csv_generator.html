<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå“¡ CSV ç”Ÿæˆå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .user-input-area {
            min-height: 200px;
            font-family: 'Courier New', monospace;
        }
        .method-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .method-card.active {
            border: 2px solid #0d6efd;
            background: #e7f1ff;
        }
        .example-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .preview-table {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-people"></i> äººå“¡ CSV ç”Ÿæˆå™¨
            </a>
            <a href="index.html" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left"></i> è¿”å›ä¸»ç³»çµ±
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>åŠŸèƒ½èªªæ˜ï¼š</strong>æ­¤å·¥å…·å¯å”åŠ©æ‚¨å¿«é€Ÿç”Ÿæˆäººå“¡åŒ¯å…¥ç”¨çš„ CSV æª”æ¡ˆã€‚è«‹é¸æ“‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼è¼¸å…¥äººå“¡è³‡æ–™ã€‚
                </div>
            </div>
        </div>

        <!-- Email æ¨¡å¼é¸æ“‡ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-envelope"></i> Email è™•ç†æ¨¡å¼</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="emailMode" id="emailModeAuto" value="auto" checked onchange="toggleEmailMode()">
                                    <label class="form-check-label" for="emailModeAuto">
                                        <strong>æ¨¡å¼ 1ï¼šè‡ªå‹•ç”Ÿæˆ Email</strong>
                                    </label>
                                </div>
                                <div class="ms-4 mt-2">
                                    <small class="text-muted">è¼¸å…¥åŸŸåï¼Œç³»çµ±è‡ªå‹•æ ¹æ“šå¸³è™Ÿç”Ÿæˆ Emailï¼ˆä¾‹ï¼šå¸³è™Ÿ@åŸŸå.comï¼‰</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="emailMode" id="emailModeManual" value="manual" onchange="toggleEmailMode()">
                                    <label class="form-check-label" for="emailModeManual">
                                        <strong>æ¨¡å¼ 2ï¼šæ‰‹å‹•è¼¸å…¥ Email</strong>
                                    </label>
                                </div>
                                <div class="ms-4 mt-2">
                                    <small class="text-muted">åˆ†åˆ¥è¼¸å…¥æˆ–å¾ Excel è²¼ä¸Šå¸³è™Ÿå’Œ Email</small>
                                </div>
                            </div>
                        </div>
                        <!-- æ¨¡å¼ 1ï¼šåŸŸåè¼¸å…¥ï¼ˆåƒ…åœ¨è‡ªå‹•ç”Ÿæˆæ¨¡å¼é¡¯ç¤ºï¼‰ -->
                        <div id="domain-input-section" class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Email åŸŸåï¼š</label>
                                    <input type="text" id="email-domain" class="form-control" placeholder="ä¾‹å¦‚ï¼šexample.com" value="">
                                    <small class="text-muted">ç³»çµ±æœƒè‡ªå‹•å°‡å¸³è™Ÿèˆ‡æ­¤åŸŸåçµ„åˆç”Ÿæˆ Email</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¼¸å…¥æ–¹æ³•é¸æ“‡ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card method-card active" data-method="paste">
                    <div class="card-body text-center">
                        <i class="bi bi-clipboard-check fs-1 text-primary"></i>
                        <h5 class="card-title mt-2">å¾ Excel è²¼ä¸Š</h5>
                        <p class="card-text small">å¾ Excel æˆ–è©¦ç®—è¡¨è¤‡è£½å¾Œç›´æ¥è²¼ä¸Š</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card method-card" data-method="manual">
                    <div class="card-body text-center">
                        <i class="bi bi-pencil-square fs-1 text-success"></i>
                        <h5 class="card-title mt-2">æ‰‹å‹•è¼¸å…¥</h5>
                        <p class="card-text small">ä½¿ç”¨è¡¨æ ¼é€ç­†è¼¸å…¥äººå“¡è³‡æ–™</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–¹æ³• 1: Excel è²¼ä¸Š -->
        <div id="method-paste" class="method-section">
            <div class="card">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> æ–¹æ³•ä¸€ï¼šå¾ Excel è²¼ä¸Š</h5>
                </div>
                <div class="card-body">
                    <div class="example-box">
                        <strong><i class="bi bi-lightbulb"></i> ä½¿ç”¨èªªæ˜ï¼š</strong>
                        <ol class="mb-0 mt-2" id="paste-instructions">
                            <li id="paste-instruction-auto" class="mode-auto">åœ¨ Excel ä¸­æº–å‚™äººå“¡è³‡æ–™ï¼ˆå…©æ¬„ï¼šå§“åã€å¸³è™Ÿï¼‰</li>
                            <li id="paste-instruction-manual" class="mode-manual" style="display:none;">åœ¨ Excel ä¸­æº–å‚™äººå“¡è³‡æ–™ï¼ˆå…©æ¬„ï¼šå§“åã€Emailï¼‰</li>
                            <li>é¸å–åŒ…å«è³‡æ–™çš„ç¯„åœï¼ˆåŒ…å«æ¨™é¡Œè¡Œï¼‰</li>
                            <li>è¤‡è£½ï¼ˆCtrl+Cï¼‰</li>
                            <li>è²¼ä¸Šåˆ°ä¸‹æ–¹çš„è¼¸å…¥æ¡†</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Excel è³‡æ–™ï¼ˆè²¼ä¸Šï¼‰ï¼š</label>
                        <textarea id="excel-paste-area" class="form-control user-input-area" 
                            placeholder="è«‹å¾ Excel è¤‡è£½è³‡æ–™ä¸¦è²¼ä¸Šé€™è£¡...&#10;&#10;ç¯„ä¾‹æ ¼å¼ï¼ˆè‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼‰ï¼š&#10;å§“å	å¸³è™Ÿ&#10;å¼µä¸‰	zhang&#10;æå››	li&#10;ç‹äº”	wang"></textarea>
                        <div id="paste-placeholder-auto" class="text-muted small mt-2">
                            <strong>è‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼š</strong>åªéœ€è¼¸å…¥å§“åå’Œå¸³è™Ÿï¼ŒEmail æœƒæ ¹æ“šä¸Šæ–¹è¨­å®šçš„åŸŸåè‡ªå‹•ç”Ÿæˆ
                        </div>
                        <div id="paste-placeholder-manual" class="text-muted small mt-2" style="display:none;">
                            <strong>æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼š</strong>éœ€è¦è¼¸å…¥å§“åå’Œå®Œæ•´çš„ Email åœ°å€
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="parseExcelData()">
                        <i class="bi bi-arrow-right-circle"></i> è§£æè³‡æ–™
                    </button>
                    
                    <div id="paste-preview" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- æ–¹æ³• 2: æ‰‹å‹•è¼¸å…¥ -->
        <div id="method-manual" class="method-section" style="display:none;">
            <div class="card">
                <div class="card-header bg-success">
                    <h5 class="mb-0"><i class="bi bi-pencil-square"></i> æ–¹æ³•äºŒï¼šæ‰‹å‹•è¼¸å…¥</h5>
                </div>
                <div class="card-body">
                    <div class="example-box">
                        <strong><i class="bi bi-lightbulb"></i> ä½¿ç”¨èªªæ˜ï¼š</strong>
                        <p class="mb-0 mt-2">
                            ä½¿ç”¨è¡¨æ ¼é€ç­†è¼¸å…¥äººå“¡è³‡è¨Šã€‚å¯è¨­å®šå§“åå’Œ Emailã€‚
                            é»æ“Šã€Œæ–°å¢è¡Œã€å¯æ–°å¢æ›´å¤šäººå“¡ã€‚
                        </p>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="manual-table">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">#</th>
                                    <th>å§“å</th>
                                    <th id="email-header">å¸³è™Ÿ</th>
                                    <th width="100">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="manual-tbody">
                                <tr data-row-id="1">
                                    <td>1</td>
                                    <td><input type="text" class="form-control form-control-sm user-name-input" placeholder="ä¾‹ï¼šå¼µä¸‰"></td>
                                    <td id="email-cell-1">
                                        <input type="text" class="form-control form-control-sm user-account-input" placeholder="ä¾‹ï¼šzhang">
                                    </td>
                                    <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="manual-mode-hint" class="text-muted small mt-2">
                            <strong>è‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼š</strong>è¼¸å…¥å¸³è™Ÿï¼ŒEmail æœƒæ ¹æ“šä¸Šæ–¹è¨­å®šçš„åŸŸåè‡ªå‹•ç”Ÿæˆï¼ˆä¾‹ï¼šå¸³è™Ÿ@åŸŸå.comï¼‰
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="addRow()">
                        <i class="bi bi-plus-circle"></i> æ–°å¢è¡Œ
                    </button>
                    <button class="btn btn-success mt-2" onclick="parseManualData()">
                        <i class="bi bi-arrow-right-circle"></i> ç”¢ç”Ÿ CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- CSV é è¦½å’Œä¸‹è¼‰å€ -->
        <div class="card mt-4" id="csv-output-section" style="display:none;">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> CSV è¼¸å‡ºçµæœ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">CSV å…§å®¹é è¦½ï¼š</label>
                        <textarea id="csv-output" class="form-control" rows="12" readonly></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">çµ±è¨ˆè³‡è¨Šï¼š</label>
                        <div class="alert alert-info">
                            <div id="csv-stats"></div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-lg" onclick="directImport()">
                                <i class="bi bi-cloud-upload-fill"></i> ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
                            </button>
                            <button class="btn btn-success" onclick="downloadCSV()">
                                <i class="bi bi-download"></i> ä¸‹è¼‰ CSV æª”æ¡ˆ
                            </button>
                            <button class="btn btn-primary" onclick="copyToClipboard()">
                                <i class="bi bi-clipboard"></i> è¤‡è£½åˆ°å‰ªè²¼ç°¿
                            </button>
                            <button class="btn btn-secondary" onclick="reset()">
                                <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é–‹å§‹
                            </button>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle-fill"></i> 
                            <strong>ç›´æ¥åŒ¯å…¥èªªæ˜ï¼š</strong>
                            ã€Œç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±ã€æŒ‰éˆ•æœƒå°‡ç”Ÿæˆçš„äººå“¡è³‡æ–™ç›´æ¥å‚³é€åˆ°ä¸»ç³»çµ±ï¼Œç„¡éœ€ä¸‹è¼‰å’Œæ‰‹å‹•ä¸Šå‚³ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = [];

        // ç²å–ç•¶å‰ Email æ¨¡å¼
        function getEmailMode() {
            return $('input[name="emailMode"]:checked').val();
        }

        // åˆ‡æ› Email æ¨¡å¼
        function toggleEmailMode() {
            const mode = getEmailMode();
            const isAuto = mode === 'auto';
            
            // é¡¯ç¤º/éš±è—åŸŸåè¼¸å…¥æ¡†
            $('#domain-input-section').toggle(isAuto);
            
            // æ›´æ–° Excel è²¼ä¸Šå€åŸŸ
            if (isAuto) {
                $('#paste-instruction-auto').show();
                $('#paste-instruction-manual').hide();
                $('#paste-placeholder-auto').show();
                $('#paste-placeholder-manual').hide();
                $('#excel-paste-area').attr('placeholder', 
                    'è«‹å¾ Excel è¤‡è£½è³‡æ–™ä¸¦è²¼ä¸Šé€™è£¡...\n\nç¯„ä¾‹æ ¼å¼ï¼ˆè‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼‰ï¼š\nå§“å\tå¸³è™Ÿ\nå¼µä¸‰\tzhang\næå››\tli\nç‹äº”\twang');
            } else {
                $('#paste-instruction-auto').hide();
                $('#paste-instruction-manual').show();
                $('#paste-placeholder-auto').hide();
                $('#paste-placeholder-manual').show();
                $('#excel-paste-area').attr('placeholder', 
                    'è«‹å¾ Excel è¤‡è£½è³‡æ–™ä¸¦è²¼ä¸Šé€™è£¡...\n\nç¯„ä¾‹æ ¼å¼ï¼ˆæ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼‰ï¼š\nå§“å\tEmail\nå¼µä¸‰\tzhang@example.com\næå››\tli@example.com\nç‹äº”\twang@example.com');
            }
            
            // æ›´æ–°æ‰‹å‹•è¼¸å…¥è¡¨æ ¼
            updateManualTable();
        }

        // æ›´æ–°æ‰‹å‹•è¼¸å…¥è¡¨æ ¼
        function updateManualTable() {
            const mode = getEmailMode();
            const isAuto = mode === 'auto';
            
            // æ›´æ–°è¡¨é ­
            $('#email-header').text(isAuto ? 'å¸³è™Ÿ' : 'Email');
            
            // æ›´æ–°æ‰€æœ‰è¡Œçš„è¼¸å…¥æ¡†
            $('#manual-tbody tr').each(function() {
                const rowId = $(this).data('row-id');
                const cell = $(this).find('td').eq(2);
                
                if (isAuto) {
                    cell.html(`<input type="text" class="form-control form-control-sm user-account-input" placeholder="ä¾‹ï¼šzhang">`);
                } else {
                    cell.html(`<input type="email" class="form-control form-control-sm user-email-input" placeholder="ä¾‹ï¼šzhang@example.com">`);
                }
            });
            
            // æ›´æ–°æç¤ºæ–‡å­—
            if (isAuto) {
                $('#manual-mode-hint').html('<strong>è‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼š</strong>è¼¸å…¥å¸³è™Ÿï¼ŒEmail æœƒæ ¹æ“šä¸Šæ–¹è¨­å®šçš„åŸŸåè‡ªå‹•ç”Ÿæˆï¼ˆä¾‹ï¼šå¸³è™Ÿ@åŸŸå.comï¼‰');
            } else {
                $('#manual-mode-hint').html('<strong>æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼š</strong>è¼¸å…¥å®Œæ•´çš„ Email åœ°å€');
            }
        }

        // ç”Ÿæˆ Emailï¼ˆæ ¹æ“šæ¨¡å¼å’Œå¸³è™Ÿï¼‰
        function generateEmail(account) {
            const mode = getEmailMode();
            if (mode === 'auto') {
                const domain = $('#email-domain').val().trim();
                if (!domain) {
                    alert('âš ï¸ è«‹å…ˆè¼¸å…¥ Email åŸŸåï¼');
                    return '';
                }
                if (!account) {
                    return '';
                }
                // ç§»é™¤åŸŸåä¸­å¯èƒ½åŒ…å«çš„ @ ç¬¦è™Ÿ
                const cleanDomain = domain.replace(/^@+/, '');
                return `${account}@${cleanDomain}`;
            }
            return account; // æ‰‹å‹•æ¨¡å¼ç›´æ¥è¿”å›è¼¸å…¥çš„å€¼ï¼ˆå³ Emailï¼‰
        }

        // æ–¹æ³•é¸æ“‡åˆ‡æ›
        $(document).on('click', '.method-card', function() {
            const method = $(this).data('method');
            $('.method-card').removeClass('active');
            $(this).addClass('active');
            $('.method-section').hide();
            $(`#method-${method}`).show();
        });

        // æ–¹æ³• 1: è§£æ Excel è²¼ä¸Šè³‡æ–™
        function parseExcelData() {
            const input = $('#excel-paste-area').val().trim();
            if (!input) {
                alert('è«‹å…ˆè²¼ä¸Š Excel è³‡æ–™');
                return;
            }

            const mode = getEmailMode();
            const isAuto = mode === 'auto';
            
            // è‡ªå‹•ç”Ÿæˆæ¨¡å¼éœ€è¦æª¢æŸ¥åŸŸå
            if (isAuto) {
                const domain = $('#email-domain').val().trim();
                if (!domain) {
                    alert('âš ï¸ è«‹å…ˆè¼¸å…¥ Email åŸŸåï¼');
                    $('#email-domain').focus();
                    return;
                }
            }

            const lines = input.split('\n');
            parsedData = [];
            
            // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼‰
            let startIndex = 0;
            const firstLine = lines[0].toLowerCase().trim();
            if (firstLine.includes('å§“å') || firstLine.includes('name') || 
                firstLine.includes('email') || firstLine.includes('mail') ||
                firstLine.includes('å¸³è™Ÿ') || firstLine.includes('account')) {
                startIndex = 1;
            }

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // æ”¯æ´ Tab åˆ†éš”æˆ–ç©ºæ ¼åˆ†éš”
                const parts = line.split(/\t| {2,}/);
                const name = parts[0] ? parts[0].trim() : '';
                const accountOrEmail = parts[1] ? parts[1].trim() : '';

                if (name) {
                    let email = '';
                    if (isAuto) {
                        // è‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼šç¬¬äºŒæ¬„æ˜¯å¸³è™Ÿ
                        email = generateEmail(accountOrEmail);
                    } else {
                        // æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼šç¬¬äºŒæ¬„æ˜¯ Email
                        email = accountOrEmail;
                    }

                    parsedData.push({
                        name: name,
                        email: email || ''
                    });
                }
            }

            if (parsedData.length === 0) {
                alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼');
                return;
            }

            console.log('Parsed data:', parsedData);
            displayPreview($('#paste-preview'), parsedData);
            generateCSV();
        }

        // æ–¹æ³• 2: æ‰‹å‹•è¼¸å…¥
        function addRow() {
            const mode = getEmailMode();
            const isAuto = mode === 'auto';
            const rowCount = $('#manual-tbody tr').length + 1;
            
            const inputField = isAuto 
                ? `<input type="text" class="form-control form-control-sm user-account-input" placeholder="ä¾‹ï¼šzhang">`
                : `<input type="email" class="form-control form-control-sm user-email-input" placeholder="ä¾‹ï¼šzhang@example.com">`;
            
            const row = `
                <tr data-row-id="${rowCount}">
                    <td>${rowCount}</td>
                    <td><input type="text" class="form-control form-control-sm user-name-input" placeholder="ä¾‹ï¼šå§“å"></td>
                    <td>${inputField}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
            $('#manual-tbody').append(row);
        }

        function removeRow(btn) {
            if ($('#manual-tbody tr').length > 1) {
                $(btn).closest('tr').remove();
                // æ›´æ–°è¡Œè™Ÿ
                $('#manual-tbody tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                    $(this).attr('data-row-id', index + 1);
                });
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
            }
        }

        function parseManualData() {
            const mode = getEmailMode();
            const isAuto = mode === 'auto';
            
            // è‡ªå‹•ç”Ÿæˆæ¨¡å¼éœ€è¦æª¢æŸ¥åŸŸå
            if (isAuto) {
                const domain = $('#email-domain').val().trim();
                if (!domain) {
                    alert('âš ï¸ è«‹å…ˆè¼¸å…¥ Email åŸŸåï¼');
                    $('#email-domain').focus();
                    return;
                }
            }
            
            parsedData = [];
            
            $('#manual-tbody tr').each(function() {
                const name = $(this).find('.user-name-input').val().trim();
                let email = '';
                
                if (isAuto) {
                    // è‡ªå‹•ç”Ÿæˆæ¨¡å¼ï¼šè®€å–å¸³è™Ÿä¸¦ç”Ÿæˆ Email
                    const account = $(this).find('.user-account-input').val().trim();
                    email = generateEmail(account);
                } else {
                    // æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼šç›´æ¥è®€å– Email
                    email = $(this).find('.user-email-input').val().trim();
                }

                if (name) {
                    parsedData.push({
                        name: name,
                        email: email || ''
                    });
                }
            });

            if (parsedData.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹äººå“¡');
                return;
            }

            generateCSV();
        }

        // é¡¯ç¤ºé è¦½
        function displayPreview(container, data) {
            container.empty();
            
            if (data.length === 0) {
                container.html('<span class="text-muted">æ²’æœ‰è³‡æ–™</span>');
                return;
            }

            let html = '<table class="table table-sm table-bordered preview-table"><thead class="table-light"><tr><th>#</th><th>å§“å</th><th>Email</th></tr></thead><tbody>';
            
            data.forEach((item, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.email || '<span class="text-muted">ï¼ˆæœªå¡«å¯«ï¼‰</span>'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.html(html);
        }

        // ç”Ÿæˆ CSV
        function generateCSV() {
            if (!parsedData || parsedData.length === 0) {
                alert('æ²’æœ‰å¯ç”Ÿæˆçš„è³‡æ–™');
                return;
            }

            let csvContent = 'type,name,email\n';
            
            parsedData.forEach(item => {
                const name = item.name.includes(',') ? `"${item.name}"` : item.name;
                const email = item.email.includes(',') ? `"${item.email}"` : item.email;
                csvContent += `user,${name},${email}\n`;
            });

            $('#csv-output').val(csvContent);
            $('#csv-output-section').show();

            // é¡¯ç¤ºçµ±è¨ˆ
            const totalCount = parsedData.length;
            const withEmailCount = parsedData.filter(item => item.email).length;
            const withoutEmailCount = totalCount - withEmailCount;

            let stats = `
                <strong>ç¸½äººå“¡æ•¸ï¼š</strong> ${totalCount}<br>
                <strong>æœ‰ Emailï¼š</strong> ${withEmailCount}<br>
                <strong>ç„¡ Emailï¼š</strong> ${withoutEmailCount}
            `;

            if (withoutEmailCount > 0) {
                stats += `<br><div class="text-warning mt-2"><small>âš ï¸ æœ‰ ${withoutEmailCount} ä½äººå“¡æœªå¡«å¯« Email</small></div>`;
            } else {
                stats += `<br><div class="text-success mt-2"><small>âœ“ æ‰€æœ‰äººå“¡éƒ½æœ‰ Email</small></div>`;
            }

            $('#csv-stats').html(stats);

            // æ»¾å‹•åˆ°çµæœå€
            $('html, body').animate({
                scrollTop: $('#csv-output-section').offset().top - 20
            }, 500);
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            const content = document.getElementById('csv-output').value;
            if (!content) {
                alert('æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹');
                return;
            }

            // æ·»åŠ  UTF-8 BOM ä»¥ä¾¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users_' + new Date().toISOString().slice(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard() {
            const content = document.getElementById('csv-output').value;
            if (!content) {
                alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                alert('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        }

        // ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
        function directImport() {
            const content = document.getElementById('csv-output').value;
            
            if (!content || content.trim() === '') {
                alert('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„ CSV å…§å®¹ï¼');
                return;
            }
            
            // è¨ˆç®—äººå“¡æ•¸é‡
            const lines = content.trim().split('\n');
            const userCount = lines.length - 1; // æ‰£é™¤æ¨™é¡Œè¡Œ
            
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmMsg = `ç¢ºå®šè¦å°‡ç”Ÿæˆçš„äººå“¡è³‡æ–™ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±å—ï¼Ÿ\n\n` +
                `é€™å°‡æœƒå»ºç«‹ ${userCount} ä½äººå“¡ã€‚\n\n` +
                `æ“ä½œèªªæ˜ï¼š\n` +
                `1. æ­¤æ“ä½œæœƒå»ºç«‹æ–°çš„äººå“¡è³‡æ–™\n` +
                `2. ä¸æœƒé‡è¤‡å»ºç«‹å·²å­˜åœ¨çš„äººå“¡ï¼ˆæ ¹æ“š Emailï¼‰\n` +
                `3. å»ºè­°å…ˆç¢ºèªè³‡æ–™æ­£ç¢ºæ€§\n\n` +
                `æ˜¯å¦ç¹¼çºŒï¼Ÿ`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // æº–å‚™ FormData
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const formData = new FormData();
            formData.append('file', blob, 'users.csv');
            
            // é¡¯ç¤ºè™•ç†ä¸­è¨Šæ¯
            alert('â³ æ­£åœ¨åŒ¯å…¥ä¸­ï¼Œè«‹ç¨å€™...');
            
            // ç™¼é€åˆ°å¾Œç«¯
            fetch('/import_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('åŒ¯å…¥æˆåŠŸ:', data);
                
                // å¾Œç«¯è¿”å›çš„å­—æ®µæ˜¯ importedï¼ˆä¹Ÿæœ‰ count å‘å¾Œå…¼å®¹ï¼‰
                const importedCount = data.imported || data.count || 0;
                const stats = data.stats || {};
                
                // å»ºç«‹è©³ç´°çµ±è¨ˆè¨Šæ¯
                let statsMsg = '';
                if (stats.users !== undefined) {
                    statsMsg = `\nğŸ“Š è©³ç´°çµ±è¨ˆï¼š\näººå“¡: ${stats.users}\n`;
                }
                
                const successMsg = `âœ… åŒ¯å…¥æˆåŠŸï¼\n\n` +
                    `å·²åŒ¯å…¥ï¼š${importedCount} ç­†è³‡æ–™${statsMsg}\n` +
                    `ğŸ’¡ æç¤ºï¼š\n` +
                    `â€¢ å‰å¾€ã€Œäººå“¡ç®¡ç†ã€æŸ¥çœ‹äººå“¡åˆ—è¡¨\n` +
                    `â€¢ å¯åœ¨ã€Œç¾¤çµ„ç®¡ç†ã€ä¸­å°‡äººå“¡åŠ å…¥ç¾¤çµ„\n\n` +
                    `ğŸ“ èªªæ˜ï¼š\n` +
                    `â€¢ å¦‚æœäººå“¡å·²å­˜åœ¨ï¼ˆç›¸åŒ Emailï¼‰ï¼Œä¸æœƒé‡è¤‡å»ºç«‹\n` +
                    `â€¢ å¯¦éš›å»ºç«‹çš„äººå“¡æ•¸é‡å¯èƒ½å°‘æ–¼åŒ¯å…¥ç­†æ•¸`;
                
                alert(successMsg);
                
                // è©¢å•æ˜¯å¦è¦åˆ‡æ›åˆ°ä¸»ç³»çµ±
                if (confirm('æ˜¯å¦è¦é–‹å•Ÿä¸»ç³»çµ±æŸ¥çœ‹çµæœï¼Ÿ')) {
                    window.open('/index.html', '_blank');
                }
            })
            .catch(error => {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                
                const errorMsg = `âŒ åŒ¯å…¥å¤±æ•—ï¼\n\n` +
                    `éŒ¯èª¤è¨Šæ¯ï¼š${error.message}\n\n` +
                    `å¯èƒ½åŸå› ï¼š\n` +
                    `1. ä¸»ç³»çµ±æœªå•Ÿå‹•\n` +
                    `2. ç¶²è·¯é€£ç·šå•é¡Œ\n` +
                    `3. CSV æ ¼å¼éŒ¯èª¤\n\n` +
                    `å»ºè­°ï¼š\n` +
                    `â€¢ æª¢æŸ¥ä¸»ç³»çµ±æ˜¯å¦æ­£å¸¸é‹ä½œ\n` +
                    `â€¢ æˆ–ä½¿ç”¨ã€Œä¸‹è¼‰ CSV æª”æ¡ˆã€å¾Œæ‰‹å‹•åŒ¯å…¥`;
                
                alert(errorMsg);
            });
        }

        // é‡æ–°é–‹å§‹
        function reset() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
                parsedData = [];
                $('#excel-paste-area').val('');
                $('#paste-preview').empty();
                $('#email-domain').val('');
                $('#manual-tbody').html(`
                    <tr data-row-id="1">
                        <td>1</td>
                        <td><input type="text" class="form-control form-control-sm user-name-input" placeholder="ä¾‹ï¼šå¼µä¸‰"></td>
                        <td id="email-cell-1">
                            <input type="text" class="form-control form-control-sm user-account-input" placeholder="ä¾‹ï¼šzhang">
                        </td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `);
                $('#csv-output').val('');
                $('#csv-output-section').hide();
                $('#csv-stats').empty();
                // é‡æ–°æ›´æ–°è¡¨æ ¼ä»¥ç¬¦åˆç•¶å‰æ¨¡å¼
                updateManualTable();
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        $(document).ready(function() {
            toggleEmailMode();
        });
    </script>
</body>
</html>


