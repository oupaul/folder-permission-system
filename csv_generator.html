<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™å¤¾ CSV ç”Ÿæˆå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .tree-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        .tree-item {
            padding: 2px 0;
            cursor: pointer;
        }
        .tree-item:hover {
            background: #e9ecef;
        }
        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }
        .indent-3 { padding-left: 60px; }
        .indent-4 { padding-left: 80px; }
        .indent-5 { padding-left: 100px; }
        .folder-input-area {
            min-height: 200px;
            font-family: 'Courier New', monospace;
        }
        .method-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .method-card.active {
            border: 2px solid #0d6efd;
            background: #e7f1ff;
        }
        .example-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-file-earmark-spreadsheet"></i> è³‡æ–™å¤¾ CSV ç”Ÿæˆå™¨
            </a>
            <a href="index.html" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left"></i> è¿”å›ä¸»ç³»çµ±
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>åŠŸèƒ½èªªæ˜ï¼š</strong>æ­¤å·¥å…·å¯å”åŠ©æ‚¨å¿«é€Ÿç”Ÿæˆè³‡æ–™å¤¾åŒ¯å…¥ç”¨çš„ CSV æª”æ¡ˆã€‚è«‹é¸æ“‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼è¼¸å…¥è³‡æ–™å¤¾çµæ§‹ã€‚
                </div>
            </div>
        </div>

        <!-- è¼¸å…¥æ–¹æ³•é¸æ“‡ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card method-card active" data-method="paste">
                    <div class="card-body text-center">
                        <i class="bi bi-clipboard-check fs-1 text-primary"></i>
                        <h5 class="card-title mt-2">å¾ Excel è²¼ä¸Š</h5>
                        <p class="card-text small">å¾ Excel æˆ–è©¦ç®—è¡¨è¤‡è£½å¾Œç›´æ¥è²¼ä¸Š</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card method-card" data-method="tree">
                    <div class="card-body text-center">
                        <i class="bi bi-diagram-3 fs-1 text-success"></i>
                        <h5 class="card-title mt-2">éšå±¤å¼è¼¸å…¥</h5>
                        <p class="card-text small">ä½¿ç”¨ç¸®æ’è¡¨ç¤ºè³‡æ–™å¤¾éšå±¤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card method-card" data-method="visual">
                    <div class="card-body text-center">
                        <i class="bi bi-ui-checks fs-1 text-warning"></i>
                        <h5 class="card-title mt-2">è¦–è¦ºåŒ–ç·¨è¼¯</h5>
                        <p class="card-text small">ä½¿ç”¨è¡¨æ ¼ä»‹é¢é€ç­†è¼¸å…¥</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–¹æ³• 1: å¾ Excel è²¼ä¸Š -->
        <div id="method-paste" class="method-section">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> æ–¹æ³•ä¸€ï¼šå¾ Excel è²¼ä¸Š</h5>
                </div>
                <div class="card-body">
                    <div class="example-box">
                        <strong><i class="bi bi-lightbulb"></i> ä½¿ç”¨èªªæ˜ï¼ˆéšå±¤æ¬„ä½æ ¼å¼ï¼‰ï¼š</strong>
                        <ol class="mb-0 mt-2">
                            <li><strong>ç¬¬ä¸€æ¬„ (A)</strong>ï¼šç¬¬ä¸€éšè³‡æ–™å¤¾ï¼ˆæ ¹ç›®éŒ„ï¼‰</li>
                            <li><strong>ç¬¬äºŒæ¬„ (B)</strong>ï¼šç¬¬äºŒéšè³‡æ–™å¤¾ï¼ˆç¬¬ä¸€æ¬„çš„å­è³‡æ–™å¤¾ï¼‰</li>
                            <li><strong>ç¬¬ä¸‰æ¬„ (C)</strong>ï¼šç¬¬ä¸‰éšè³‡æ–™å¤¾ï¼ˆç¬¬äºŒæ¬„ã€ŒåŒä¸€è¡Œã€çš„å­è³‡æ–™å¤¾ï¼‰</li>
                            <li>é¸å–è³‡æ–™å¾Œè¤‡è£½ï¼ˆCtrl+Cï¼‰ï¼Œåœ¨ä¸‹æ–¹è²¼ä¸Šï¼ˆCtrl+Vï¼‰</li>
                            <li>ç³»çµ±æœƒè‡ªå‹•è§£æéšå±¤é—œä¿‚ä¸¦è½‰æ›ç‚º CSV æ ¼å¼</li>
                        </ol>
                        <div class="alert alert-success mt-2 mb-0">
                            <small>
                                <strong>ç¯„ä¾‹ Excel æ ¼å¼ï¼š</strong><br>
                                <table class="table table-sm table-bordered mb-0" style="background: white;">
                                    <tr>
                                        <td><code>Share</code></td>
                                        <td><code>è‘£äº‹é•·</code></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td><code>ç¸½ç¶“ç†</code></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td><code>ç®¡ç†éƒ¨</code></td>
                                        <td><code>è²¡å‹™</code></td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td><code>äººäº‹</code></td>
                                    </tr>
                                </table>
                                <strong>çµæœï¼š</strong>Share â†’ è‘£äº‹é•·ã€ç¸½ç¶“ç†ã€ç®¡ç†éƒ¨ â†’ (ç®¡ç†éƒ¨ä¸‹) è²¡å‹™ã€äººäº‹
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Excel è³‡æ–™è²¼ä¸Šå€ï¼š</label>
                            <textarea id="excel-paste-area" class="form-control folder-input-area" 
                                placeholder="è«‹å¾ Excel è¤‡è£½è³‡æ–™å¾Œè²¼ä¸Š...&#10;&#10;ç¯„ä¾‹æ ¼å¼ï¼ˆéšå±¤æ¬„ä½ï¼‰ï¼š&#10;Share	è‘£äº‹é•·	&#10;	ç¸½ç¶“ç†	&#10;	ç®¡ç†éƒ¨	è²¡å‹™&#10;		äººäº‹"></textarea>
                            <button class="btn btn-primary mt-2" onclick="parseExcelData()">
                                <i class="bi bi-arrow-right-circle"></i> è§£æè³‡æ–™
                            </button>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">é è¦½ï¼ˆæ¨¹ç‹€çµæ§‹ï¼‰ï¼š</label>
                            <div id="paste-preview" class="tree-preview">
                                <span class="text-muted">è§£æå¾Œçš„è³‡æ–™å¤¾çµæ§‹æœƒé¡¯ç¤ºåœ¨é€™è£¡...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–¹æ³• 2: éšå±¤å¼è¼¸å…¥ -->
        <div id="method-tree" class="method-section" style="display:none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> æ–¹æ³•äºŒï¼šéšå±¤å¼è¼¸å…¥</h5>
                </div>
                <div class="card-body">
                    <div class="example-box">
                        <strong><i class="bi bi-lightbulb"></i> ä½¿ç”¨èªªæ˜ï¼š</strong>
                        <ol class="mb-0 mt-2">
                            <li>ä½¿ç”¨ç¸®æ’ï¼ˆç©ºæ ¼æˆ–Tabï¼‰è¡¨ç¤ºè³‡æ–™å¤¾çš„å±¤ç´šé—œä¿‚</li>
                            <li>åŒå±¤ç´šçš„è³‡æ–™å¤¾ä½¿ç”¨ç›¸åŒçš„ç¸®æ’é‡</li>
                            <li>å­è³‡æ–™å¤¾æ¯”çˆ¶è³‡æ–™å¤¾å¤šä¸€å±¤ç¸®æ’ï¼ˆå»ºè­°ä½¿ç”¨ 2 æˆ– 4 å€‹ç©ºæ ¼ï¼‰</li>
                            <li>ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ç¸®æ’å–®ä½ä¸¦è¨ˆç®— parent_id</li>
                            <li><strong>é‡è¦ï¼š</strong>çˆ¶è³‡æ–™å¤¾å¿…é ˆå…ˆæ–¼å­è³‡æ–™å¤¾è¼¸å…¥</li>
                        </ol>
                        <div class="alert alert-warning mt-2 mb-0">
                            <small>
                                <strong>ç¯„ä¾‹ï¼š</strong><br>
                                <code>å…¬å¸</code> â† ç¬¬ä¸€å±¤ï¼ˆæ ¹è³‡æ–™å¤¾ï¼‰<br>
                                <code>&nbsp;&nbsp;ç®¡ç†éƒ¨</code> â† ç¬¬äºŒå±¤ï¼ˆç¸®æ’2æ ¼ï¼‰<br>
                                <code>&nbsp;&nbsp;&nbsp;&nbsp;è²¡å‹™çµ„</code> â† ç¬¬ä¸‰å±¤ï¼ˆç¸®æ’4æ ¼ï¼‰<br>
                                <code>&nbsp;&nbsp;&nbsp;&nbsp;äººäº‹çµ„</code> â† ç¬¬ä¸‰å±¤ï¼ˆç¸®æ’4æ ¼ï¼‰<br>
                                <code>&nbsp;&nbsp;æŠ€è¡“éƒ¨</code> â† ç¬¬äºŒå±¤ï¼ˆç¸®æ’2æ ¼ï¼‰
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">éšå±¤å¼è¼¸å…¥ï¼š</label>
                            <textarea id="tree-input-area" class="form-control folder-input-area" 
                                placeholder="è«‹ä½¿ç”¨ç¸®æ’è¼¸å…¥è³‡æ–™å¤¾çµæ§‹...&#10;&#10;ç¯„ä¾‹ï¼š&#10;ç¸½å…¬å¸&#10;  æ¥­å‹™éƒ¨&#10;    æ¥­å‹™ä¸€çµ„&#10;    æ¥­å‹™äºŒçµ„&#10;  è¡ŒéŠ·éƒ¨&#10;  ç ”ç™¼éƒ¨&#10;    å‰ç«¯çµ„&#10;    å¾Œç«¯çµ„"></textarea>
                            <button class="btn btn-success mt-2" onclick="parseTreeData()">
                                <i class="bi bi-arrow-right-circle"></i> è§£æè³‡æ–™
                            </button>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">é è¦½ï¼ˆæ¨¹ç‹€çµæ§‹ï¼‰ï¼š</label>
                            <div id="tree-preview" class="tree-preview">
                                <span class="text-muted">è§£æå¾Œçš„è³‡æ–™å¤¾çµæ§‹æœƒé¡¯ç¤ºåœ¨é€™è£¡...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–¹æ³• 3: è¦–è¦ºåŒ–ç·¨è¼¯ -->
        <div id="method-visual" class="method-section" style="display:none;">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-ui-checks"></i> æ–¹æ³•ä¸‰ï¼šè¦–è¦ºåŒ–ç·¨è¼¯</h5>
                </div>
                <div class="card-body">
                    <div class="example-box">
                        <strong><i class="bi bi-lightbulb"></i> ä½¿ç”¨èªªæ˜ï¼š</strong>
                        <p class="mb-0 mt-2">
                            ä½¿ç”¨è¡¨æ ¼é€ç­†è¼¸å…¥è³‡æ–™å¤¾è³‡è¨Šã€‚<strong>çˆ¶è³‡æ–™å¤¾å¯ä»¥å¾ä¸‹æ‹‰é¸å–®é¸æ“‡</strong>ï¼Œç„¡éœ€è¨˜æ†¶IDã€‚
                            é»æ“Šã€Œæ–°å¢è¡Œã€å¯æ–°å¢æ›´å¤šè³‡æ–™å¤¾ã€‚
                        </p>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="visual-table">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">#</th>
                                    <th>è³‡æ–™å¤¾åç¨±</th>
                                    <th width="250">çˆ¶è³‡æ–™å¤¾</th>
                                    <th width="100">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="visual-tbody">
                                <tr data-row-id="1">
                                    <td>1</td>
                                    <td><input type="text" class="form-control form-control-sm folder-name-input" placeholder="ä¾‹ï¼šç¸½å…¬å¸" onchange="updateParentSelects()"></td>
                                    <td>
                                        <select class="form-select form-select-sm parent-select">
                                            <option value="">ï¼ˆæ ¹ç›®éŒ„ï¼‰</option>
                                        </select>
                                    </td>
                                    <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="addRow()">
                        <i class="bi bi-plus-circle"></i> æ–°å¢è¡Œ
                    </button>
                    <button class="btn btn-warning mt-2" onclick="parseVisualData()">
                        <i class="bi bi-arrow-right-circle"></i> ç”¢ç”Ÿ CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- CSV é è¦½å’Œä¸‹è¼‰å€ -->
        <div class="card mt-4" id="csv-output-section" style="display:none;">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> CSV è¼¸å‡ºçµæœ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">CSV å…§å®¹é è¦½ï¼š</label>
                        <textarea id="csv-output" class="form-control" rows="12" readonly></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">çµ±è¨ˆè³‡è¨Šï¼š</label>
                        <div class="alert alert-info">
                            <div id="csv-stats"></div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-lg" onclick="directImport()">
                                <i class="bi bi-cloud-upload-fill"></i> ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
                            </button>
                            <button class="btn btn-success" onclick="downloadCSV()">
                                <i class="bi bi-download"></i> ä¸‹è¼‰ CSV æª”æ¡ˆ
                            </button>
                            <button class="btn btn-primary" onclick="copyToClipboard()">
                                <i class="bi bi-clipboard"></i> è¤‡è£½åˆ°å‰ªè²¼ç°¿
                            </button>
                            <button class="btn btn-secondary" onclick="reset()">
                                <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é–‹å§‹
                            </button>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle-fill"></i> 
                            <strong>ç›´æ¥åŒ¯å…¥èªªæ˜ï¼š</strong>
                            ã€Œç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±ã€æŒ‰éˆ•æœƒå°‡ç”Ÿæˆçš„è³‡æ–™å¤¾çµæ§‹ç›´æ¥å‚³é€åˆ°ä¸»ç³»çµ±ï¼Œç„¡éœ€ä¸‹è¼‰å’Œæ‰‹å‹•ä¸Šå‚³ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = [];

        // åˆ‡æ›è¼¸å…¥æ–¹æ³•
        $('.method-card').click(function() {
            $('.method-card').removeClass('active');
            $(this).addClass('active');
            const method = $(this).data('method');
            $('.method-section').hide();
            $('#method-' + method).show();
        });

        // æ–¹æ³• 1: è§£æ Excel è²¼ä¸Šçš„è³‡æ–™ï¼ˆéšå±¤æ¬„ä½æ ¼å¼ï¼‰
        function parseExcelData() {
            const input = $('#excel-paste-area').val().trim();
            if (!input) {
                alert('è«‹å…ˆè²¼ä¸Š Excel è³‡æ–™');
                return;
            }

            const lines = input.split('\n');
            parsedData = [];
            let idCounter = 1;
            
            // ç”¨æ–¼è¿½è¹¤æ¯ä¸€æ¬„çš„æœ€å¾Œä¸€å€‹è³‡æ–™å¤¾ ID
            const columnLastIds = [];

            lines.forEach(line => {
                const parts = line.split('\t'); // Excel ç”¨ Tab åˆ†éš”
                
                // éæ­·æ¯ä¸€æ¬„
                for (let colIndex = 0; colIndex < parts.length; colIndex++) {
                    const name = parts[colIndex] ? parts[colIndex].trim() : '';
                    
                    // è·³éç©ºç™½å„²å­˜æ ¼
                    if (!name) continue;
                    
                    // ç¢ºå®š parent_id
                    let parent_id = '';
                    
                    if (colIndex === 0) {
                        // ç¬¬ä¸€æ¬„ï¼ˆç¬¬ä¸€éšï¼‰ï¼šæ²’æœ‰çˆ¶è³‡æ–™å¤¾
                        parent_id = '';
                    } else {
                        // å…¶ä»–æ¬„ï¼šçˆ¶è³‡æ–™å¤¾æ˜¯å·¦é‚Šä¸€æ¬„çš„ã€ŒåŒä¸€è¡Œã€çš„è³‡æ–™å¤¾
                        // æ‰¾åˆ°å·¦é‚Šæ¬„ä½ï¼ˆcolIndex - 1ï¼‰åœ¨é€™ä¸€è¡Œçš„è³‡æ–™å¤¾åç¨±
                        const parentName = parts[colIndex - 1] ? parts[colIndex - 1].trim() : '';
                        
                        if (parentName) {
                            // æ‰¾åˆ°é€™å€‹çˆ¶è³‡æ–™å¤¾çš„ IDï¼ˆå¾ parsedData ä¸­æ‰¾ï¼‰
                            const parentFolder = parsedData.find(f => f.name === parentName);
                            if (parentFolder) {
                                parent_id = parentFolder.id;
                            }
                        } else {
                            // å¦‚æœå·¦é‚Šæ¬„ä½æ˜¯ç©ºçš„ï¼Œä½¿ç”¨è©²æ¬„çš„æœ€å¾Œä¸€å€‹è³‡æ–™å¤¾ä½œç‚ºçˆ¶è³‡æ–™å¤¾
                            if (columnLastIds[colIndex - 1]) {
                                parent_id = columnLastIds[colIndex - 1];
                            }
                        }
                    }
                    
                    // æ–°å¢è³‡æ–™å¤¾
                    const folderId = idCounter++;
                    parsedData.push({
                        id: folderId,
                        name: name,
                        parent_id: parent_id
                    });
                    
                    // æ›´æ–°è©²æ¬„çš„æœ€å¾Œä¸€å€‹ ID
                    columnLastIds[colIndex] = folderId;
                    
                    console.log(`Added: ${name} (ID: ${folderId}, Parent: ${parent_id || 'root'})`);
                }
            });

            if (parsedData.length === 0) {
                alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼');
                return;
            }

            console.log('Parsed data:', parsedData);
            displayTreePreview($('#paste-preview'), parsedData);
            generateCSV();
        }

        // æ–¹æ³• 2: è§£æéšå±¤å¼è¼¸å…¥
        function parseTreeData() {
            const input = $('#tree-input-area').val().trim();
            if (!input) {
                alert('è«‹å…ˆè¼¸å…¥è³‡æ–™å¤¾çµæ§‹');
                return;
            }

            const lines = input.split('\n');
            parsedData = [];
            const stack = []; // ç”¨æ–¼è¿½è¹¤ç•¶å‰è·¯å¾‘ï¼š[{level, dbId}]
            const idMap = new Map(); // æ˜ å°„ï¼šè‡¨æ™‚ID -> è³‡æ–™åº«ID

            // ç¬¬ä¸€æ¬¡æƒæï¼šç¢ºå®šç¸®æ’å–®ä½
            let minIndent = Infinity;
            lines.forEach(line => {
                if (!line.trim()) return;
                const indent = line.search(/\S/);
                if (indent > 0 && indent < minIndent) {
                    minIndent = indent;
                }
            });
            const indentUnit = minIndent === Infinity ? 2 : minIndent; // é è¨­ 2 å€‹ç©ºæ ¼

            console.log('Detected indent unit:', indentUnit);

            lines.forEach(line => {
                if (!line.trim()) return;

                // è¨ˆç®—ç¸®æ’å±¤ç´š
                const indent = line.search(/\S/);
                const name = line.trim();
                const level = Math.floor(indent / indentUnit);

                console.log(`Processing: "${name}", indent=${indent}, level=${level}`);

                // èª¿æ•´ stack åˆ°ç•¶å‰å±¤ç´š
                while (stack.length > level) {
                    stack.pop();
                }

                // å–å¾—çˆ¶è³‡æ–™å¤¾çš„è³‡æ–™åº« ID
                let parent_db_id = '';
                if (stack.length > 0) {
                    const parentInfo = stack[stack.length - 1];
                    parent_db_id = parentInfo.dbId;
                }

                // è¨ˆç®—è³‡æ–™åº« IDï¼ˆå¾1é–‹å§‹é€£çºŒç·¨è™Ÿï¼‰
                const db_id = parsedData.length + 1;

                const item = {
                    name: name,
                    parent_id: parent_db_id
                };

                parsedData.push(item);
                
                // å°‡ç•¶å‰é …ç›®æ¨å…¥ stack
                stack.push({
                    level: level,
                    dbId: db_id
                });

                console.log(`Added: "${name}", db_id=${db_id}, parent_id=${parent_db_id}`);
            });

            if (parsedData.length === 0) {
                alert('ç„¡æ³•è§£æè³‡æ–™');
                return;
            }

            // ç‚ºé è¦½æ·»åŠ  ID
            parsedData.forEach((item, index) => {
                item.id = index + 1;
            });

            displayTreePreview($('#tree-preview'), parsedData);
            generateCSV();
        }

        // æ–¹æ³• 3: è§£æè¦–è¦ºåŒ–è¡¨æ ¼
        function parseVisualData() {
            parsedData = [];
            const rowIdToDbId = {}; // è¡Œè™Ÿ -> è³‡æ–™åº«ID çš„æ˜ å°„
            let dbId = 1;

            // ç¬¬ä¸€æ¬¡éæ­·ï¼šæ”¶é›†æ‰€æœ‰è³‡æ–™å¤¾ä¸¦åˆ†é… dbId
            $('#visual-tbody tr').each(function() {
                const rowId = String($(this).data('row-id')); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²
                const name = $(this).find('.folder-name-input').val().trim();
                
                if (name) {
                    rowIdToDbId[rowId] = dbId++;
                }
            });

            console.log('rowIdToDbId æ˜ å°„:', rowIdToDbId);

            // ç¬¬äºŒæ¬¡éæ­·ï¼šå»ºç«‹è³‡æ–™çµæ§‹ä¸¦è¨ˆç®— parent_id
            $('#visual-tbody tr').each(function() {
                const rowId = String($(this).data('row-id')); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²
                const name = $(this).find('.folder-name-input').val().trim();
                const parentRowId = String($(this).find('.parent-select').val() || ''); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²

                if (name) {
                    let parent_id = '';
                    
                    // å¦‚æœé¸æ“‡äº†çˆ¶è³‡æ–™å¤¾ï¼Œè½‰æ›ç‚ºå°æ‡‰çš„ dbId
                    if (parentRowId && parentRowId !== '') {
                        parent_id = rowIdToDbId[parentRowId];
                        
                        // èª¿è©¦è¼¸å‡º
                        console.log(`è³‡æ–™å¤¾: ${name}, è¡Œè™Ÿ: ${rowId}, çˆ¶è¡Œè™Ÿ: ${parentRowId}, çˆ¶ID: ${parent_id}`);
                        
                        if (!parent_id) {
                            console.warn(`âš ï¸ è­¦å‘Š: "${name}" çš„çˆ¶è³‡æ–™å¤¾è¡Œè™Ÿ ${parentRowId} ç„¡æ³•æ‰¾åˆ°å°æ‡‰çš„ ID`);
                            parent_id = '';
                        }
                    }
                    
                    parsedData.push({
                        name: name,
                        parent_id: parent_id || '',
                        dbId: rowIdToDbId[rowId]
                    });
                }
            });

            if (parsedData.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹è³‡æ–™å¤¾');
                return;
            }

            console.log('è§£æçµæœ:', parsedData);

            // é¡¯ç¤ºæ¨¹ç‹€é è¦½
            displayTreePreview($('#tree-preview'), parsedData);
            
            generateCSV();
        }

        // é¡¯ç¤ºæ¨¹ç‹€é è¦½
        function displayTreePreview(container, data) {
            container.empty();
            
            // å»ºç«‹æ¨¹ç‹€çµæ§‹
            const buildTree = (parentId, level) => {
                const children = data.filter(item => {
                    if (parentId === '') {
                        return item.parent_id === '' || !item.parent_id;
                    }
                    return String(item.parent_id) === String(parentId);
                });

                children.forEach(item => {
                    const indent = '  '.repeat(level);
                    const icon = level === 0 ? 'ğŸ“' : 'ğŸ“‚';
                    const div = $(`<div class="tree-item indent-${level}">${indent}${icon} ${item.name} (ID: ${item.id})</div>`);
                    container.append(div);
                    buildTree(item.id, level + 1);
                });
            };

            buildTree('', 0);
        }

        // ä¾è³´æ’åºï¼šç¢ºä¿çˆ¶è³‡æ–™å¤¾åœ¨å­è³‡æ–™å¤¾ä¹‹å‰
        function sortByDependency(data) {
            if (!data || data.length === 0) return [];
            
            const sorted = [];
            const processed = new Set();
            
            // çµ±ä¸€ç²å–é …ç›®çš„å”¯ä¸€è­˜åˆ¥ç¬¦ï¼ˆæ”¯æ´ id æˆ– dbIdï¼‰
            function getItemId(item) {
                return item.dbId !== undefined ? item.dbId : (item.id !== undefined ? item.id : null);
            }
            
            // å»ºç«‹ ID æ˜ å°„ï¼ˆæ”¯æ´ id å’Œ dbIdï¼‰
            const idMap = {};
            data.forEach(item => {
                const itemId = getItemId(item);
                if (itemId !== null) {
                    idMap[itemId] = item;
                }
            });
            
            // éè¿´è™•ç†å‡½æ•¸
            function processItem(item) {
                const itemId = getItemId(item);
                if (itemId === null || processed.has(itemId)) {
                    return; // å·²è™•ç†éæˆ–ç„¡æ•ˆ
                }
                
                // å¦‚æœæœ‰çˆ¶è³‡æ–™å¤¾ï¼Œå…ˆè™•ç†çˆ¶è³‡æ–™å¤¾
                if (item.parent_id) {
                    const parentId = parseInt(item.parent_id);
                    if (!isNaN(parentId) && parentId > 0) {
                        const parent = idMap[parentId];
                        
                        if (parent && !processed.has(parentId)) {
                            processItem(parent);
                        }
                    }
                }
                
                // è™•ç†ç•¶å‰é …ç›®
                sorted.push(item);
                processed.add(itemId);
            }
            
            // è™•ç†æ‰€æœ‰é …ç›®
            data.forEach(item => {
                processItem(item);
            });
            
            return sorted;
        }
        
        // ç”Ÿæˆ CSVï¼ˆæ”¹ç”¨åç¨±æ˜ å°„ç¢ºä¿æ­£ç¢ºæ€§ï¼‰
        function generateCSV() {
            if (!parsedData || parsedData.length === 0) {
                alert('æ²’æœ‰å¯ç”Ÿæˆçš„è³‡æ–™');
                return;
            }
            
            let csvContent = 'type,name,parent_id\n';
            let warnings = [];
            
            // çµ±ä¸€ç²å–é …ç›®çš„å”¯ä¸€è­˜åˆ¥ç¬¦ï¼ˆæ”¯æ´ id æˆ– dbIdï¼‰
            function getItemId(item) {
                return item.dbId !== undefined ? item.dbId : (item.id !== undefined ? item.id : null);
            }
            
            // æ’åºï¼šç¢ºä¿çˆ¶è³‡æ–™å¤¾åœ¨å­è³‡æ–™å¤¾ä¹‹å‰
            const sortedData = sortByDependency(parsedData);
            
            // å»ºç«‹èˆŠ IDï¼ˆid æˆ– dbIdï¼‰åˆ°æ–° CSV é †åº ID çš„æ˜ å°„
            const oldIdToNewId = {};
            sortedData.forEach((item, index) => {
                const oldId = getItemId(item);
                if (oldId !== null) {
                    oldIdToNewId[oldId] = index + 1;
                }
            });
            
            console.log('æ’åºå¾Œçš„è³‡æ–™å¤¾é †åº:', sortedData.map(item => item.name));
            console.log('èˆŠ ID åˆ°æ–° ID çš„æ˜ å°„:', oldIdToNewId);
            
            sortedData.forEach((item, index) => {
                const name = item.name.includes(',') ? `"${item.name}"` : item.name;
                let parent_id = '';
                
                // è™•ç† parent_id
                if (item.parent_id) {
                    const parentOldId = parseInt(item.parent_id);
                    
                    // æª¢æŸ¥ parent_id æ˜¯å¦æœ‰æ•ˆ
                    if (!isNaN(parentOldId) && parentOldId > 0) {
                        // è½‰æ›ç‚ºæ–°çš„ CSV ID
                        const newParentId = oldIdToNewId[parentOldId];
                        
                        if (newParentId) {
                            // æª¢æŸ¥çˆ¶è³‡æ–™å¤¾æ˜¯å¦åœ¨ç•¶å‰è³‡æ–™å¤¾ä¹‹å‰
                            const parentIndex = sortedData.findIndex(d => {
                                const dId = getItemId(d);
                                return dId === parentOldId;
                            });
                            
                            if (parentIndex >= 0 && parentIndex < index) {
                                parent_id = newParentId;
                            } else {
                                warnings.push(`âš ï¸ "${item.name}" çš„çˆ¶è³‡æ–™å¤¾åœ¨å…¶å¾Œé¢ï¼Œå·²è¨­ç‚ºæ ¹è³‡æ–™å¤¾`);
                                parent_id = '';
                            }
                        } else {
                            warnings.push(`âš ï¸ "${item.name}" çš„ parent_id (${parentOldId}) æ‰¾ä¸åˆ°å°æ‡‰çš„è³‡æ–™å¤¾ï¼Œå·²è¨­ç‚ºæ ¹è³‡æ–™å¤¾`);
                            parent_id = '';
                        }
                    } else {
                        warnings.push(`âš ï¸ "${item.name}" çš„ parent_id "${item.parent_id}" ç„¡æ•ˆï¼Œå·²è¨­ç‚ºæ ¹è³‡æ–™å¤¾`);
                        parent_id = '';
                    }
                }
                
                csvContent += `folder,${name},${parent_id}\n`;
            });

            $('#csv-output').val(csvContent);
            $('#csv-output-section').show();

            // é¡¯ç¤ºçµ±è¨ˆå’Œè­¦å‘Š
            const rootCount = sortedData.filter(item => {
                if (!item.parent_id) return true;
                const parentIdNum = parseInt(item.parent_id);
                return isNaN(parentIdNum) || parentIdNum <= 0;
            }).length;
            
            let stats = `
                <strong>ç¸½è³‡æ–™å¤¾æ•¸ï¼š</strong> ${sortedData.length}<br>
                <strong>æ ¹è³‡æ–™å¤¾ï¼š</strong> ${rootCount}<br>
                <strong>å­è³‡æ–™å¤¾ï¼š</strong> ${sortedData.length - rootCount}<br>
                <div class="text-info mt-2"><small>ğŸ“‹ è³‡æ–™å¤¾å·²æŒ‰ä¾è³´é—œä¿‚æ’åºï¼ˆçˆ¶è³‡æ–™å¤¾åœ¨å‰ï¼‰</small></div>
            `;
            
            if (warnings.length > 0) {
                stats += `<br><div class="text-danger mt-2"><strong>è­¦å‘Šï¼š</strong><br>${warnings.join('<br>')}</div>`;
            } else {
                stats += `<br><div class="text-success mt-2">âœ“ æ‰€æœ‰ parent_id éƒ½æœ‰æ•ˆï¼</div>`;
            }
            
            $('#csv-stats').html(stats);

            // åœ¨æ§åˆ¶å°è¼¸å‡ºè©³ç´°è³‡è¨Šä¾›é™¤éŒ¯
            console.log('=== CSV Generation ===');
            console.log('åŸå§‹è³‡æ–™:', parsedData);
            console.log('æ’åºå¾Œè³‡æ–™:', sortedData);
            sortedData.forEach((item, index) => {
                const itemId = getItemId(item);
                console.log(`CSV Row ${index + 1}: "${item.name}" (ID: ${itemId}), parent_id: ${item.parent_id || '(root)'}`);
            });

            // æ»¾å‹•åˆ°çµæœå€
            $('html, body').animate({
                scrollTop: $('#csv-output-section').offset().top - 20
            }, 500);
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            const content = $('#csv-output').val();
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'folders_import.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼\n\nè«‹åˆ°ã€Œè³‡æ–™å¤¾ç®¡ç†ã€é é¢ä½¿ç”¨ã€Œæ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ã€åŠŸèƒ½ä¸Šå‚³æ­¤æª”æ¡ˆã€‚');
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard() {
            const content = $('#csv-output').val();
            navigator.clipboard.writeText(content).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                $('#csv-output').select();
                document.execCommand('copy');
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        // é‡æ–°é–‹å§‹
        function reset() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡æ–°é–‹å§‹ï¼Ÿ')) {
                $('#excel-paste-area').val('');
                $('#tree-input-area').val('');
                $('#paste-preview').html('<span class="text-muted">è§£æå¾Œçš„è³‡æ–™å¤¾çµæ§‹æœƒé¡¯ç¤ºåœ¨é€™è£¡...</span>');
                $('#tree-preview').html('<span class="text-muted">è§£æå¾Œçš„è³‡æ–™å¤¾çµæ§‹æœƒé¡¯ç¤ºåœ¨é€™è£¡...</span>');
                $('#csv-output').val('');
                $('#csv-output-section').hide();
                parsedData = [];
            }
        }

        // è¦–è¦ºåŒ–ç·¨è¼¯ï¼šæ–°å¢è¡Œ
        function addRow() {
            const rowCount = $('#visual-tbody tr').length + 1;
            const row = `
                <tr data-row-id="${rowCount}">
                    <td>${rowCount}</td>
                    <td><input type="text" class="form-control form-control-sm folder-name-input" placeholder="ä¾‹ï¼šè³‡æ–™å¤¾åç¨±" onchange="updateParentSelects()"></td>
                    <td>
                        <select class="form-select form-select-sm parent-select">
                            <option value="">ï¼ˆæ ¹ç›®éŒ„ï¼‰</option>
                        </select>
                    </td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
            $('#visual-tbody').append(row);
            updateParentSelects();
        }
        
        // æ›´æ–°æ‰€æœ‰çˆ¶è³‡æ–™å¤¾ä¸‹æ‹‰é¸å–®
        function updateParentSelects() {
            const allRows = $('#visual-tbody tr');
            const folders = [];
            
            // æ”¶é›†æ‰€æœ‰å·²è¼¸å…¥çš„è³‡æ–™å¤¾åç¨±
            allRows.each(function(index) {
                const rowId = String($(this).data('row-id') || (index + 1)); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²
                const folderName = $(this).find('.folder-name-input').val().trim();
                if (folderName) {
                    folders.push({
                        id: rowId,
                        name: folderName
                    });
                }
            });
            
            // æ›´æ–°æ¯ä¸€è¡Œçš„çˆ¶è³‡æ–™å¤¾ä¸‹æ‹‰é¸å–®
            allRows.each(function() {
                const currentRowId = String($(this).data('row-id')); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²
                const select = $(this).find('.parent-select');
                const currentValue = String(select.val() || ''); // ç¢ºä¿è½‰æ›ç‚ºå­—ä¸²
                
                // é‡å»ºé¸é …
                select.empty();
                select.append('<option value="">ï¼ˆæ ¹ç›®éŒ„ï¼‰</option>');
                
                // æ·»åŠ å…¶ä»–è³‡æ–™å¤¾é¸é …ï¼ˆæ’é™¤è‡ªå·±ï¼‰
                folders.forEach(folder => {
                    if (folder.id !== currentRowId) {
                        const selected = currentValue === folder.id ? 'selected' : '';
                        select.append(`<option value="${folder.id}" ${selected}>${folder.name} (è¡Œ ${folder.id})</option>`);
                    }
                });
            });
        }

        // è¦–è¦ºåŒ–ç·¨è¼¯ï¼šç§»é™¤è¡Œ
        function removeRow(btn) {
            if ($('#visual-tbody tr').length > 1) {
                $(btn).closest('tr').remove();
                // æ›´æ–°è¡Œè™Ÿ
                $('#visual-tbody tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                    $(this).attr('data-row-id', index + 1);
                });
                // æ›´æ–°çˆ¶è³‡æ–™å¤¾é¸å–®
                updateParentSelects();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
            }
        }
        
        // ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±
        function directImport() {
            const content = document.getElementById('csv-output').value;
            
            if (!content || content.trim() === '') {
                alert('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„ CSV å…§å®¹ï¼');
                return;
            }
            
            // è¨ˆç®—è³‡æ–™å¤¾æ•¸é‡
            const lines = content.trim().split('\n');
            const folderCount = lines.length - 1; // æ‰£é™¤æ¨™é¡Œè¡Œ
            
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmMsg = `ç¢ºå®šè¦å°‡ç”Ÿæˆçš„è³‡æ–™å¤¾çµæ§‹ç›´æ¥åŒ¯å…¥åˆ°ç³»çµ±å—ï¼Ÿ\n\n` +
                `é€™å°‡æœƒå»ºç«‹ ${folderCount} å€‹è³‡æ–™å¤¾ã€‚\n\n` +
                `æ“ä½œèªªæ˜ï¼š\n` +
                `1. æ­¤æ“ä½œæœƒå»ºç«‹æ–°çš„è³‡æ–™å¤¾çµæ§‹\n` +
                `2. ä¸æœƒé‡è¤‡å»ºç«‹å·²å­˜åœ¨çš„è³‡æ–™å¤¾\n` +
                `3. å»ºè­°å…ˆç¢ºèªè³‡æ–™æ­£ç¢ºæ€§\n\n` +
                `æ˜¯å¦ç¹¼çºŒï¼Ÿ`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // æº–å‚™ FormData
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const formData = new FormData();
            formData.append('file', blob, 'folders.csv');
            
            // é¡¯ç¤ºè™•ç†ä¸­è¨Šæ¯
            alert('â³ æ­£åœ¨åŒ¯å…¥ä¸­ï¼Œè«‹ç¨å€™...');
            
            // ç™¼é€åˆ°å¾Œç«¯
            fetch('/import_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('åŒ¯å…¥æˆåŠŸ:', data);
                
                // å¾Œç«¯è¿”å›çš„å­—æ®µæ˜¯ importedï¼ˆä¹Ÿæœ‰ count å‘å¾Œå…¼å®¹ï¼‰
                const importedCount = data.imported || data.count || 0;
                const stats = data.stats || {};
                
                // å»ºç«‹è©³ç´°çµ±è¨ˆè¨Šæ¯
                let statsMsg = '';
                if (stats.folders !== undefined) {
                    const parts = [];
                    if (stats.folders > 0) parts.push(`è³‡æ–™å¤¾: ${stats.folders}`);
                    if (stats.users > 0) parts.push(`äººå“¡: ${stats.users}`);
                    if (stats.groups > 0) parts.push(`ç¾¤çµ„: ${stats.groups}`);
                    if (stats.group_members > 0) parts.push(`ç¾¤çµ„æˆå“¡: ${stats.group_members}`);
                    if (stats.permissions > 0) parts.push(`æ¬Šé™: ${stats.permissions}`);
                    
                    if (parts.length > 0) {
                        statsMsg = `\nğŸ“Š è©³ç´°çµ±è¨ˆï¼š\n${parts.join('\n')}\n`;
                    }
                }
                
                const successMsg = `âœ… åŒ¯å…¥æˆåŠŸï¼\n\n` +
                    `å·²åŒ¯å…¥ï¼š${importedCount} ç­†è³‡æ–™${statsMsg}\n` +
                    `ğŸ’¡ æç¤ºï¼š\n` +
                    `â€¢ å‰å¾€ã€Œè³‡æ–™å¤¾ç®¡ç†ã€æŸ¥çœ‹éšå±¤æ¨¹\n` +
                    `â€¢ å¯ä½¿ç”¨ã€Œè‡ªå‹•ç”Ÿæˆç¾¤çµ„ã€ç‚ºè³‡æ–™å¤¾å»ºç«‹å°æ‡‰ç¾¤çµ„\n\n` +
                    `ğŸ“ èªªæ˜ï¼š\n` +
                    `â€¢ å¦‚æœè³‡æ–™å·²å­˜åœ¨ï¼Œä¸æœƒé‡è¤‡å»ºç«‹\n` +
                    `â€¢ å¯¦éš›å»ºç«‹çš„æ•¸é‡å¯èƒ½å°‘æ–¼åŒ¯å…¥ç­†æ•¸`;
                
                alert(successMsg);
                
                // è©¢å•æ˜¯å¦è¦åˆ‡æ›åˆ°ä¸»ç³»çµ±
                if (confirm('æ˜¯å¦è¦é–‹å•Ÿä¸»ç³»çµ±æŸ¥çœ‹çµæœï¼Ÿ')) {
                    window.open('/index.html', '_blank');
                }
            })
            .catch(error => {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                
                const errorMsg = `âŒ åŒ¯å…¥å¤±æ•—ï¼\n\n` +
                    `éŒ¯èª¤è¨Šæ¯ï¼š${error.message}\n\n` +
                    `å¯èƒ½åŸå› ï¼š\n` +
                    `1. ä¸»ç³»çµ±æœªå•Ÿå‹•\n` +
                    `2. ç¶²è·¯é€£ç·šå•é¡Œ\n` +
                    `3. CSV æ ¼å¼éŒ¯èª¤\n\n` +
                    `å»ºè­°ï¼š\n` +
                    `â€¢ æª¢æŸ¥ä¸»ç³»çµ±æ˜¯å¦æ­£å¸¸é‹ä½œ\n` +
                    `â€¢ æˆ–ä½¿ç”¨ã€Œä¸‹è¼‰ CSV æª”æ¡ˆã€å¾Œæ‰‹å‹•åŒ¯å…¥`;
                
                alert(errorMsg);
            });
        }
    </script>
</body>
</html>


